<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="Syst√®me de gestion de pointage et planning - CNIM BABCOCK MAROC">
    <title>D√©partement M√©thode - Gestion de Pointage et Planning | CNIM</title>
    
    <!-- Biblioth√®que jsPDF pour export PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Biblioth√®que SheetJS pour export Excel .xlsx -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            /* Couleurs principales - Design System */
            --primary-color: #0066cc;
            --primary-dark: #003d7a;
            --primary-light: #3399ff;
            --secondary-color: #27ae60;
            --secondary-dark: #229954;
            
            /* Backgrounds */
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            
            /* Textes - WCAG AA Conformance */
            --text-primary: #1a1a1a;      /* Ratio 16:1 sur blanc */
            --text-secondary: #4a5568;     /* Ratio 8:1 sur blanc */
            --text-muted: #718096;         /* Ratio 4.5:1 sur blanc */
            
            /* Bordures */
            --border-color: #dee2e6;
            --border-radius: 8px;
            
            /* Ombres */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.15);
            
            /* Espacements - Design System */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            
            /* Typographie */
            --font-size-xs: 12px;
            --font-size-sm: 14px;
            --font-size-md: 16px;
            --font-size-lg: 18px;
            --font-size-xl: 24px;
            
            /* Touch targets - Mobile-First */
            --touch-target: 48px;
            
            /* Header */
            --header-gradient-start: #667eea;
            --header-gradient-end: #2b3b6e;
        }

        [data-theme="dark"] {
            /* Mode sombre - maintient le contraste WCAG */
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #0f3460;
            --text-primary: #f7fafc;       /* Ratio 16:1 sur fond sombre */
            --text-secondary: #e2e8f0;     /* Ratio 8:1 sur fond sombre */
            --text-muted: #cbd5e0;         /* Ratio 4.5:1 sur fond sombre */
            --border-color: #2d3748;
            --header-gradient-start: #533483;
            --header-gradient-end: #4a148c;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.3);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ============================================ */
        /* ACCESSIBILIT√â - Navigation au clavier */
        /* ============================================ */
        
        *:focus {
            outline: 3px solid var(--primary-color);
            outline-offset: 2px;
        }
        
        .skip-to-content {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--primary-color);
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            z-index: 10000;
            border-radius: 0 0 4px 0;
            font-weight: 600;
        }
        
        .skip-to-content:focus {
            top: 0;
        }

        /* ============================================ */
        /* ANIMATIONS PROFESSIONNELLES */
        /* ============================================ */
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        @keyframes slideInLeft {
            from { 
                opacity: 0; 
                transform: translateX(-50px); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }

        @keyframes slideInRight {
            from { 
                opacity: 0; 
                transform: translateX(50px); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }

        @keyframes scaleIn {
            from { 
                opacity: 0; 
                transform: scale(0.9); 
            }
            to { 
                opacity: 1; 
                transform: scale(1); 
            }
        }

        @keyframes pulse {
            0%, 100% { 
                transform: scale(1); 
            }
            50% { 
                transform: scale(1.05); 
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes progressBar {
            from {
                width: 0%;
            }
            to {
                width: 100%;
            }
        }

        @keyframes glowPulse {
            0%, 100% {
                box-shadow: 0 0 5px rgba(0, 102, 204, 0.3);
            }
            50% {
                box-shadow: 0 0 20px rgba(0, 102, 204, 0.8);
            }
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
            animation: fadeIn 0.5s ease-out;
            position: relative;
            overflow-x: hidden;
        }

        /* ============================================ */
        /* √âCRAN DE CONNEXION */
        /* ============================================ */
        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #003d7a 0%, #0066cc 50%, #003d7a 100%);
            background-size: 200% 200%;
            animation: gradientShift 10s ease infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            overflow: hidden;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* Particules industrielles anim√©es */
        .login-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1;
        }

        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: floatParticle 15s infinite;
        }

        .particle:nth-child(1) { width: 80px; height: 80px; left: 10%; animation-delay: 0s; }
        .particle:nth-child(2) { width: 60px; height: 60px; left: 20%; animation-delay: 2s; }
        .particle:nth-child(3) { width: 100px; height: 100px; left: 30%; animation-delay: 4s; }
        .particle:nth-child(4) { width: 70px; height: 70px; left: 70%; animation-delay: 1s; }
        .particle:nth-child(5) { width: 90px; height: 90px; left: 80%; animation-delay: 3s; }

        @keyframes floatParticle {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.3; }
            90% { opacity: 0.3; }
            100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
        }

        /* Lignes industrielles */
        .login-grid {
            position: absolute;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridMove 20s linear infinite;
            z-index: 1;
        }

        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        [data-theme="dark"] #loginScreen {
            background: linear-gradient(135deg, #1a1a2e 0%, #2b3b6e 50%, #1a1a2e 100%);
            background-size: 200% 200%;
        }

        .login-container {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
            width: 90%;
            max-width: 500px;
            padding: 45px;
            animation: slideInUp 0.8s ease-out;
            position: relative;
            z-index: 2;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        [data-theme="dark"] .login-container {
            background: rgba(15, 52, 96, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(0, 102, 204, 0.3);
        }

        .login-header {
            text-align: center;
            margin-bottom: 35px;
            position: relative;
        }

        .login-logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
            animation: fadeInDown 1s ease-out;
        }

        @keyframes fadeInDown {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .login-logo {
            width: 180px;
            height: auto;
            filter: drop-shadow(0 5px 15px rgba(0, 102, 204, 0.3));
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .login-boiler-3d {
            width: 120px;
            height: 120px;
            perspective: 1000px;
            animation: rotate3D 20s linear infinite;
        }

        @keyframes rotate3D {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(360deg); }
        }

        .login-boiler-3d img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 10px 30px rgba(255, 152, 0, 0.4));
        }

        .login-department-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
            margin-bottom: 20px;
            animation: slideInRight 1s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(-50px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .login-department-badge::before {
            content: 'üîß';
            font-size: 16px;
        }

        .login-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .login-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input {
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .form-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
            outline: none;
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .password-container {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 18px;
            padding: 8px;
            transition: color 0.3s;
        }

        .password-toggle:hover {
            color: var(--primary-color);
        }

        .form-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .remember-me input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary-color);
        }

        .forgot-password {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
        }

        .forgot-password:hover {
            text-decoration: underline;
            color: var(--primary-dark);
        }

        .login-button {
            padding: 16px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 102, 204, 0.3);
        }

        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 102, 204, 0.4);
        }

        .login-button:active {
            transform: translateY(0);
        }

        .login-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .login-error {
            background: #fee;
            color: #c33;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            border: 1px solid #fcc;
            animation: shake 0.5s ease-out;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .login-footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Modal Mot de passe oubli√© */
        .forgot-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10001;
            align-items: center;
            justify-content: center;
        }

        .forgot-modal.show {
            display: flex;
        }

        .forgot-modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            animation: scaleIn 0.3s ease-out;
        }

        [data-theme="dark"] .forgot-modal-content {
            background: var(--bg-card);
        }

        .forgot-modal-header {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .forgot-modal-body {
            margin-bottom: 20px;
        }

        .forgot-modal-text {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .forgot-modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .forgot-modal-button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .forgot-modal-button.primary {
            background: var(--primary-color);
            color: white;
        }

        .forgot-modal-button.primary:hover {
            background: var(--primary-dark);
        }

        .forgot-modal-button.secondary {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .forgot-modal-button.secondary:hover {
            background: #ccc;
        }

        .forgot-success {
            background: #d4edda;
            color: #155724;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            border: 1px solid #c3e6cb;
            display: none;
        }

        .forgot-success.show {
            display: block;
        }

        /* Modal Changement de mot de passe */
        .change-password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10002;
            align-items: center;
            justify-content: center;
        }

        .change-password-modal.show {
            display: flex;
        }

        .change-password-content {
            background: white;
            border-radius: 16px;
            padding: 35px;
            width: 90%;
            max-width: 450px;
            animation: scaleIn 0.3s ease-out;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        [data-theme="dark"] .change-password-content {
            background: var(--bg-card);
        }

        .change-password-header {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .change-password-body {
            margin-bottom: 25px;
        }

        .change-password-info {
            background: #e3f2fd;
            color: #1565c0;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }

        [data-theme="dark"] .change-password-info {
            background: rgba(33, 150, 243, 0.15);
            color: #64b5f6;
        }

        .password-strength {
            margin-top: 8px;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
        }

        .password-strength-bar {
            height: 100%;
            transition: width 0.3s, background 0.3s;
            width: 0%;
        }

        .password-strength-bar.weak {
            width: 33%;
            background: #f44336;
        }

        .password-strength-bar.medium {
            width: 66%;
            background: #ff9800;
        }

        .password-strength-bar.strong {
            width: 100%;
            background: #4caf50;
        }

        .password-strength-text {
            font-size: 11px;
            margin-top: 4px;
            color: var(--text-muted);
        }

        #appContent {
            display: none;
        }

        #appContent.show {
            display: block;
        }

        /* ============================================ */
        /* ARRI√àRE-PLAN CIN√âMATIQUE CNIM */
        /* ============================================ */
        .animated-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
        }

        [data-theme="dark"] .animated-background {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f1419 100%);
        }

        /* Rectangles anim√©s style logo CNIM */
        .cnim-rect {
            position: absolute;
            background: linear-gradient(135deg, rgba(0, 102, 204, 0.03), rgba(0, 102, 204, 0.08));
            animation: float 20s infinite ease-in-out;
            border-radius: 4px;
        }

        [data-theme="dark"] .cnim-rect {
            background: linear-gradient(135deg, rgba(0, 102, 204, 0.08), rgba(0, 102, 204, 0.15));
        }

        .cnim-rect:nth-child(1) {
            width: 200px;
            height: 300px;
            top: 10%;
            left: 5%;
            animation-delay: 0s;
            animation-duration: 25s;
        }

        .cnim-rect:nth-child(2) {
            width: 150px;
            height: 250px;
            top: 60%;
            left: 15%;
            animation-delay: -5s;
            animation-duration: 30s;
        }

        .cnim-rect:nth-child(3) {
            width: 180px;
            height: 280px;
            top: 30%;
            right: 10%;
            animation-delay: -10s;
            animation-duration: 28s;
        }

        .cnim-rect:nth-child(4) {
            width: 160px;
            height: 240px;
            bottom: 10%;
            right: 20%;
            animation-delay: -15s;
            animation-duration: 32s;
        }

        .cnim-rect:nth-child(5) {
            width: 220px;
            height: 320px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation-delay: -8s;
            animation-duration: 35s;
        }

        /* Lignes verticales style CNIM */
        .cnim-line {
            position: absolute;
            width: 2px;
            height: 100%;
            background: linear-gradient(180deg, transparent 0%, rgba(0, 102, 204, 0.1) 50%, transparent 100%);
            animation: lineSlide 15s infinite linear;
        }

        [data-theme="dark"] .cnim-line {
            background: linear-gradient(180deg, transparent 0%, rgba(0, 102, 204, 0.2) 50%, transparent 100%);
        }

        .cnim-line:nth-child(6) {
            left: 20%;
            animation-delay: 0s;
        }

        .cnim-line:nth-child(7) {
            left: 40%;
            animation-delay: -3s;
        }

        .cnim-line:nth-child(8) {
            left: 60%;
            animation-delay: -6s;
        }

        .cnim-line:nth-child(9) {
            left: 80%;
            animation-delay: -9s;
        }

        /* Particules flottantes */
        .cnim-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(0, 102, 204, 0.3);
            border-radius: 50%;
            animation: particleFloat 20s infinite ease-in-out;
        }

        [data-theme="dark"] .cnim-particle {
            background: rgba(0, 102, 204, 0.5);
        }

        .cnim-particle:nth-child(10) {
            top: 20%;
            left: 10%;
            animation-delay: 0s;
        }

        .cnim-particle:nth-child(11) {
            top: 40%;
            left: 30%;
            animation-delay: -5s;
        }

        .cnim-particle:nth-child(12) {
            top: 60%;
            left: 70%;
            animation-delay: -10s;
        }

        .cnim-particle:nth-child(13) {
            top: 80%;
            left: 50%;
            animation-delay: -15s;
        }

        .cnim-particle:nth-child(14) {
            top: 30%;
            right: 20%;
            animation-delay: -7s;
        }

        .cnim-particle:nth-child(15) {
            top: 70%;
            right: 10%;
            animation-delay: -12s;
        }

        /* Effet de grille subtile */
        .cnim-grid {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 102, 204, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 102, 204, 0.02) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridMove 60s linear infinite;
        }

        [data-theme="dark"] .cnim-grid {
            background-image: 
                linear-gradient(rgba(0, 102, 204, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 102, 204, 0.05) 1px, transparent 1px);
        }

        @keyframes float {
            0%, 100% {
                transform: translate(0, 0) rotate(0deg);
            }
            25% {
                transform: translate(20px, -30px) rotate(5deg);
            }
            50% {
                transform: translate(-15px, -60px) rotate(-3deg);
            }
            75% {
                transform: translate(-30px, -30px) rotate(7deg);
            }
        }

        @keyframes lineSlide {
            0% {
                transform: translateY(-100%);
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                transform: translateY(100%);
                opacity: 0;
            }
        }

        @keyframes particleFloat {
            0%, 100% {
                transform: translate(0, 0);
                opacity: 0.3;
            }
            25% {
                transform: translate(30px, -50px);
                opacity: 0.6;
            }
            50% {
                transform: translate(-20px, -100px);
                opacity: 0.8;
            }
            75% {
                transform: translate(-40px, -50px);
                opacity: 0.6;
            }
        }

        @keyframes gridMove {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: 50px 50px;
            }
        }

        /* Cercles lumineux style CNIM */
        .cnim-circle {
            position: absolute;
            border: 2px solid rgba(0, 102, 204, 0.2);
            border-radius: 50%;
            animation: circleExpand 15s infinite ease-in-out;
        }

        [data-theme="dark"] .cnim-circle {
            border-color: rgba(0, 102, 204, 0.3);
        }

        .cnim-circle:nth-child(16) {
            width: 300px;
            height: 300px;
            top: 20%;
            left: 60%;
            animation-delay: 0s;
        }

        .cnim-circle:nth-child(17) {
            width: 200px;
            height: 200px;
            bottom: 30%;
            left: 10%;
            animation-delay: -5s;
        }

        .cnim-circle:nth-child(18) {
            width: 250px;
            height: 250px;
            top: 50%;
            right: 15%;
            animation-delay: -10s;
        }

        @keyframes circleExpand {
            0%, 100% {
                transform: scale(0.8);
                opacity: 0.3;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.6;
            }
        }

        /* Effet de lumi√®re radiale */
        .cnim-glow {
            position: absolute;
            width: 400px;
            height: 400px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(0, 102, 204, 0.1) 0%, transparent 70%);
            animation: glowPulse 8s infinite ease-in-out;
            pointer-events: none;
        }

        [data-theme="dark"] .cnim-glow {
            background: radial-gradient(circle, rgba(0, 102, 204, 0.2) 0%, transparent 70%);
        }

        .cnim-glow:nth-child(19) {
            top: -200px;
            left: -200px;
            animation-delay: 0s;
        }

        .cnim-glow:nth-child(20) {
            bottom: -200px;
            right: -200px;
            animation-delay: -4s;
        }

        /* Formes g√©om√©triques CNIM */
        .cnim-shape {
            position: absolute;
            background: linear-gradient(45deg, rgba(0, 102, 204, 0.05), rgba(0, 102, 204, 0.1));
            animation: shapeRotate 30s infinite linear;
            clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
        }

        [data-theme="dark"] .cnim-shape {
            background: linear-gradient(45deg, rgba(0, 102, 204, 0.1), rgba(0, 102, 204, 0.15));
        }

        .cnim-shape:nth-child(21) {
            width: 150px;
            height: 150px;
            top: 15%;
            right: 25%;
            animation-duration: 25s;
        }

        .cnim-shape:nth-child(22) {
            width: 120px;
            height: 120px;
            bottom: 25%;
            left: 35%;
            animation-duration: 35s;
            animation-direction: reverse;
        }

        @keyframes shapeRotate {
            0% {
                transform: rotate(0deg) scale(1);
            }
            50% {
                transform: rotate(180deg) scale(1.1);
            }
            100% {
                transform: rotate(360deg) scale(1);
            }
        }

        /* Vagues fluides en arri√®re-plan */
        .cnim-wave {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 200%;
            height: 300px;
            background: linear-gradient(180deg, transparent 0%, rgba(0, 102, 204, 0.03) 100%);
            animation: waveMove 20s infinite linear;
        }

        [data-theme="dark"] .cnim-wave {
            background: linear-gradient(180deg, transparent 0%, rgba(0, 102, 204, 0.08) 100%);
        }

        .cnim-wave:nth-child(23) {
            animation-duration: 25s;
            opacity: 0.5;
        }

        .cnim-wave:nth-child(24) {
            animation-duration: 18s;
            animation-direction: reverse;
            opacity: 0.3;
        }

        @keyframes waveMove {
            0% {
                transform: translateX(0) translateY(0);
            }
            100% {
                transform: translateX(-50%) translateY(20px);
            }
        }

        /* Rayons lumineux diagonaux */
        .cnim-beam {
            position: absolute;
            width: 2px;
            height: 200%;
            background: linear-gradient(180deg, transparent 0%, rgba(0, 102, 204, 0.1) 50%, transparent 100%);
            transform-origin: center;
            animation: beamRotate 40s infinite linear;
        }

        [data-theme="dark"] .cnim-beam {
            background: linear-gradient(180deg, transparent 0%, rgba(0, 102, 204, 0.15) 50%, transparent 100%);
        }

        .cnim-beam:nth-child(25) {
            top: -50%;
            left: 25%;
            animation-delay: 0s;
        }

        .cnim-beam:nth-child(26) {
            top: -50%;
            right: 25%;
            animation-delay: -10s;
        }

        @keyframes beamRotate {
            0% {
                transform: rotate(0deg);
                opacity: 0.2;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                transform: rotate(360deg);
                opacity: 0.2;
            }
        }

        /* ============================================ */
        /* INDICATEUR DE PROCESSUS CIN√âMATIQUE */
        /* ============================================ */
        
        .process-indicator {
            position: fixed;
            top: 100px;
            right: 30px;
            width: 350px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 102, 204, 0.2);
            backdrop-filter: blur(10px);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 2px solid rgba(0, 102, 204, 0.1);
        }

        [data-theme="dark"] .process-indicator {
            background: rgba(15, 52, 96, 0.98);
            border-color: rgba(0, 102, 204, 0.3);
        }

        .process-indicator.active {
            transform: translateX(0);
            animation: slideInBounce 0.6s ease-out;
        }

        @keyframes slideInBounce {
            0% {
                transform: translateX(400px);
            }
            60% {
                transform: translateX(-10px);
            }
            100% {
                transform: translateX(0);
            }
        }

        .process-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #0066cc;
        }

        .process-title {
            font-size: 16px;
            font-weight: 700;
            color: #0066cc;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .process-close {
            background: transparent;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
            transition: all 0.3s;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .process-close:hover {
            background: rgba(0, 102, 204, 0.1);
            color: #0066cc;
            transform: rotate(90deg);
        }

        .process-steps {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .process-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            background: #f8f9fa;
            transition: all 0.4s;
            position: relative;
            overflow: hidden;
        }

        [data-theme="dark"] .process-step {
            background: rgba(0, 102, 204, 0.05);
        }

        .process-step::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, rgba(0, 102, 204, 0.1), rgba(0, 102, 204, 0.05));
            transition: width 0.6s ease-out;
        }

        .process-step.active {
            background: linear-gradient(135deg, rgba(0, 102, 204, 0.1), rgba(0, 102, 204, 0.05));
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.15);
        }

        .process-step.active::before {
            width: 100%;
        }

        .process-step.completed {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.05));
        }

        .process-step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 700;
            background: #e9ecef;
            color: #6c757d;
            position: relative;
            z-index: 1;
            transition: all 0.4s;
        }

        [data-theme="dark"] .process-step-icon {
            background: rgba(255, 255, 255, 0.1);
        }

        .process-step.active .process-step-icon {
            background: linear-gradient(135deg, #0066cc, #003d7a);
            color: white;
            animation: iconPulse 2s infinite;
        }

        .process-step.completed .process-step-icon {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        @keyframes iconPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(0, 102, 204, 0.7);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(0, 102, 204, 0);
            }
        }

        .process-step-content {
            flex: 1;
            position: relative;
            z-index: 1;
        }

        .process-step-label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        [data-theme="dark"] .process-step-label {
            color: #eaeaea;
        }

        .process-step-description {
            font-size: 12px;
            color: #6c757d;
        }

        .process-step-status {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 12px;
            background: #ffc107;
            color: #000;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .process-step.active .process-step-status {
            background: #0066cc;
            color: white;
            animation: statusBlink 1.5s infinite;
        }

        .process-step.completed .process-step-status {
            background: #28a745;
            color: white;
        }

        @keyframes statusBlink {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        /* Barre de progression globale */
        .process-progress {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }

        .process-progress-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
            color: #666;
            font-weight: 600;
        }

        .process-progress-bar-container {
            height: 8px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        [data-theme="dark"] .process-progress-bar-container {
            background: rgba(255, 255, 255, 0.1);
        }

        .process-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #0066cc, #00a8ff);
            border-radius: 10px;
            transition: width 0.6s ease-out;
            position: relative;
            overflow: hidden;
        }

        .process-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        /* Timer anim√© */
        .process-timer {
            margin-top: 15px;
            text-align: center;
            padding: 10px;
            background: linear-gradient(135deg, rgba(0, 102, 204, 0.05), rgba(0, 102, 204, 0.1));
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #0066cc;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .process-timer-icon {
            animation: rotate 2s linear infinite;
        }

        body.compact {
            font-size: 13px;
        }

        body.compact .table td,
        body.compact .table th {
            padding: 6px 8px;
        }

        body.compact .btn {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* En-t√™te avec horloge et logo */
        .header {
            background: linear-gradient(135deg, #0066cc 0%, #003d7a 100%);
            color: white;
            padding: 15px 30px;
            box-shadow: 0 4px 20px rgba(0, 102, 204, 0.3);
            position: relative;
            overflow: hidden;
            animation: slideInLeft 0.6s ease-out;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
            animation: pulse 4s ease-in-out infinite;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-container {
            background: white;
            padding: 8px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            transition: transform 0.3s ease;
            animation: scaleIn 0.5s ease-out 0.2s backwards;
        }

        .logo-container:hover {
            transform: scale(1.05);
            animation: pulse 0.6s ease-in-out;
        }

        .logo-container img {
            height: 50px;
            width: auto;
        }

        .header-title {
            display: flex;
            flex-direction: column;
            gap: 5px;
            animation: slideInLeft 0.6s ease-out 0.3s backwards;
        }

        .header h1 {
            font-size: 26px;
            font-weight: 700;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header-subtitle {
            font-size: 13px;
            font-weight: 400;
            opacity: 0.9;
            letter-spacing: 0.5px;
            animation: fadeIn 0.8s ease-out 0.5s backwards;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dept-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);
            animation: pulse 2s ease-in-out infinite;
        }

        [data-theme="dark"] .dept-badge {
            box-shadow: 0 2px 12px rgba(255, 152, 0, 0.5);
        }

        .clock-container {
            display: flex;
            gap: 15px;
            align-items: center;
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .theme-toggle {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .clock {
            text-align: right;
            animation: fadeIn 1s ease-out 0.4s backwards;
        }

        .clock-time {
            font-size: 30px;
            font-weight: 700;
            letter-spacing: 2px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .clock-date {
            font-size: 13px;
            opacity: 0.95;
            margin-top: 3px;
            font-weight: 500;
        }

        .btn-agenda {
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.4);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-agenda:hover {
            background: white;
            color: #0066cc;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,255,255,0.3);
        }

        /* ============================================ */
        /* ONGLETS - Responsive avec navigation mobile */
        /* ============================================ */
        .tabs {
            background: var(--bg-secondary);
            box-shadow: 0 3px 10px var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(0, 102, 204, 0.1);
        }

        .tabs-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: var(--spacing-xs);
            padding: 0 var(--spacing-lg);
            overflow-x: auto;
            scrollbar-width: thin;
        }
        
        /* Masquer scrollbar sur mobile */
        .tabs-container::-webkit-scrollbar {
            height: 2px;
        }
        
        .tabs-container::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 2px;
        }

        .tab {
            padding: var(--spacing-md) var(--spacing-lg);
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: var(--font-size-md);
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            position: relative;
            white-space: nowrap;
            min-height: var(--touch-target);
        }

        .tab:hover {
            color: var(--primary-color);
            background: rgba(0, 102, 204, 0.05);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: rgba(0, 102, 204, 0.08);
            animation: scaleIn 0.3s ease-out;
        }

        .tab.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), transparent);
            animation: progressBar 0.5s ease-out;
        }
        
        /* ============================================ */
        /* NAVIGATION MOBILE (Bottom Bar) */
        /* ============================================ */
        .mobile-bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            padding: var(--spacing-xs) 0;
        }
        
        .mobile-nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
            max-width: 100%;
        }
        
        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm);
            min-width: 64px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: var(--font-size-xs);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .mobile-nav-item .icon {
            font-size: 24px;
            transition: transform 0.2s;
        }
        
        .mobile-nav-item:active {
            transform: scale(0.95);
        }
        
        .mobile-nav-item.active {
            color: var(--primary-color);
        }
        
        .mobile-nav-item.active .icon {
            transform: scale(1.2);
        }
        
        .mobile-nav-item.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 3px;
            background: var(--primary-color);
            border-radius: 0 0 3px 3px;
        }
        
        /* Mobile: masquer tabs desktop, afficher bottom nav */
        @media (max-width: 768px) {
            .tabs {
                display: none;
            }
            
            .mobile-bottom-nav {
                display: block;
            }
            
            .main-content {
                padding-bottom: 70px; /* Espace pour bottom nav */
            }
            
            /* Boutons pleine largeur sur mobile */
            .btn:not(.btn-small):not(.fab) {
                width: 100%;
            }
        }

        /* Barre de recherche globale */
        .global-search {
            background: var(--bg-secondary);
            padding: 15px 30px;
            box-shadow: 0 2px 4px var(--shadow);
        }

        .search-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .search-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-filter-select {
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
        }

        .btn-save-view {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .btn-save-view:hover {
            background: #5568d3;
        }

        .saved-views {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .saved-view-chip {
            padding: 6px 12px;
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid #667eea;
            border-radius: 20px;
            font-size: 13px;
            color: #667eea;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .saved-view-chip:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        .saved-view-chip .remove {
            font-weight: bold;
            cursor: pointer;
        }

        /* √âtiquettes visuelles */
        .visual-labels {
            display: flex;
            gap: 6px;
            margin-top: 5px;
        }

        .label-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .label-risque {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }

        .label-retard {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #dc3545;
        }

        .label-bloque {
            background: #e2e3e5;
            color: #383d41;
            border: 1px solid #6c757d;
        }

        [data-theme="dark"] .label-risque {
            background: #664d03;
            color: #ffecb5;
            border-color: #997404;
        }

        [data-theme="dark"] .label-retard {
            background: #58151c;
            color: #f8d7da;
            border-color: #842029;
        }

        [data-theme="dark"] .label-bloque {
            background: #2b2d2f;
            color: #d3d3d4;
            border-color: #495057;
        }

        /* Contenu principal */
        .main-content {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 30px;
            position: relative;
            z-index: 1;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cartes am√©lior√©es */
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px var(--shadow);
            border: 1px solid rgba(0, 102, 204, 0.1);
            transition: all 0.3s ease;
            animation: fadeIn 0.6s ease-out backwards;
            animation-delay: calc(var(--card-index, 0) * 0.1s);
        }

        .card:hover {
            box-shadow: 0 8px 25px var(--shadow);
            transform: translateY(-2px);
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 12px;
            border-bottom: 2px solid #0066cc;
            position: relative;
            animation: slideInLeft 0.5s ease-out;
        }

        .card-title::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 60px;
            height: 2px;
            background: linear-gradient(90deg, #0066cc, transparent);
            animation: progressBar 0.8s ease-out;
        }

        /* Formulaires */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: var(--font-size-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.3s ease;
            min-height: var(--touch-target);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(0, 102, 204, 0.15);
            transform: translateY(-1px);
        }
        
        .form-control:disabled {
            background: #f1f3f5;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
        }
        
        /* Mobile-first: colonnes empil√©es sur petit √©cran */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* ============================================ */
        /* BOUTONS - Mobile-First & Accessibilit√© */
        /* ============================================ */
        .btn {
            min-height: var(--touch-target);
            min-width: var(--touch-target);
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: var(--font-size-md);
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            text-decoration: none;
            text-align: center;
        }
        
        /* Effet tactile (ripple) */
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.4);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #002952 100%);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--secondary-dark);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-small {
            min-height: 36px;
            padding: 8px 16px;
            font-size: var(--font-size-sm);
        }
        
        .btn-large {
            min-height: 56px;
            padding: 16px 32px;
            font-size: var(--font-size-lg);
        }
        
        /* Bouton flottant d'action (FAB) - Mobile */
        .fab {
            position: fixed;
            bottom: var(--spacing-lg);
            right: var(--spacing-lg);
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            box-shadow: 0 6px 20px rgba(0,102,204,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 24px;
            z-index: 100;
            transition: all 0.3s ease;
        }
        
        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 8px 30px rgba(0,102,204,0.6);
        }
        
        @media (min-width: 769px) {
            .fab {
                display: none; /* Masquer sur desktop */
            }
        }

        /* ============================================ */
        /* TABLES - Responsive */
        /* ============================================ */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .table th {
            background: var(--bg-primary);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
        }

        .table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .table tbody tr {
            animation: fadeIn 0.4s ease-out backwards;
            animation-delay: calc(var(--row-index, 0) * 0.03s);
        }

        .table tbody tr:hover {
            background: var(--bg-primary);
            transform: scale(1.01);
            box-shadow: 0 2px 8px var(--shadow);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px var(--shadow);
            animation: modalSlideIn 0.3s;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 20px;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 25px;
        }

        /* Gantt Chart */
        .gantt-wrapper {
            margin-top: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
        }

        .gantt-container {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 600px;
        }

        .gantt-chart {
            min-width: 800px;
            font-size: 13px;
        }

        .gantt-header {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .gantt-task-name {
            width: 250px;
            flex-shrink: 0;
            padding: 12px;
            font-weight: 600;
            border-right: 2px solid #dee2e6;
            background: #f8f9fa;
        }

        .gantt-timeline-header {
            flex: 1;
            display: flex;
            background: #f8f9fa;
        }

        .gantt-timeline {
            flex: 1;
            position: relative;
            min-height: 50px;
        }

        .gantt-row {
            display: flex;
            border-bottom: 1px solid #e9ecef;
            transition: background 0.2s;
        }

        .gantt-row:hover {
            background: #f8f9fa;
        }

        .gantt-task-info {
            width: 250px;
            flex-shrink: 0;
            padding: 12px;
            border-right: 2px solid #dee2e6;
            background: white;
        }

        .gantt-task-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 3px;
            font-size: 13px;
        }

        .gantt-task-subtitle {
            font-size: 11px;
            color: #666;
        }

        .gantt-timeline-content {
            flex: 1;
            position: relative;
            min-height: 50px;
            padding: 10px 0;
        }

        .gantt-bar {
            position: absolute;
            height: 30px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding: 0 8px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.3s;
            overflow: hidden;
            white-space: nowrap;
        }

        .gantt-bar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 5;
        }

        .gantt-bar.avancement-0-50 {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .gantt-bar.avancement-50-80 {
            background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%);
        }

        .gantt-bar.avancement-80-100 {
            background: linear-gradient(135deg, #fd7e14 0%, #ff6b00 100%);
        }

        .gantt-bar.avancement-100-plus {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .gantt-bar.termine {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        }

        .gantt-bar.priorite-urgente {
            border: 2px solid #dc3545;
            animation: gantt-pulse 2s infinite;
        }

        .gantt-bar.chemin-critique {
            border: 3px solid #e74c3c;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
            font-weight: 700;
        }

        .gantt-baseline-bar {
            position: absolute;
            height: 24px;
            top: 3px;
            border: 2px dashed #3498db;
            border-radius: 4px;
            background: rgba(52, 152, 219, 0.15);
            pointer-events: none;
            z-index: 1;
        }

        .gantt-dependency-arrow {
            pointer-events: none;
        }

        @keyframes gantt-pulse {
            0%, 100% { box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
            50% { box-shadow: 0 4px 12px rgba(220, 53, 69, 0.6); }
        }

        .gantt-bar-content {
            display: flex;
            align-items: center;
            gap: 5px;
            width: 100%;
        }

        .gantt-bar-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .gantt-bar-progress {
            font-size: 10px;
            background: rgba(0,0,0,0.2);
            padding: 2px 5px;
            border-radius: 8px;
        }

        .gantt-date-marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 1px;
            background: #dee2e6;
        }

        .gantt-date-marker.today {
            background: #dc3545;
            width: 2px;
            z-index: 1;
        }

        .gantt-date-label {
            position: absolute;
            top: -25px;
            transform: translateX(-50%);
            font-size: 11px;
            color: #666;
            white-space: nowrap;
        }

        .gantt-today-label {
            color: #dc3545;
            font-weight: 700;
        }

        /* Contr√¥les du Gantt */
        .gantt-controls {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group label {
            font-size: 13px;
            font-weight: 600;
            color: #495057;
            margin: 0;
        }

        /* L√©gende du Gantt */
        .gantt-legend {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .legend-title {
            font-weight: 600;
            color: #495057;
        }

        .legend-items {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .legend-color {
            width: 20px;
            height: 14px;
            border-radius: 3px;
        }

        /* Grille mensuelle */
        .grille-mensuelle-container {
            overflow-x: auto;
            margin-top: 15px;
        }

        .table-mensuelle {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            background: white;
        }

        .table-mensuelle th {
            background: #667eea;
            color: white;
            padding: 10px 8px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #5568d3;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .table-mensuelle th.agent-col {
            background: #764ba2;
            text-align: left;
            min-width: 150px;
            position: sticky;
            left: 0;
            z-index: 6;
        }

        .table-mensuelle th.affaire-col {
            background: #764ba2;
            text-align: left;
            min-width: 180px;
        }

        .table-mensuelle td {
            padding: 8px;
            text-align: center;
            border: 1px solid #dee2e6;
        }

        .table-mensuelle td.agent-cell {
            background: #f8f9fa;
            font-weight: 600;
            text-align: left;
            position: sticky;
            left: 0;
            z-index: 4;
            border-right: 2px solid #667eea;
        }

        .table-mensuelle td.affaire-cell {
            background: #fff;
            text-align: left;
            padding-left: 20px;
            font-size: 11px;
            color: #666;
        }

        .table-mensuelle td.total-cell {
            background: #e7f3ff;
            font-weight: 700;
            color: #667eea;
        }

        .table-mensuelle td.weekend {
            background: #f1f3f5;
        }

        .table-mensuelle td.jour-pointe {
            background: #d1f4e0;
            font-weight: 600;
        }

        .table-mensuelle td.jour-demi {
            background: #fff3cd;
            font-weight: 600;
        }

        .table-mensuelle td.jour-absent {
            background: #f8d7da;
            color: #999;
        }

        .table-mensuelle th.weekend-header {
            background: #9fa8b3;
        }

        .table-mensuelle tr:hover td {
            background-color: #fffbf0;
        }

        .table-mensuelle tr:hover td.agent-cell {
            background-color: #e7f3ff;
        }

        /* Synth√®se √©carts */
        .ecarts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .ecart-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .ecart-card.depassement {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .ecart-card.conforme {
            border-left-color: #28a745;
            background: #f0fff4;
        }

        .ecart-card.risque {
            border-left-color: #ffc107;
            background: #fffbf0;
        }

        .ecart-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .ecart-title {
            font-weight: 600;
            color: #2c3e50;
        }

        .ecart-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .ecart-badge.depassement {
            background: #dc3545;
            color: white;
        }

        .ecart-badge.conforme {
            background: #28a745;
            color: white;
        }

        .ecart-badge.risque {
            background: #ffc107;
            color: #664d03;
        }

        .ecart-details {
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }

        .ecart-progress {
            margin-top: 10px;
        }

        .mensuel-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
        }

        /* Pointage journalier */
        .journalier-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .grille-journaliere {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .jour-cell {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .jour-cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .jour-cell.weekend {
            background: #f1f3f5;
            border-color: #adb5bd;
        }

        .jour-cell.type-j {
            background: #d1f4e0;
            border-color: #28a745;
        }

        .jour-cell.type-d {
            background: #fff3cd;
            border-color: #ffc107;
        }

        .jour-cell.type-a {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .jour-numero {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }

        .jour-nom {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }

        .jour-type {
            font-size: 32px;
            font-weight: 700;
            margin: 10px 0;
        }

        .jour-type.type-j {
            color: #28a745;
        }

        .jour-type.type-d {
            color: #ffc107;
        }

        .jour-type.type-a {
            color: #dc3545;
        }

        .jour-heures {
            font-size: 12px;
            color: #666;
            font-weight: 600;
        }

        .journalier-totaux {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            color: white;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            text-align: center;
        }

        .total-item h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .total-item .value {
            font-size: 36px;
            font-weight: 700;
        }

        .journalier-legende {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .legende-title {
            font-weight: 600;
            color: #495057;
        }

        .legende-items {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .legende-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .legende-box {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            border: 2px solid;
        }

        .legende-box.j {
            background: #d1f4e0;
            border-color: #28a745;
            color: #28a745;
        }

        .legende-box.d {
            background: #fff3cd;
            border-color: #ffc107;
            color: #ffc107;
        }

        .legende-box.a {
            background: #f8d7da;
            border-color: #dc3545;
            color: #dc3545;
        }

        .legende-box.weekend {
            background: #f1f3f5;
            border: 2px solid #adb5bd;
        }

        /* Synth√®se */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
        }

        /* Agenda items */
        .agenda-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .agenda-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .agenda-item-title {
            font-weight: 600;
            color: #2c3e50;
        }

        .agenda-item-agent {
            color: #667eea;
            font-weight: 600;
        }

        .agenda-item-details {
            font-size: 13px;
            color: #666;
        }

        /* Badge de statut */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* S√©lecteur de temps de pointage */
        .time-selector {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .time-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .time-btn:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .time-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* Styles pour les s√©lecteurs heures/minutes */
        #heuresSelect, #minutesSelect {
            transition: all 0.3s ease;
            cursor: pointer;
            animation: scaleIn 0.5s ease-out;
        }

        #heuresSelect:hover, #minutesSelect:hover {
            border-color: #0066cc;
            box-shadow: 0 0 10px rgba(0, 102, 204, 0.2);
            transform: scale(1.02);
        }

        #heuresSelect:focus, #minutesSelect:focus {
            border-color: #0066cc;
            box-shadow: 0 0 15px rgba(0, 102, 204, 0.4);
            outline: none;
            animation: glowPulse 2s ease-in-out infinite;
        }

        #tempsTotal {
            transition: transform 0.2s ease;
            animation: bounce 1s ease-in-out;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        /* Layout pour l'onglet Affaires */
        .affaires-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .affaires-layout {
                grid-template-columns: 1fr;
            }

            .kanban-board {
                grid-template-columns: 1fr;
            }

            .search-container {
                flex-direction: column;
                align-items: stretch;
            }

            .search-input {
                min-width: 100%;
            }
        }

        /* Vue Kanban */
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            padding: 20px;
            background: var(--bg-primary);
            border-radius: 8px;
        }

        .kanban-column {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 15px;
            min-height: 500px;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .kanban-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .kanban-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .kanban-count {
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }

        .kanban-cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .kanban-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            cursor: move;
            transition: all 0.3s;
            box-shadow: 0 1px 3px var(--shadow);
        }

        .kanban-card:hover {
            box-shadow: 0 4px 12px var(--shadow);
            transform: translateY(-2px);
        }

        .kanban-card.dragging {
            opacity: 0.5;
        }

        .kanban-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .kanban-card-number {
            font-weight: 700;
            color: #667eea;
            font-size: 13px;
        }

        .kanban-card-priority {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        .kanban-card-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
            margin-bottom: 5px;
        }

        .kanban-card-client {
            color: var(--text-secondary);
            font-size: 12px;
            margin-bottom: 8px;
        }

        .kanban-card-agent {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .kanban-card-progress {
            margin-bottom: 8px;
        }

        .kanban-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
        }

        .kanban-card-actions {
            display: flex;
            gap: 5px;
        }

        .kanban-card-btn {
            padding: 4px 8px;
            border: none;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }

        .kanban-card-btn:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        .kanban-cards.drag-over {
            background: rgba(102, 126, 234, 0.1);
            border: 2px dashed #667eea;
            border-radius: 8px;
        }

        .affaires-main {
            min-width: 0;
        }

        .affaires-sidebar {
            position: sticky;
            top: 80px;
            align-self: start;
        }

        .retards-card {
            background: #fff3cd;
            border-left: 4px solid #dc3545;
        }

        .retard-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid #dc3545;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .retard-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .retard-item-title {
            font-weight: 600;
            color: #dc3545;
            font-size: 13px;
        }

        .retard-item-days {
            background: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .retard-item-details {
            font-size: 12px;
            color: #666;
            line-height: 1.5;
        }

        /* Barre de progression */
        .progress-bar-container {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: 600;
        }

        .progress-bar.warning {
            background: linear-gradient(90deg, #ffc107 0%, #ff9800 100%);
        }

        .progress-bar.danger {
            background: linear-gradient(90deg, #dc3545 0%, #c82333 100%);
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 11px;
            font-weight: 600;
            color: #333;
            text-shadow: 0 0 3px white;
        }

        /* Statut badge dans le tableau */
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
        }

        .status-en-attente {
            background: #e9ecef;
            color: #495057;
        }

        .status-en-cours {
            background: #cfe2ff;
            color: #084298;
        }

        .status-termine {
            background: #d1e7dd;
            color: #0a3622;
        }

        .status-suspendu {
            background: #f8d7da;
            color: #842029;
        }

        /* Actions dans le tableau */
        .action-buttons {
            display: flex;
            gap: 5px;
        }

        /* Tableaux optimis√©s */
        #tableauAffaires {
            font-size: 13px;
        }

        #tableauAffaires th {
            font-size: 12px;
            white-space: nowrap;
        }

        #tableauAffaires td {
            vertical-align: middle;
        }

        /* Badges de priorit√© */
        .priority-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
        }

        .priority-basse {
            background: #d1e7dd;
            color: #0a3622;
        }

        .priority-normale {
            background: #fff3cd;
            color: #664d03;
        }

        .priority-haute {
            background: #ffe5d0;
            color: #984c0c;
        }

        .priority-urgente {
            background: #f8d7da;
            color: #842029;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        /* Vue par affaire */
        .affaire-detail {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .affaire-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .affaire-header:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653a8b 100%);
        }

        .affaire-header-left h3 {
            margin: 0;
            font-size: 18px;
        }

        .affaire-header-left p {
            margin: 5px 0 0 0;
            opacity: 0.9;
            font-size: 14px;
        }

        .affaire-header-right {
            text-align: right;
        }

        .affaire-progress-circle {
            display: inline-block;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .affaire-body {
            padding: 20px;
            display: none;
        }

        .affaire-body.active {
            display: block;
        }

        .affaire-resume {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .resume-item {
            display: flex;
            flex-direction: column;
        }

        .resume-item label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .resume-item value {
            font-size: 15px;
            font-weight: 600;
            color: #2c3e50;
        }

        .sous-taches-list {
            margin-top: 20px;
        }

        .sous-tache-item {
            background: white;
            border: 1px solid #dee2e6;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .sous-tache-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateX(5px);
        }

        .sous-tache-item.priority-urgente {
            border-left-color: #dc3545;
        }

        .sous-tache-item.priority-haute {
            border-left-color: #fd7e14;
        }

        .sous-tache-item.priority-normale {
            border-left-color: #ffc107;
        }

        .sous-tache-item.priority-basse {
            border-left-color: #28a745;
        }

        .sous-tache-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .sous-tache-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 15px;
        }

        .sous-tache-type {
            background: #e9ecef;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: #495057;
        }

        .sous-tache-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 13px;
            color: #666;
        }

        .timeline-container {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .timeline-item {
            position: relative;
            padding-left: 30px;
            padding-bottom: 15px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dee2e6;
        }

        .timeline-item:last-child::before {
            display: none;
        }

        .timeline-dot {
            position: absolute;
            left: 0;
            top: 5px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            border: 3px solid #667eea;
        }

        .timeline-dot.urgente {
            border-color: #dc3545;
            animation: pulse 2s infinite;
        }

        .timeline-dot.haute {
            border-color: #fd7e14;
        }

        .timeline-dot.normale {
            border-color: #ffc107;
        }

        .timeline-dot.basse {
            border-color: #28a745;
        }

        .timeline-content {
            background: white;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .type-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            background: #e9ecef;
            color: #495057;
            margin-right: 5px;
        }

        /* ============================================ */
        /* √âCRAN DE CHARGEMENT ANIM√â */
        /* ============================================ */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0066cc 0%, #003d7a 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s, visibility 0.5s;
        }

        .loader-overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loader-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: rotate 1s linear infinite;
            margin-bottom: 20px;
        }

        .loader-text {
            color: white;
            font-size: 16px;
            font-weight: 500;
            animation: fadeIn 1s ease-in-out infinite alternate;
        }
    </style>
</head>
<body>
    <!-- ============================================ -->
    <!-- √âCRAN DE CONNEXION -->
    <!-- ============================================ -->
    <div id="loginScreen">
        <!-- Particules anim√©es d'arri√®re-plan -->
        <div class="login-particles">
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
        </div>
        
        <!-- Grille industrielle -->
        <div class="login-grid"></div>
        
        <div class="login-container">
            <div class="login-header">
                <!-- Badge D√©partement M√©thodes -->
                <div class="login-department-badge">
                    D√©partement M√©thodes
                </div>
                
                <!-- Logo CNIM + Chaudi√®re 3D -->
                <div class="login-logo-container">
                    <!-- Logo CNIM BABCOCK MAROC -->
                    <svg class="login-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 350 120">
                        <!-- CNIM - Bleu -->
                        <rect x="0" y="48" width="54" height="72" fill="#0066cc"/>
                        <rect x="55" y="48" width="54" height="72" fill="#0066cc"/>
                        <rect x="55" y="48" width="27" height="72" fill="white"/>
                        <rect x="110" y="48" width="54" height="72" fill="#0066cc"/>
                        <rect x="124" y="48" width="40" height="72" fill="white"/>
                        <rect x="165" y="48" width="54" height="72" fill="#0066cc"/>
                        <!-- BABCOCK - Gris -->
                        <text x="195" y="90" font-family="Arial, sans-serif" font-size="36" font-weight="bold" fill="#999999">BABCOCK</text>
                        <!-- MAROC -->
                        <text x="195" y="115" font-family="Arial, sans-serif" font-size="28" font-weight="bold" fill="#0066cc">MAROC</text>
                    </svg>
                    
                    <!-- Image 3D de Chaudi√®re -->
                    <div class="login-boiler-3d">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200">
                            <defs>
                                <linearGradient id="boilerGrad1" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#ff9800;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#f57c00;stop-opacity:1" />
                                </linearGradient>
                                <linearGradient id="boilerGrad2" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" style="stop-color:#ffa726;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#ef6c00;stop-opacity:1" />
                                </linearGradient>
                                <radialGradient id="flameGrad">
                                    <stop offset="0%" style="stop-color:#ffeb3b;stop-opacity:1" />
                                    <stop offset="50%" style="stop-color:#ff9800;stop-opacity:0.8" />
                                    <stop offset="100%" style="stop-color:#ff5722;stop-opacity:0.6" />
                                </radialGradient>
                            </defs>
                            
                            <!-- Corps principal chaudi√®re -->
                            <ellipse cx="100" cy="180" rx="70" ry="10" fill="#424242" opacity="0.3"/>
                            <rect x="50" y="60" width="100" height="120" fill="url(#boilerGrad1)" rx="10"/>
                            <rect x="55" y="65" width="90" height="110" fill="url(#boilerGrad2)" rx="8"/>
                            
                            <!-- Panneau de contr√¥le -->
                            <rect x="70" y="80" width="60" height="40" fill="#263238" rx="4"/>
                            <circle cx="80" cy="95" r="4" fill="#4caf50">
                                <animate attributeName="opacity" values="1;0.3;1" dur="2s" repeatCount="indefinite"/>
                            </circle>
                            <circle cx="95" cy="95" r="4" fill="#ff9800">
                                <animate attributeName="opacity" values="1;0.5;1" dur="1.5s" repeatCount="indefinite"/>
                            </circle>
                            <circle cx="110" cy="95" r="4" fill="#f44336">
                                <animate attributeName="opacity" values="0.5;1;0.5" dur="1s" repeatCount="indefinite"/>
                            </circle>
                            <rect x="75" y="105" width="50" height="12" fill="#37474f" rx="2"/>
                            
                            <!-- Tuyaux -->
                            <rect x="40" y="70" width="12" height="80" fill="#607d8b" rx="6"/>
                            <rect x="148" y="70" width="12" height="80" fill="#607d8b" rx="6"/>
                            <circle cx="46" cy="65" r="8" fill="#546e7a"/>
                            <circle cx="154" cy="65" r="8" fill="#546e7a"/>
                            
                            <!-- Chemin√©e -->
                            <rect x="85" y="20" width="30" height="45" fill="#78909c" rx="4"/>
                            <rect x="80" y="15" width="40" height="8" fill="#607d8b" rx="2"/>
                            
                            <!-- Flamme anim√©e -->
                            <ellipse cx="100" cy="10" rx="15" ry="20" fill="url(#flameGrad)">
                                <animate attributeName="ry" values="20;25;20" dur="1s" repeatCount="indefinite"/>
                                <animate attributeName="opacity" values="0.8;1;0.8" dur="1s" repeatCount="indefinite"/>
                            </ellipse>
                            <ellipse cx="95" cy="8" rx="8" ry="12" fill="#ffeb3b" opacity="0.6">
                                <animate attributeName="ry" values="12;16;12" dur="0.8s" repeatCount="indefinite"/>
                            </ellipse>
                            <ellipse cx="105" cy="8" rx="8" ry="12" fill="#ffeb3b" opacity="0.6">
                                <animate attributeName="ry" values="12;16;12" dur="0.8s" repeatCount="indefinite"/>
                            </ellipse>
                            
                            <!-- Vapeur -->
                            <circle cx="90" cy="5" r="4" fill="white" opacity="0.4">
                                <animate attributeName="cy" values="5;-10" dur="2s" repeatCount="indefinite"/>
                                <animate attributeName="opacity" values="0.4;0" dur="2s" repeatCount="indefinite"/>
                            </circle>
                            <circle cx="110" cy="3" r="5" fill="white" opacity="0.5">
                                <animate attributeName="cy" values="3;-15" dur="2.5s" repeatCount="indefinite"/>
                                <animate attributeName="opacity" values="0.5;0" dur="2.5s" repeatCount="indefinite"/>
                            </circle>
                            
                            <!-- Reflets m√©talliques -->
                            <rect x="60" y="70" width="4" height="100" fill="white" opacity="0.2" rx="2"/>
                            <rect x="135" y="75" width="3" height="95" fill="white" opacity="0.15" rx="1"/>
                        </svg>
                    </div>
                </div>
                
                <h2 class="login-title">Connexion</h2>
                <p class="login-subtitle">Gestion de Pointage et Planning</p>
            </div>

            <div class="login-error" id="loginError">
                Email ou mot de passe incorrect
            </div>

            <form class="login-form" id="loginForm" onsubmit="return handleLogin(event)">
                <div class="form-group">
                    <label class="form-label" for="emailInput">Email</label>
                    <input 
                        type="email" 
                        id="emailInput" 
                        class="form-input" 
                        placeholder="votre.nom@cnim.ma"
                        required
                        autocomplete="email"
                    />
                </div>

                <div class="form-group">
                    <label class="form-label" for="passwordInput">Mot de passe</label>
                    <div class="password-container">
                        <input 
                            type="password" 
                            id="passwordInput" 
                            class="form-input" 
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            required
                            autocomplete="current-password"
                        />
                        <button 
                            type="button" 
                            class="password-toggle" 
                            onclick="togglePassword()"
                            aria-label="Afficher/Masquer le mot de passe"
                        >
                            üëÅÔ∏è
                        </button>
                    </div>
                </div>

                <div class="form-options">
                    <label class="remember-me">
                        <input type="checkbox" id="rememberMe" />
                        <span>Se souvenir de moi</span>
                    </label>
                    <a href="#" class="forgot-password" onclick="showForgotPasswordModal(event)">
                        Mot de passe oubli√©?
                    </a>
                </div>

                <button type="submit" class="login-button" id="loginButton">
                    Se connecter
                </button>
            </form>

            <div class="login-footer">
                ¬© 2025 CNIM BABCOCK MAROC - Tous droits r√©serv√©s
            </div>
        </div>
    </div>

    <!-- Modal Mot de passe oubli√© -->
    <div class="forgot-modal" id="forgotModal">
        <div class="forgot-modal-content">
            <h3 class="forgot-modal-header">R√©initialisation du mot de passe</h3>
            <div class="forgot-modal-body">
                <div class="forgot-success" id="forgotSuccess">
                    Un email de r√©initialisation a √©t√© envoy√© √† votre adresse.
                </div>
                <p class="forgot-modal-text">
                    Entrez votre adresse email professionnelle. Vous recevrez un lien pour r√©initialiser votre mot de passe.
                </p>
                <div class="form-group">
                    <label class="form-label" for="forgotEmailInput">Email</label>
                    <input 
                        type="email" 
                        id="forgotEmailInput" 
                        class="form-input" 
                        placeholder="votre.nom@cnim.ma"
                    />
                </div>
            </div>
            <div class="forgot-modal-actions">
                <button class="forgot-modal-button secondary" onclick="closeForgotPasswordModal()">
                    Annuler
                </button>
                <button class="forgot-modal-button primary" onclick="sendPasswordReset()">
                    Envoyer
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Changement de mot de passe -->
    <div class="change-password-modal" id="changePasswordModal">
        <div class="change-password-content">
            <h3 class="change-password-header">
                üîê Changer le mot de passe
            </h3>
            <div class="change-password-body">
                <div class="change-password-info">
                    üí° Votre mot de passe doit contenir au moins 6 caract√®res
                </div>
                <div class="form-group">
                    <label class="form-label" for="currentPasswordInput">Mot de passe actuel</label>
                    <input 
                        type="password" 
                        id="currentPasswordInput" 
                        class="form-input" 
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    />
                </div>
                <div class="form-group">
                    <label class="form-label" for="newPasswordInput">Nouveau mot de passe</label>
                    <input 
                        type="password" 
                        id="newPasswordInput" 
                        class="form-input" 
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        oninput="checkPasswordStrength()"
                    />
                    <div class="password-strength">
                        <div class="password-strength-bar" id="passwordStrengthBar"></div>
                    </div>
                    <div class="password-strength-text" id="passwordStrengthText"></div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="confirmPasswordInput">Confirmer le mot de passe</label>
                    <input 
                        type="password" 
                        id="confirmPasswordInput" 
                        class="form-input" 
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    />
                </div>
            </div>
            <div class="forgot-modal-actions">
                <button class="forgot-modal-button secondary" onclick="closeChangePasswordModal()">
                    Annuler
                </button>
                <button class="forgot-modal-button primary" onclick="saveNewPassword()">
                    Enregistrer
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- CONTENU PRINCIPAL DE L'APPLICATION -->
    <!-- ============================================ -->
    <div id="appContent">
    <!-- Arri√®re-plan Cin√©matique CNIM -->
    <div class="animated-background">
        <!-- Grille de fond -->
        <div class="cnim-grid"></div>
        
        <!-- Rectangles anim√©s style logo CNIM -->
        <div class="cnim-rect"></div>
        <div class="cnim-rect"></div>
        <div class="cnim-rect"></div>
        <div class="cnim-rect"></div>
        <div class="cnim-rect"></div>
        
        <!-- Lignes verticales -->
        <div class="cnim-line"></div>
        <div class="cnim-line"></div>
        <div class="cnim-line"></div>
        <div class="cnim-line"></div>
        
        <!-- Particules flottantes -->
        <div class="cnim-particle"></div>
        <div class="cnim-particle"></div>
        <div class="cnim-particle"></div>
        <div class="cnim-particle"></div>
        <div class="cnim-particle"></div>
        <div class="cnim-particle"></div>
        
        <!-- Cercles lumineux -->
        <div class="cnim-circle"></div>
        <div class="cnim-circle"></div>
        <div class="cnim-circle"></div>
        
        <!-- Effets de lumi√®re -->
        <div class="cnim-glow"></div>
        <div class="cnim-glow"></div>
        
        <!-- Formes g√©om√©triques -->
        <div class="cnim-shape"></div>
        <div class="cnim-shape"></div>
        
        <!-- Vagues fluides -->
        <div class="cnim-wave"></div>
        <div class="cnim-wave"></div>
        
        <!-- Rayons lumineux -->
        <div class="cnim-beam"></div>
        <div class="cnim-beam"></div>
    </div>

    <!-- √âcran de chargement -->
    <div class="loader-overlay" id="loaderOverlay">
        <div class="loader-spinner"></div>
        <div class="loader-text">‚ö° Chargement D√©partement M√©thode - CNIM...</div>
    </div>

    <!-- Indicateur de processus cin√©matique -->
    <div class="process-indicator" id="processIndicator">
        <div class="process-header">
            <h3 id="processTitle">üé¨ Processus en cours</h3>
            <button onclick="closeProcessIndicator()" class="process-close">‚úï</button>
        </div>
        
        <div class="process-steps" id="processSteps">
            <!-- Les √©tapes seront g√©n√©r√©es dynamiquement -->
        </div>
        
        <div class="process-progress">
            <div class="process-progress-label">
                <span>Progression globale</span>
                <span id="progressPercentage">0%</span>
            </div>
            <div class="process-progress-track">
                <div class="process-progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
        </div>
        
        <div class="process-timer">
            <span class="timer-icon">‚è±Ô∏è</span>
            <span id="processTimer">00:00</span>
        </div>
    </div>

    <!-- En-t√™te avec logo et horloge -->
    <div class="header">
        <div class="header-content">
            <div class="header-left">
                <div class="logo-container">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzUwIiBoZWlnaHQ9IjEyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8IS0tIENOSU0gLSBCbGV1IC0tPgogIDxyZWN0IHg9IjAiIHk9IjQ4IiB3aWR0aD0iNTQiIGhlaWdodD0iNzIiIGZpbGw9IiMwMDY2Y2MiLz4KICA8cmVjdCB4PSI1NSIgeT0iNDgiIHdpZHRoPSI1NCIgaGVpZ2h0PSI3MiIgZmlsbD0iIzAwNjZjYyIvPgogIDxyZWN0IHg9IjU1IiB5PSI0OCIgd2lkdGg9IjI3IiBoZWlnaHQ9IjcyIiBmaWxsPSJ3aGl0ZSIvPgogIDxyZWN0IHg9IjExMCIgeT0iNDgiIHdpZHRoPSI1NCIgaGVpZ2h0PSI3MiIgZmlsbD0iIzAwNjZjYyIvPgogIDxyZWN0IHg9IjEyNCIgeT0iNDgiIHdpZHRoPSI0MCIgaGVpZ2h0PSI3MiIgZmlsbD0id2hpdGUiLz4KICA8cmVjdCB4PSIxNjUiIHk9IjQ4IiB3aWR0aD0iNTQiIGhlaWdodD0iNzIiIGZpbGw9IiMwMDY2Y2MiLz4KICA8IS0tIEJBQkNPQ0sgLSBHcmlzIC0tPgogIDx0ZXh0IHg9IjE5NSIgeT0iOTAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIzNiIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiM5OTk5OTkiPkJBQkNPQ0s8L3RleHQ+CiAgPCEtLSBNQVJPQyAtLT4KICA8dGV4dCB4PSIxOTUiIHk9IjExNSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjI4IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iIzAwNjZjYyI+TUFST0M8L3RleHQ+Cjwvc3ZnPg==" 
                         alt="CNIM BABCOCK MAROC">
                </div>
                <div class="header-title">
                    <h1>Gestion de Pointage et Planning</h1>
                    <div class="header-subtitle">
                        <span class="dept-badge">üîß D√©partement M√©thode</span>
                        <span>Suivi des heures & planification des projets</span>
                    </div>
                </div>
            </div>
            <div class="clock-container">
                <button class="theme-toggle" onclick="toggleTheme()">
                    <span>üåô</span> Mode Sombre
                </button>
                <button class="theme-toggle" onclick="toggleDensity()">
                    <span>üìè</span> Compact
                </button>
                <button class="theme-toggle" onclick="demoProcessIndicator()" style="background: linear-gradient(135deg, #ff9800, #f57c00);">
                    <span>üé¨</span> D√©mo Processus
                </button>
                <div class="clock">
                    <div class="clock-time" id="clockTime">--:--:--</div>
                    <div class="clock-date" id="clockDate">--/--/----</div>
                </div>
                <button class="btn-agenda" onclick="openAgenda()">
                    <span>üìÖ</span> Agenda
                </button>
                <button class="theme-toggle" onclick="openChangePasswordModal()" style="background: linear-gradient(135deg, #673ab7, #512da8); margin-left: 10px;">
                    <span>üîê</span> Mot de passe
                </button>
                <button class="theme-toggle" onclick="logout()" style="background: linear-gradient(135deg, #dc3545, #c82333);">
                    <span>üö™</span> D√©connexion
                </button>
            </div>
        </div>
    </div>

    <!-- Barre de recherche globale -->
    <div class="global-search">
        <div class="search-container">
            <input type="text" class="search-input" id="globalSearchInput" placeholder="üîç Rechercher (affaires, clients, agents...)">
            <div class="search-filters">
                <select class="search-filter-select" id="filterStatut" onchange="applyGlobalFilters()">
                    <option value="">Tous les statuts</option>
                    <option value="en-attente">En attente</option>
                    <option value="en-cours">En cours</option>
                    <option value="termine">Termin√©</option>
                    <option value="suspendu">Suspendu</option>
                </select>
                <select class="search-filter-select" id="filterPriorite" onchange="applyGlobalFilters()">
                    <option value="">Toutes priorit√©s</option>
                    <option value="faible">Faible</option>
                    <option value="moyenne">Moyenne</option>
                    <option value="haute">Haute</option>
                    <option value="urgente">Urgente</option>
                </select>
                <input type="date" class="search-filter-select" id="filterDateDebut" onchange="applyGlobalFilters()">
                <input type="date" class="search-filter-select" id="filterDateFin" onchange="applyGlobalFilters()">
            </div>
            <button class="btn-save-view" onclick="saveCurrentView()">üíæ Sauvegarder Vue</button>
        </div>
        <div class="saved-views" id="savedViewsContainer"></div>
    </div>

    <!-- Onglets -->
    <div class="tabs">
        <div class="tabs-container">
            <button class="tab active" onclick="switchTab('affaires')">üè¢ Affaires</button>
            <button class="tab" onclick="switchTab('journalier')">üìÖ Pointage Journalier</button>
            <button class="tab" onclick="switchTab('mensuel')">üìä Pointage Mensuel</button>
            <button class="tab" onclick="switchTab('planning')">üìÖ Planning</button>
            <button class="tab" onclick="switchTab('suivi')">üìà Suivi Budget</button>
            <button class="tab" onclick="switchTab('analytics')">üìä Analytics & KPI</button>
            <button class="tab" onclick="switchTab('rapports')">üìë Rapports</button>
            <button class="tab" onclick="switchTab('parametres')">‚öôÔ∏è Param√®tres</button>
        </div>
    </div>

    <!-- Contenu principal -->
    <div class="main-content">
        <!-- Onglet Affaires -->
        <div id="tab-affaires" class="tab-content active">
            <div class="affaires-layout">
                <!-- Contenu principal -->
                <div class="affaires-main">
                    <!-- Section 1: S√©lectionner une Affaire -->
                    <div class="card">
                        <div class="card-title">
                            <span>üîç S√©lectionner une Affaire</span>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-weight: 600; margin-bottom: 8px;">Affaire</label>
                            <select class="form-control" id="affaireSelectionnee" onchange="afficherResumeAffaire()" style="font-size: 14px;">
                                <option value="">-- Choisir une affaire --</option>
                            </select>
                        </div>
                        
                        <!-- R√©sum√© de l'affaire -->
                        <div id="resumeAffaire" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #0066cc;">
                            <h4 style="margin: 0 0 15px 0; color: #0066cc; font-size: 14px; font-weight: 600;">R√©sum√© de l'affaire</h4>
                            <div style="display: grid; gap: 10px; font-size: 13px;">
                                <div><strong>Client:</strong> <span id="resumeClient">-</span></div>
                                <div><strong>D√©signation:</strong> <span id="resumeDesignation">-</span></div>
                                <div><strong>Responsable:</strong> <span id="resumeResponsable">-</span></div>
                                <div><strong>Date fin pr√©vue:</strong> <span id="resumeDateFin">-</span></div>
                                <div>
                                    <strong>Avancement Global:</strong><br>
                                    <div style="margin-top: 5px; background: #e9ecef; border-radius: 10px; height: 20px; overflow: hidden; position: relative;">
                                        <div id="resumeProgressBar" style="height: 100%; background: linear-gradient(90deg, #0066cc, #4d94ff); transition: width 0.3s; width: 0%;"></div>
                                    </div>
                                    <span id="resumeProgressText" style="font-size: 12px; color: #666;">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 2: Nouvelle Sous-T√¢che -->
                    <div class="card">
                        <div class="card-title">
                            <span>‚ûï Nouvelle Sous-T√¢che</span>
                        </div>
                        <form id="formSousTache" onsubmit="ajouterSousTache(event)">
                            <div class="form-group">
                                <label>Type de dossier</label>
                                <select class="form-control" id="typeSousTache" required>
                                    <option value="">Choisir le type...</option>
                                    <option value="expression-besoin">Expression de besoin</option>
                                    <option value="preparation-dossier">Pr√©paration dossier</option>
                                    <option value="achat-matiere">Achat mati√®re</option>
                                    <option value="chassis-transport">Ch√¢ssis transport</option>
                                    <option value="liste-colisage">Liste de colisage</option>
                                    <option value="mise-camion">Mise en camion</option>
                                    <option value="schema">Sch√©ma</option>
                                    <option value="epreuve-hydraulique">√âpreuve hydraulique</option>
                                    <option value="etude">√âtude</option>
                                    <option value="fabrication">Fabrication</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Description</label>
                                <textarea class="form-control" id="descriptionSousTache" rows="3" required placeholder="D√©crivez la sous-t√¢che..."></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>Responsable</label>
                                <select class="form-control" id="responsableSousTache" required>
                                    <option value="">Choisir un agent...</option>
                                </select>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date d√©but</label>
                                    <input type="date" class="form-control" id="dateDebutSousTache" required>
                                </div>
                                <div class="form-group">
                                    <label>Date fin pr√©vue</label>
                                    <input type="date" class="form-control" id="dateFinSousTache" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Priorit√©</label>
                                <select class="form-control" id="prioriteSousTache" required>
                                    <option value="basse">üü¢ Basse</option>
                                    <option value="normale" selected>üü° Moyenne</option>
                                    <option value="haute">üü† Haute</option>
                                    <option value="urgente">üî¥ Urgente</option>
                                </select>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px; font-size: 15px; font-weight: 600;">
                                üìã Ajouter la Sous-T√¢che
                            </button>
                        </form>
                    </div>

                    <!-- Section 3: Formulaire Nouvelle Affaire (modal style) -->
                    <div class="card" style="border: 2px dashed #0066cc;">
                        <div class="card-title" style="background: linear-gradient(135deg, #0066cc, #003d7a); color: white;">
                            <span>‚ûï Cr√©er une Nouvelle Affaire</span>
                        </div>
                        <form id="formAffaire" onsubmit="ajouterAffaire(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>N¬∞ Affaire</label>
                                    <input type="text" class="form-control" id="numAffaire" required placeholder="Ex: B8701">
                                </div>
                                <div class="form-group">
                                    <label>Ann√©e</label>
                                    <input type="number" class="form-control" id="anneeAffaire" value="2025" required readonly style="background: #f8f9fa;">
                                </div>
                                <div class="form-group">
                                    <label>Client</label>
                                    <input type="text" class="form-control" id="clientAffaire" required placeholder="Nom du client">
                                </div>
                                <div class="form-group">
                                    <label>D√©signation</label>
                                    <input type="text" class="form-control" id="designationAffaire" required placeholder="Description du projet">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Affect√© √†</label>
                                    <select class="form-control" id="agentAssigne" required>
                                        <option value="">Choisir un agent...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Date Affectation</label>
                                    <input type="date" class="form-control" id="dateDebut" required>
                                </div>
                                <div class="form-group">
                                    <label>Date fin pr√©vue</label>
                                    <input type="date" class="form-control" id="dateFin" required>
                                </div>
                                <div class="form-group">
                                    <label>Budget MLP (H)</label>
                                    <input type="number" class="form-control" id="budgetHeures" min="0" step="0.5" required placeholder="Heures">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Budget (‚Ç¨)</label>
                                    <input type="number" class="form-control" id="budgetEuros" min="0" step="100" placeholder="Budget en euros">
                                </div>
                                <div class="form-group">
                                    <label>√âtat d'avancement</label>
                                    <select class="form-control" id="statutAffaire" required style="font-weight: 600;">
                                        <option value="en-attente">‚è∏Ô∏è En attente</option>
                                        <option value="en-cours" selected>‚ñ∂Ô∏è En cours</option>
                                        <option value="termine">‚úÖ Termin√©</option>
                                        <option value="suspendu">‚èπÔ∏è Suspendu</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Priorit√©</label>
                                    <select class="form-control" id="priorite" required style="font-weight: 600;">
                                        <option value="faible">‚¨áÔ∏è Faible</option>
                                        <option value="moyenne" selected>‚û°Ô∏è Moyenne</option>
                                        <option value="haute">‚¨ÜÔ∏è Haute</option>
                                        <option value="urgente">üî¥ Urgente</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Champs cach√©s pour compatibilit√© -->
                            <input type="hidden" id="sousTache" value="">
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="submit" class="btn btn-primary" style="flex: 1;">
                                    <span style="font-size: 16px;">üíæ</span> Enregistrer l'Affaire
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('formAffaire').reset();">
                                    Annuler
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- TABLEAU DES AFFAIRES PRINCIPALES -->
                    <div class="card" style="box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: none;">
                        <div class="card-title" style="background: linear-gradient(135deg, #0066cc, #003d7a); color: white; padding: 20px; margin: -20px -20px 20px -20px; border-radius: 8px 8px 0 0; box-shadow: 0 3px 8px rgba(0,102,204,0.3);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                        <span style="font-size: 24px;">üè¢</span>
                                    </div>
                                    <div>
                                        <div style="font-size: 20px; font-weight: 700; letter-spacing: 0.5px;">Affaires Principales</div>
                                        <div style="font-size: 12px; opacity: 0.9; margin-top: 2px;">Gestion des projets clients</div>
                                    </div>
                                </div>
                                <button class="btn" onclick="exporterAffairesExcel()" style="background: white; color: #0066cc; font-weight: 600; padding: 10px 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.1)';">
                                    üìä Exporter Excel
                                </button>
                            </div>
                        </div>
                        
                        <div style="overflow-x: auto; margin: -10px;">
                            <table class="table" id="tableauAffairesPrincipales" style="margin: 0; border-collapse: separate; border-spacing: 0;">
                                <thead>
                                    <tr style="background: linear-gradient(to bottom, #f8f9fa, #e9ecef);">
                                        <th style="padding: 15px 12px; font-weight: 700; color: #2c3e50; border-bottom: 3px solid #0066cc; text-align: left; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;">N¬∞ Affaire</th>
                                        <th style="padding: 15px 12px; font-weight: 700; color: #2c3e50; border-bottom: 3px solid #0066cc; text-align: center; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Ann√©e</th>
                                        <th style="padding: 15px 12px; font-weight: 700; color: #2c3e50; border-bottom: 3px solid #0066cc; text-align: left; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; min-width: 150px;">Client</th>
                                        <th style="padding: 15px 12px; font-weight: 700; color: #2c3e50; border-bottom: 3px solid #0066cc; text-align: left; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; min-width: 200px;">D√©signation</th>
                                        <th style="padding: 15px 12px; font-weight: 700; color: #2c3e50; border-bottom: 3px solid #0066cc; text-align: left; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Responsable</th>
                                        <th style="padding: 15px 12px; font-weight: 700; color: #2c3e50; border-bottom: 3px solid #0066cc; text-align: center; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Date d√©but</th>
                                        <th style="padding: 15px 12px; font-weight: 700; color: #2c3e50; border-bottom: 3px solid #0066cc; text-align: center; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Date fin</th>
                                        <th style="padding: 15px 12px; font-weight: 700; color: #2c3e50; border-bottom: 3px solid #0066cc; text-align: right; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Budget (‚Ç¨)</th>
                                        <th style="padding: 15px 12px; font-weight: 700; color: #2c3e50; border-bottom: 3px solid #0066cc; text-align: right; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Budget (h)</th>
                                        <th style="padding: 15px 12px; font-weight: 700; color: #2c3e50; border-bottom: 3px solid #0066cc; text-align: center; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Sous-t√¢ches</th>
                                        <th style="padding: 15px 12px; font-weight: 700; color: #2c3e50; border-bottom: 3px solid #0066cc; text-align: center; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; min-width: 180px;">Avancement</th>
                                        <th style="padding: 15px 12px; font-weight: 700; color: #2c3e50; border-bottom: 3px solid #0066cc; text-align: center; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="listeAffairesPrincipales">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- TABLEAU DES SOUS-T√ÇCHES -->
                    <div class="card" style="box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: none;">
                        <div class="card-title" style="background: linear-gradient(135deg, #27ae60, #229954); color: white; padding: 20px; margin: -20px -20px 20px -20px; border-radius: 8px 8px 0 0; box-shadow: 0 3px 8px rgba(39,174,96,0.3);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                        <span style="font-size: 24px;">üìã</span>
                                    </div>
                                    <div>
                                        <div style="font-size: 20px; font-weight: 700; letter-spacing: 0.5px;">Sous-T√¢ches</div>
                                        <div style="font-size: 12px; opacity: 0.9; margin-top: 2px;">D√©tail des t√¢ches par affaire</div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <select class="form-control" id="filtreSousTaches" onchange="afficherSousTaches()" style="width: 280px; background: white; color: #2c3e50; border: 2px solid rgba(255,255,255,0.3); padding: 8px 12px; border-radius: 8px; font-weight: 500;">
                                        <option value="">üìÇ Toutes les affaires</option>
                                    </select>
                                    <button class="btn" onclick="exporterSousTachesExcel()" style="background: white; color: #27ae60; font-weight: 600; padding: 10px 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.1)';">
                                        üìä Exporter Excel
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div style="overflow-x: auto; margin: -10px;">
                            <table class="table" id="tableauSousTaches" style="margin: 0; border-collapse: separate; border-spacing: 0;">
                                <thead>
                                    <tr style="background: linear-gradient(to bottom, #f8f9fa, #e9ecef);">
                                        <th style="padding: 15px 12px; font-weight: 700; color: #2c3e50; border-bottom: 3px solid #27ae60; text-align: left; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;">N¬∞ Affaire</th>
                                        <th style="padding: 15px 12px; font-weight: 700; color: #2c3e50; border-bottom: 3px solid #27ae60; text-align: left; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Type</th>
                                        <th style="padding: 15px 12px; font-weight: 700; color: #2c3e50; border-bottom: 3px solid #27ae60; text-align: left; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; min-width: 250px;">Description</th>
                                        <th style="padding: 15px 12px; font-weight: 700; color: #2c3e50; border-bottom: 3px solid #27ae60; text-align: left; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Responsable</th>
                                        <th style="padding: 15px 12px; font-weight: 700; color: #2c3e50; border-bottom: 3px solid #27ae60; text-align: center; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Date d√©but</th>
                                        <th style="padding: 15px 12px; font-weight: 700; color: #2c3e50; border-bottom: 3px solid #27ae60; text-align: center; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Date fin</th>
                                        <th style="padding: 15px 12px; font-weight: 700; color: #2c3e50; border-bottom: 3px solid #27ae60; text-align: center; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Priorit√©</th>
                                        <th style="padding: 15px 12px; font-weight: 700; color: #2c3e50; border-bottom: 3px solid #27ae60; text-align: center; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Statut</th>
                                        <th style="padding: 15px 12px; font-weight: 700; color: #2c3e50; border-bottom: 3px solid #27ae60; text-align: center; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; min-width: 160px;">Avancement</th>
                                        <th style="padding: 15px 12px; font-weight: 700; color: #2c3e50; border-bottom: 3px solid #27ae60; text-align: right; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Heures</th>
                                        <th style="padding: 15px 12px; font-weight: 700; color: #2c3e50; border-bottom: 3px solid #27ae60; text-align: center; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="listeSousTaches">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">
                            üìä Vue Kanban (Sous-t√¢ches)
                        </div>
                        
                        <div class="kanban-board">
                            <div class="kanban-column" data-status="en-attente">
                                <div class="kanban-header">
                                    <h3>‚è∏Ô∏è En attente</h3>
                                    <span class="kanban-count" id="count-en-attente">0</span>
                                </div>
                                <div class="kanban-cards" id="kanban-en-attente"></div>
                            </div>
                            <div class="kanban-column" data-status="en-cours">
                                <div class="kanban-header">
                                    <h3>‚ñ∂Ô∏è En cours</h3>
                                    <span class="kanban-count" id="count-en-cours">0</span>
                                </div>
                                <div class="kanban-cards" id="kanban-en-cours"></div>
                            </div>
                            <div class="kanban-column" data-status="termine">
                                <div class="kanban-header">
                                    <h3>‚úÖ Termin√©</h3>
                                    <span class="kanban-count" id="count-termine">0</span>
                                </div>
                                <div class="kanban-cards" id="kanban-termine"></div>
                            </div>
                            <div class="kanban-column" data-status="suspendu">
                                <div class="kanban-header">
                                    <h3>‚èπÔ∏è Suspendu</h3>
                                    <span class="kanban-count" id="count-suspendu">0</span>
                                </div>
                                <div class="kanban-cards" id="kanban-suspendu"></div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">
                            <span>üìä Vue par Affaire</span>
                        </div>
                        <div id="vueParAffaire"></div>
                    </div>

                    <div class="card">
                        <div class="card-title">üìä Synth√®se</div>
                        <div class="stats-grid" id="syntheseAffaires"></div>
                    </div>
                </div>

                <!-- Colonne lat√©rale des retards -->
                <div class="affaires-sidebar">
                    <div class="card retards-card">
                        <div class="card-title">
                            <span>‚ö†Ô∏è Retards</span>
                            <span class="badge badge-danger" id="countRetards">0</span>
                        </div>
                        <div id="listeRetards"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Onglet Pointage Journalier -->
        <div id="tab-journalier" class="tab-content">
            <div class="card">
                <div class="card-title" style="background: linear-gradient(135deg, #2c3e50, #34495e); color: white;">
                    <span>‚è∞ Pointage Journalier (simplifi√©)</span>
                </div>
                
                <!-- Contr√¥les -->
                <div class="journalier-controls" style="padding: 20px; background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                    <div class="form-row">
                        <div class="form-group">
                            <label style="font-weight: 600; color: #2c3e50;">Agent</label>
                            <select id="agentJournalier" class="form-control" onchange="afficherPointageJournalierSimple()" required>
                                <option value="">S√©lectionner un agent...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #2c3e50;">Mois</label>
                            <select id="moisJournalier" class="form-control" onchange="afficherPointageJournalierSimple()">
                                <option value="0">Janvier</option>
                                <option value="1">F√©vrier</option>
                                <option value="2">Mars</option>
                                <option value="3">Avril</option>
                                <option value="4">Mai</option>
                                <option value="5">Juin</option>
                                <option value="6">Juillet</option>
                                <option value="7">Ao√ªt</option>
                                <option value="8">Septembre</option>
                                <option value="9">Octobre</option>
                                <option value="10">Novembre</option>
                                <option value="11">D√©cembre</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #2c3e50;">Ann√©e</label>
                            <select id="anneeJournalier" class="form-control" onchange="afficherPointageJournalierSimple()">
                                <option value="2023">2023</option>
                                <option value="2024">2024</option>
                                <option value="2025" selected>2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                        <div class="form-group" style="display: flex; gap: 10px; align-items: flex-end;">
                            <button class="btn btn-primary" onclick="afficherPointageJournalierSimple()" style="flex: 1;">
                                üìä G√©n√©rer
                            </button>
                            <button class="btn btn-success" onclick="enregistrerPointageJournalierSimple()" style="flex: 1;">
                                üíæ Enregistrer
                            </button>
                            <button class="btn btn-danger" onclick="exporterJournalierPDF()">
                                üìÑ PDF
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Grille de pointage -->
                <div id="grilleJournaliereSimple" style="overflow-x: auto; padding: 20px;"></div>
            </div>
        </div>

        <!-- Onglet Pointage Mensuel -->
        <div id="tab-mensuel" class="tab-content">
            <div class="card">
                <div class="card-title">
                    <span>üìä Pointage Mensuel</span>
                    <div>
                        <button class="btn btn-success btn-small" onclick="exporterExcel()">ÔøΩ Export Excel (.xlsx)</button>
                        <button class="btn btn-danger btn-small" onclick="exporterPDF()">ÔøΩ Export PDF</button>
                    </div>
                </div>
                
                <!-- S√©lecteurs -->
                <div class="mensuel-controls">
                    <div class="form-row" style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Mois</label>
                            <select id="moisMensuel" class="form-control" onchange="afficherPointageMensuel()">
                                <option value="0">Janvier</option>
                                <option value="1">F√©vrier</option>
                                <option value="2">Mars</option>
                                <option value="3">Avril</option>
                                <option value="4">Mai</option>
                                <option value="5">Juin</option>
                                <option value="6">Juillet</option>
                                <option value="7">Ao√ªt</option>
                                <option value="8">Septembre</option>
                                <option value="9">Octobre</option>
                                <option value="10">Novembre</option>
                                <option value="11">D√©cembre</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ann√©e</label>
                            <select id="anneeMensuel" class="form-control" onchange="afficherPointageMensuel()">
                                <option value="2023">2023</option>
                                <option value="2024">2024</option>
                                <option value="2025" selected>2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Filtrer par agent</label>
                            <select id="agentMensuel" class="form-control" onchange="afficherPointageMensuel()">
                                <option value="">Tous les agents</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Filtrer par affaire</label>
                            <select id="affaireMensuel" class="form-control" onchange="afficherPointageMensuel()">
                                <option value="">Toutes les affaires</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Grille mensuelle -->
                <div id="grilleMensuelle"></div>
                
                <!-- Synth√®se √©carts -->
                <div class="card" style="margin-top: 20px; background: #f8f9fa;">
                    <div class="card-title">üìà Synth√®se des √©carts (R√©alis√© vs Budget)</div>
                    <div id="syntheseEcarts"></div>
                </div>
            </div>
        </div>

        <!-- Onglet Planning -->
        <div id="tab-planning" class="tab-content">
            <div class="card">
                <div class="card-title">
                    <span>üìÖ Diagramme de Gantt</span>
                    <div>
                        <button class="btn btn-info btn-small" onclick="ouvrirModalDependances()">üîó G√©rer D√©pendances</button>
                        <button class="btn btn-warning btn-small" onclick="ouvrirModalBaseline()">üìà Baseline</button>
                        <button class="btn btn-danger btn-small" onclick="exporterGanttPDF()">üìï Export PDF</button>
                        <button class="btn btn-secondary btn-small" onclick="rafraichirGantt()">üîÑ Rafra√Æchir</button>
                    </div>
                </div>
                
                <!-- Contr√¥les du Gantt -->
                <div class="gantt-controls">
                    <div class="control-group">
                        <label>√âchelle temporelle :</label>
                        <select id="ganttEchelle" class="form-control" onchange="changerEchelleGantt()" style="width: auto;">
                            <option value="jours">Par jours</option>
                            <option value="semaines" selected>Par semaines</option>
                            <option value="mois">Par mois</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label>Zoom :</label>
                        <button class="btn btn-secondary btn-small" onclick="zoomGantt(-1)">üîç‚àí</button>
                        <span id="zoomLevel" style="margin: 0 10px; font-weight: 600;">100%</span>
                        <button class="btn btn-secondary btn-small" onclick="zoomGantt(1)">üîç+</button>
                    </div>
                    
                    <div class="control-group">
                        <label>Filtrer par priorit√© :</label>
                        <select id="ganttFiltrePriorite" class="form-control" onchange="afficherGantt()" style="width: auto;">
                            <option value="toutes">Toutes</option>
                            <option value="urgente">üî¥ Urgente</option>
                            <option value="haute">üü† Haute</option>
                            <option value="normale">üü° Normale</option>
                            <option value="basse">üü¢ Basse</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label>Filtrer par statut :</label>
                        <select id="ganttFiltreStatut" class="form-control" onchange="afficherGantt()" style="width: auto;">
                            <option value="tous">Tous</option>
                            <option value="en-attente">En attente</option>
                            <option value="en-cours">En cours</option>
                            <option value="termine">Termin√©</option>
                            <option value="suspendu">Suspendu</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="afficherCheminCritique" onchange="afficherGantt()">
                            <span>Chemin critique</span>
                        </label>
                    </div>

                    <div class="control-group">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="afficherBaseline" onchange="afficherGantt()">
                            <span>Afficher Baseline</span>
                        </label>
                    </div>
                </div>
                
                <div class="gantt-wrapper">
                    <div class="gantt-container" id="ganttContainer"></div>
                </div>
                
                <!-- L√©gende -->
                <div class="gantt-legend">
                    <div class="legend-title">L√©gende :</div>
                    <div class="legend-items">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #28a745;"></div>
                            <span>0-50%</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ffc107;"></div>
                            <span>50-80%</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #fd7e14;"></div>
                            <span>80-100%</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #dc3545;"></div>
                            <span>&gt;100%</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #6c757d;"></div>
                            <span>Termin√©</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #e74c3c; border: 3px solid #c0392b;"></div>
                            <span>Chemin critique</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: rgba(102, 126, 234, 0.2); border: 2px dashed #667eea;"></div>
                            <span>Baseline</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Onglet Suivi Budget -->
        <div id="tab-suivi" class="tab-content">
            <div class="card">
                <div class="card-title">üìà Rapprochement Budget vs R√©alis√©</div>
                
                <div class="form-row" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label>Filtrer par affaire</label>
                        <select id="suiviAffaire" class="form-control" onchange="afficherSuiviBudget()">
                            <option value="">Toutes les affaires</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Filtrer par agent</label>
                        <select id="suiviAgent" class="form-control" onchange="afficherSuiviBudget()">
                            <option value="">Tous les agents</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Seuil d'alerte (%)</label>
                        <input type="number" id="suiviSeuil" class="form-control" value="80" min="0" max="100" onchange="afficherSuiviBudget()">
                    </div>
                </div>
                
                <div id="suiviBudgetContainer"></div>
            </div>
        </div>

        <!-- Onglet Analytics & KPI -->
        <div id="tab-analytics" class="tab-content">
            <!-- KPI Cards -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <!-- KPI 1: Total Heures -->
                <div class="kpi-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); animation: scaleIn 0.5s ease-out;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">Total Heures Travaill√©es</div>
                            <div id="kpiTotalHeures" style="font-size: 36px; font-weight: 700;">0h</div>
                            <div id="kpiTotalHeuresEvolution" style="font-size: 12px; margin-top: 8px; opacity: 0.9;">
                                üìà +0% vs mois dernier
                            </div>
                        </div>
                        <div style="font-size: 40px; opacity: 0.3;">‚è±Ô∏è</div>
                    </div>
                </div>

                <!-- KPI 2: Projets Actifs -->
                <div class="kpi-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3); animation: scaleIn 0.5s ease-out 0.1s backwards;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">Projets Actifs</div>
                            <div id="kpiProjetsActifs" style="font-size: 36px; font-weight: 700;">0</div>
                            <div id="kpiProjetsDetails" style="font-size: 12px; margin-top: 8px; opacity: 0.9;">
                                üéØ 0 en cours
                            </div>
                        </div>
                        <div style="font-size: 40px; opacity: 0.3;">üè¢</div>
                    </div>
                </div>

                <!-- KPI 3: Taux de Compl√©tion -->
                <div class="kpi-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3); animation: scaleIn 0.5s ease-out 0.2s backwards;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">Taux de Compl√©tion</div>
                            <div id="kpiTauxCompletion" style="font-size: 36px; font-weight: 700;">0%</div>
                            <div style="font-size: 12px; margin-top: 8px; opacity: 0.9;">
                                üìä Budget global
                            </div>
                        </div>
                        <div style="font-size: 40px; opacity: 0.3;">üìà</div>
                    </div>
                </div>

                <!-- KPI 4: Agents Actifs -->
                <div class="kpi-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3); animation: scaleIn 0.5s ease-out 0.3s backwards;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">Agents Actifs</div>
                            <div id="kpiAgentsActifs" style="font-size: 36px; font-weight: 700;">0</div>
                            <div id="kpiAgentsDetails" style="font-size: 12px; margin-top: 8px; opacity: 0.9;">
                                üë• Total agents
                            </div>
                        </div>
                        <div style="font-size: 40px; opacity: 0.3;">üë§</div>
                    </div>
                </div>
            </div>

            <!-- Graphiques et Analyses -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <!-- Graphique: Distribution des Heures par Projet -->
                <div class="card" style="animation: fadeIn 0.6s ease-out 0.4s backwards;">
                    <div class="card-title">üìä Distribution des Heures par Projet</div>
                    <canvas id="chartHeuresParProjet" style="max-height: 300px;"></canvas>
                    <div id="distributionLegend" style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 15px; font-size: 13px;"></div>
                </div>

                <!-- Graphique: √âvolution Mensuelle -->
                <div class="card" style="animation: fadeIn 0.6s ease-out 0.5s backwards;">
                    <div class="card-title">üìà √âvolution des Heures (6 derniers mois)</div>
                    <canvas id="chartEvolutionMensuelle" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <!-- Graphiques suppl√©mentaires -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <!-- Graphique: Top Agents -->
                <div class="card" style="animation: fadeIn 0.6s ease-out 0.6s backwards;">
                    <div class="card-title">üèÜ Top 10 Agents par Heures</div>
                    <canvas id="chartTopAgents" style="max-height: 350px;"></canvas>
                </div>

                <!-- Graphique: Budget vs R√©alis√© -->
                <div class="card" style="animation: fadeIn 0.6s ease-out 0.7s backwards;">
                    <div class="card-title">üí∞ Budget vs R√©alis√© par Projet</div>
                    <canvas id="chartBudgetRealise" style="max-height: 350px;"></canvas>
                </div>
            </div>

            <!-- Tableau de Performance -->
            <div class="card" style="animation: fadeIn 0.6s ease-out 0.8s backwards;">
                <div class="card-title">
                    üìã Performance D√©taill√©e par Projet
                    <button class="btn btn-primary btn-small" onclick="exportAnalytics()">üì• Exporter</button>
                </div>
                <div id="tableauPerformance"></div>
            </div>
        </div>

        <!-- Onglet Rapports -->
        <div id="tab-rapports" class="tab-content">
            <div class="card">
                <div class="card-title">üìë G√©n√©ration de Rapports</div>
                <p style="color: #666; margin-bottom: 20px;">
                    <strong>‚ÑπÔ∏è Fonctionnalit√© en d√©veloppement :</strong> Les options de g√©n√©ration et d'export de rapports seront disponibles prochainement.
                </p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <!-- Rapport Mensuel Global -->
                    <div style="border: 1px solid #007bff; border-radius: 8px; padding: 20px; background: linear-gradient(to bottom, #f8f9fa, #ffffff);">
                        <h3 style="margin: 0 0 10px 0; color: #007bff; display: flex; align-items: center; gap: 8px;">
                            üìä Rapport Mensuel Global
                        </h3>
                        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                            Synth√®se compl√®te de tous les agents et affaires pour un mois donn√©.
                        </p>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <label style="font-weight: 600;">Mois :</label>
                            <input type="month" id="rapportMoisGlobal" class="form-control" disabled>
                            <button class="btn btn-primary" disabled style="opacity: 0.6;">
                                üìÑ G√©n√©rer (bient√¥t disponible)
                            </button>
                        </div>
                    </div>
                    
                    <!-- Rapport par Agent -->
                    <div style="border: 1px solid #28a745; border-radius: 8px; padding: 20px; background: linear-gradient(to bottom, #f8f9fa, #ffffff);">
                        <h3 style="margin: 0 0 10px 0; color: #28a745; display: flex; align-items: center; gap: 8px;">
                            üë§ Rapport par Agent
                        </h3>
                        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                            D√©tail de l'activit√© d'un agent sp√©cifique pour un mois donn√©.
                        </p>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <label style="font-weight: 600;">Agent :</label>
                            <select id="rapportAgent" class="form-control" disabled>
                                <option value="">-- Choisir un agent --</option>
                            </select>
                            <label style="font-weight: 600;">Mois :</label>
                            <input type="month" id="rapportMoisAgent" class="form-control" disabled>
                            <button class="btn btn-success" disabled style="opacity: 0.6;">
                                üìÑ G√©n√©rer (bient√¥t disponible)
                            </button>
                        </div>
                    </div>
                    
                    <!-- Rapport par Affaire -->
                    <div style="border: 1px solid #ffc107; border-radius: 8px; padding: 20px; background: linear-gradient(to bottom, #f8f9fa, #ffffff);">
                        <h3 style="margin: 0 0 10px 0; color: #e0a800; display: flex; align-items: center; gap: 8px;">
                            üè¢ Rapport par Affaire
                        </h3>
                        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                            Analyse d√©taill√©e d'une affaire : budget, r√©alis√©, avancement, d√©lais.
                        </p>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <label style="font-weight: 600;">Affaire :</label>
                            <select id="rapportAffaire" class="form-control" disabled>
                                <option value="">-- Choisir une affaire --</option>
                            </select>
                            <label style="font-weight: 600;">P√©riode (optionnel) :</label>
                            <input type="month" id="rapportMoisAffaire" class="form-control" disabled>
                            <button class="btn btn-warning" disabled style="opacity: 0.6;">
                                üìÑ G√©n√©rer (bient√¥t disponible)
                            </button>
                        </div>
                    </div>
                    
                    <!-- Rapport Annuel -->
                    <div style="border: 1px solid #6f42c1; border-radius: 8px; padding: 20px; background: linear-gradient(to bottom, #f8f9fa, #ffffff);">
                        <h3 style="margin: 0 0 10px 0; color: #6f42c1; display: flex; align-items: center; gap: 8px;">
                            üìÜ Rapport Annuel
                        </h3>
                        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                            Bilan complet de l'ann√©e : performances, tendances, statistiques.
                        </p>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <label style="font-weight: 600;">Ann√©e :</label>
                            <input type="number" id="rapportAnnee" class="form-control" min="2020" max="2100" value="2025" disabled>
                            <button class="btn" style="background: #6f42c1; color: white; opacity: 0.6;" disabled>
                                üìÑ G√©n√©rer (bient√¥t disponible)
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Options d'export -->
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; background: #f8f9fa;">
                    <h3 style="margin: 0 0 15px 0; color: #333;">üì§ Options d'Export</h3>
                    <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                        Une fois le rapport g√©n√©r√©, vous pourrez l'exporter aux formats suivants :
                    </p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-danger" disabled style="opacity: 0.6; display: flex; align-items: center; gap: 8px;">
                            <span>üìï</span> Export PDF
                        </button>
                        <button class="btn btn-success" disabled style="opacity: 0.6; display: flex; align-items: center; gap: 8px;">
                            <span>üìó</span> Export Excel
                        </button>
                        <button class="btn btn-secondary" disabled style="opacity: 0.6; display: flex; align-items: center; gap: 8px;">
                            <span>üìß</span> Envoyer par email
                        </button>
                        <button class="btn btn-primary" disabled style="opacity: 0.6; display: flex; align-items: center; gap: 8px;">
                            <span>üñ®Ô∏è</span> Imprimer
                        </button>
                    </div>
                </div>
                
                <!-- Zone d'aper√ßu (future) -->
                <div id="rapportApercu" style="display: none; border: 1px solid #ddd; border-radius: 8px; padding: 20px; background: white; margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">üìã Aper√ßu du Rapport</h3>
                        <button class="btn btn-secondary btn-small" onclick="fermerApercuRapport()">‚úï Fermer</button>
                    </div>
                    <div id="rapportContenu" style="max-height: 600px; overflow-y: auto; border-top: 1px solid #ddd; padding-top: 15px;">
                        <!-- Le contenu du rapport sera g√©n√©r√© ici -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Onglet Param√®tres -->
        <div id="tab-parametres" class="tab-content">
            <div class="card">
                <div class="card-title">
                    <span>üë• Gestion des Agents</span>
                    <button class="btn btn-primary btn-small" onclick="ouvrirModalAgent()">‚ûï Nouvel Agent</button>
                </div>
                <div id="listeAgents" style="margin-top: 20px;"></div>
            </div>

            <div class="card">
                <div class="card-title">
                    <span>üíæ Gestion des Donn√©es</span>
                    <div>
                        <button class="btn btn-success btn-small" onclick="exporterDonnees()">üì• Exporter JSON</button>
                        <button class="btn btn-info btn-small" onclick="exporterDonneesExcel()">üìó Exporter Excel</button>
                        <button class="btn btn-secondary btn-small" onclick="document.getElementById('importFile').click()">üì§ Importer</button>
                        <button class="btn btn-danger btn-small" onclick="reinitialiserDonnees()">üóëÔ∏è R√©initialiser</button>
                    </div>
                </div>
                <input type="file" id="importFile" style="display: none;" accept=".json" onchange="importerDonnees(event)">
                
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px; border-left: 4px solid #17a2b8;">
                    <h4 style="margin: 0 0 10px 0; color: #17a2b8;">‚ÑπÔ∏è Informations</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #666;">
                        <li><strong>Exporter JSON</strong> : Sauvegarde compl√®te de toutes les donn√©es (agents, sous-t√¢ches, pointages)</li>
                        <li><strong>Exporter Excel</strong> : Export format√© des donn√©es pour analyse dans Excel</li>
                        <li><strong>Importer</strong> : Restaure les donn√©es depuis un fichier JSON</li>
                        <li><strong>R√©initialiser</strong> : Supprime toutes les donn√©es et recharge les donn√©es de d√©monstration</li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <div class="card-title">‚öôÔ∏è Configuration M√©tier</div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Heures par Jour Complet (J)</label>
                        <input type="number" class="form-control" id="configHeuresJour" value="8" min="1" max="12" step="0.5">
                    </div>
                    <div class="form-group">
                        <label>Heures par Demi-Journ√©e (D)</label>
                        <input type="number" class="form-control" id="configHeuresDemi" value="4" min="1" max="8" step="0.5">
                    </div>
                    <div class="form-group">
                        <label>Ann√©e en cours</label>
                        <input type="number" class="form-control" id="configAnnee" value="2025" min="2020" max="2050">
                    </div>
                </div>

                <div class="form-group">
                    <label>Jours f√©ri√©s Maroc (dates au format YYYY-MM-DD, s√©par√©es par des virgules)</label>
                    <textarea class="form-control" id="configJoursFeries" rows="3" placeholder="2025-01-01,2025-05-01,2025-07-30..."></textarea>
                    <small style="color: #666; display: block; margin-top: 5px;">
                        Exemples : Jour de l'An, F√™te du Travail, F√™te du Tr√¥ne, A√Ød al-Fitr, A√Ød al-Adha, Anniversaire du Roi, Marche Verte, Jour de l'Ind√©pendance
                    </small>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="configModeRamadan">
                        <span>Mode Ramadan (horaires r√©duits)</span>
                    </label>
                    <small style="color: #666; display: block; margin-top: 5px;">
                        Si activ√©, les horaires seront automatiquement r√©duits pendant le mois de Ramadan
                    </small>
                </div>

                <div id="ramadanConfig" style="display: none; margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                    <h4 style="margin: 0 0 10px 0; color: #856404;">üåô Configuration Ramadan</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Heures par jour (Ramadan)</label>
                            <input type="number" class="form-control" id="configHeuresRamadan" value="6" min="1" max="8" step="0.5">
                        </div>
                        <div class="form-group">
                            <label>Date d√©but Ramadan</label>
                            <input type="date" class="form-control" id="configRamadanDebut">
                        </div>
                        <div class="form-group">
                            <label>Date fin Ramadan</label>
                            <input type="date" class="form-control" id="configRamadanFin">
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="sauvegarderConfiguration()" style="margin-top: 15px;">
                    üíæ Sauvegarder Configuration
                </button>
            </div>
            
            <div class="card">
                <div class="card-title">üìä Statistiques</div>
                <div id="statistiquesGenerales" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <!-- Les statistiques seront g√©n√©r√©es ici -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Agenda -->
    <div id="modalAgenda" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìÖ Agenda des t√¢ches</h2>
                <button class="modal-close" onclick="closeAgenda()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Filtrer par date</label>
                    <input type="date" class="form-control" id="dateAgenda" onchange="afficherAgenda()">
                </div>
                <div id="agendaContent"></div>
            </div>
        </div>
    </div>

    <!-- Modal Agent -->
    <div id="modalAgent" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="modalAgentTitre">‚ûï Ajouter un Agent</h2>
                <button class="modal-close" onclick="fermerModalAgent()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formAgent" onsubmit="sauvegarderAgent(event)">
                    <input type="hidden" id="agentIdEdit" value="">
                    
                    <div class="form-group">
                        <label>Nom de l'agent <span style="color: red;">*</span></label>
                        <input type="text" class="form-control" id="nomAgent" required placeholder="Ex: Jean Dupont">
                    </div>
                    
                    <div class="form-group">
                        <label>Fonction <span style="color: red;">*</span></label>
                        <input type="text" class="form-control" id="fonctionAgent" required placeholder="Ex: Ing√©nieur, Technicien...">
                    </div>
                    
                    <div class="form-group">
                        <label>Email (optionnel)</label>
                        <input type="email" class="form-control" id="emailAgent" placeholder="email@exemple.com">
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="fermerModalAgent()">Annuler</button>
                        <button type="submit" class="btn btn-primary">üíæ Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal D√©pendances -->
    <div id="modalDependances" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>üîó Gestion des D√©pendances</h2>
                <button class="modal-close" onclick="fermerModalDependances()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Ajouter une d√©pendance</label>
                    <div style="display: grid; grid-template-columns: 2fr 1fr 2fr auto; gap: 10px; align-items: end;">
                        <div>
                            <label style="font-size: 12px; color: #666;">T√¢che source</label>
                            <select id="depSource" class="form-control">
                                <option value="">-- S√©lectionner --</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: #666;">Type</label>
                            <select id="depType" class="form-control">
                                <option value="FS">FS (Fin-D√©but)</option>
                                <option value="SS">SS (D√©but-D√©but)</option>
                                <option value="FF">FF (Fin-Fin)</option>
                                <option value="SF">SF (D√©but-Fin)</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 12px; color: #666;">T√¢che cible</label>
                            <select id="depCible" class="form-control">
                                <option value="">-- S√©lectionner --</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="ajouterDependance()">‚ûï Ajouter</button>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <h4 style="margin-bottom: 10px;">D√©pendances existantes</h4>
                    <div id="listeDependances"></div>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 6px; border-left: 4px solid #007bff;">
                    <h4 style="margin: 0 0 10px 0; color: #007bff;">‚ÑπÔ∏è Types de d√©pendances</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #666; font-size: 13px;">
                        <li><strong>FS (Finish-to-Start)</strong> : La t√¢che B commence quand A se termine</li>
                        <li><strong>SS (Start-to-Start)</strong> : A et B commencent en m√™me temps</li>
                        <li><strong>FF (Finish-to-Finish)</strong> : A et B se terminent en m√™me temps</li>
                        <li><strong>SF (Start-to-Finish)</strong> : B se termine quand A commence (rare)</li>
                    </ul>
                </div>

                <div style="margin-top: 15px; text-align: right;">
                    <button class="btn btn-warning" onclick="recalculerDates()">üîÑ Recalculer dates automatiquement</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Baseline -->
    <div id="modalBaseline" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>üìà Gestion Baseline</h2>
                <button class="modal-close" onclick="fermerModalBaseline()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <h4>Baseline actuelle</h4>
                    <div id="baselineInfo"></div>
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="creerBaseline()">üì∏ Cr√©er Baseline (√©tat actuel)</button>
                    <button class="btn btn-danger" onclick="supprimerBaseline()">üóëÔ∏è Supprimer Baseline</button>
                </div>

                <div style="padding: 15px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                    <h4 style="margin: 0 0 10px 0; color: #856404;">‚ÑπÔ∏è √Ä propos de la Baseline</h4>
                    <p style="margin: 0; color: #666; font-size: 13px;">
                        La baseline est une photographie de votre planning √† un instant T (dates planifi√©es). 
                        Elle permet de comparer le planifi√© vs le r√©alis√© via une courbe S sur le Gantt.
                    </p>
                </div>

                <div style="margin-top: 20px;">
                    <h4>√âcart Planifi√© vs R√©alis√©</h4>
                    <div id="courbeS"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONSTANTES ET CONFIGURATION M√âTIER
        // ============================================
        let CONFIG = {
            HEURES_JOUR: 8,
            HEURES_DEMI: 4,
            HEURES_ABSENT: 0,
            ANNEE_COURANTE: 2025,
            JOURS_FERIES: [],
            MODE_RAMADAN: false,
            HEURES_RAMADAN: 6,
            RAMADAN_DEBUT: null,
            RAMADAN_FIN: null
        };

        // ============================================
        // VARIABLES GLOBALES (√âtat de l'application)
        // ============================================
        let agents = [];
        let sousTaches = [];
        let pointages = [];
        let dependances = []; // Nouvelles d√©pendances
        let baseline = null; // Baseline pour courbe S
        let tempsSelectionne = null;
        
        // Param√®tres du Gantt
        let ganttZoom = 100; // Pourcentage de zoom
        let ganttEchelle = 'semaines'; // 'jours', 'semaines', 'mois'

        // Variable pour l'utilisateur connect√©
        let currentUser = null;

        // ============================================
        // SYST√àME D'AUTHENTIFICATION
        // ============================================
        
        // Comptes utilisateurs (en production, ceci serait g√©r√© c√¥t√© serveur)
        const USERS = [
            { email: 'ahmed.benali@cnim.ma', password: 'admin123', nom: 'Ahmed BENALI', role: 'admin' },
            { email: 'fatima.alaoui@cnim.ma', password: 'fatima123', nom: 'Fatima ALAOUI', role: 'chef' },
            { email: 'mohammed.idrissi@cnim.ma', password: 'mohammed123', nom: 'Mohammed IDRISSI', role: 'utilisateur' },
            { email: 'karim.tazi@cnim.ma', password: 'karim123', nom: 'Karim TAZI', role: 'utilisateur' },
            { email: 'salma.benjelloun@cnim.ma', password: 'salma123', nom: 'Salma BENJELLOUN', role: 'utilisateur' },
            { email: 'youssef.chakir@cnim.ma', password: 'youssef123', nom: 'Youssef CHAKIR', role: 'utilisateur' },
            { email: 'nadia.essafi@cnim.ma', password: 'nadia123', nom: 'Nadia ESSAFI', role: 'utilisateur' },
            { email: 'marouan.eljerrari@paprec.com', password: '123456789', nom: 'Marouan EL JERRARI', role: 'admin' },
            { email: 'demo@cnim.ma', password: 'demo', nom: 'Utilisateur Demo', role: 'utilisateur' }
        ];

        // Charger les utilisateurs depuis localStorage (pour permettre la modification des mots de passe)
        function getUsers() {
            const savedUsers = localStorage.getItem('appUsers');
            if (savedUsers) {
                try {
                    return JSON.parse(savedUsers);
                } catch (e) {
                    console.error('Erreur chargement utilisateurs:', e);
                    // Initialiser avec les utilisateurs par d√©faut
                    saveUsers(USERS);
                    return USERS;
                }
            }
            // Premi√®re fois : sauvegarder les utilisateurs par d√©faut
            saveUsers(USERS);
            return USERS;
        }

        function saveUsers(users) {
            localStorage.setItem('appUsers', JSON.stringify(users));
        }

        function togglePassword() {
            const passwordInput = document.getElementById('passwordInput');
            const toggleBtn = passwordInput.nextElementSibling;
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleBtn.textContent = 'üôà';
            } else {
                passwordInput.type = 'password';
                toggleBtn.textContent = 'üëÅÔ∏è';
            }
        }

        function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            const errorDiv = document.getElementById('loginError');
            const loginButton = document.getElementById('loginButton');
            
            // D√©sactiver le bouton pendant la v√©rification
            loginButton.disabled = true;
            loginButton.textContent = 'Connexion en cours...';
            
            // Simulation d'un d√©lai de connexion
            setTimeout(() => {
                // V√©rifier les credentials avec les utilisateurs sauvegard√©s
                const users = getUsers();
                const user = users.find(u => u.email === email && u.password === password);
                
                if (user) {
                    // Connexion r√©ussie
                    currentUser = user;
                    
                    // Sauvegarder la session
                    if (rememberMe) {
                        localStorage.setItem('rememberedUser', JSON.stringify({
                            email: user.email,
                            nom: user.nom,
                            role: user.role
                        }));
                    }
                    
                    sessionStorage.setItem('currentUser', JSON.stringify(user));
                    
                    // Masquer l'√©cran de connexion et afficher l'application
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('appContent').classList.add('show');
                    
                    // Initialiser l'application
                    chargerDonnees();
                    
                    console.log('‚úÖ Connexion r√©ussie:', user.nom);
                } else {
                    // √âchec de connexion
                    errorDiv.classList.add('show');
                    loginButton.disabled = false;
                    loginButton.textContent = 'Se connecter';
                    
                    // Masquer l'erreur apr√®s 3 secondes
                    setTimeout(() => {
                        errorDiv.classList.remove('show');
                    }, 3000);
                }
            }, 500);
            
            return false;
        }

        function showForgotPasswordModal(event) {
            event.preventDefault();
            document.getElementById('forgotModal').classList.add('show');
            document.getElementById('forgotSuccess').classList.remove('show');
            document.getElementById('forgotEmailInput').value = '';
        }

        function closeForgotPasswordModal() {
            document.getElementById('forgotModal').classList.remove('show');
        }

        function sendPasswordReset() {
            const email = document.getElementById('forgotEmailInput').value.trim();
            
            if (!email) {
                alert('Veuillez entrer votre adresse email');
                return;
            }
            
            // V√©rifier si l'email existe
            const users = getUsers();
            const userExists = users.some(u => u.email === email);
            
            if (userExists) {
                // Afficher le message de succ√®s
                document.getElementById('forgotSuccess').classList.add('show');
                
                // Fermer la modal apr√®s 2 secondes
                setTimeout(() => {
                    closeForgotPasswordModal();
                }, 2000);
                
                console.log('üìß Email de r√©initialisation envoy√© √†:', email);
            } else {
                alert('Cette adresse email n\'est pas enregistr√©e dans le syst√®me.');
            }
        }

        function logout() {
            if (confirm('Voulez-vous vraiment vous d√©connecter ?')) {
                // Effacer la session
                sessionStorage.removeItem('currentUser');
                
                // R√©initialiser l'interface
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('appContent').classList.remove('show');
                document.getElementById('loginError').classList.remove('show');
                document.getElementById('emailInput').value = '';
                document.getElementById('passwordInput').value = '';
                
                currentUser = null;
                
                console.log('üëã D√©connexion effectu√©e');
            }
        }

        function checkAutoLogin() {
            // V√©rifier si une session existe
            const sessionUser = sessionStorage.getItem('currentUser');
            
            if (sessionUser) {
                try {
                    currentUser = JSON.parse(sessionUser);
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('appContent').classList.add('show');
                    chargerDonnees();
                    console.log('‚úÖ Session restaur√©e:', currentUser.nom);
                    return true;
                } catch (e) {
                    console.error('Erreur de restauration de session:', e);
                }
            }
            
            // V√©rifier si "Se souvenir de moi" √©tait coch√©
            const rememberedUser = localStorage.getItem('rememberedUser');
            if (rememberedUser) {
                try {
                    const user = JSON.parse(rememberedUser);
                    document.getElementById('emailInput').value = user.email;
                    document.getElementById('rememberMe').checked = true;
                } catch (e) {
                    console.error('Erreur de chargement utilisateur m√©moris√©:', e);
                }
            }
            
            return false;
        }

        // ============================================
        // CHANGEMENT DE MOT DE PASSE
        // ============================================
        function openChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.add('show');
            document.getElementById('currentPasswordInput').value = '';
            document.getElementById('newPasswordInput').value = '';
            document.getElementById('confirmPasswordInput').value = '';
            document.getElementById('passwordStrengthBar').className = 'password-strength-bar';
            document.getElementById('passwordStrengthText').textContent = '';
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.remove('show');
        }

        function checkPasswordStrength() {
            const password = document.getElementById('newPasswordInput').value;
            const bar = document.getElementById('passwordStrengthBar');
            const text = document.getElementById('passwordStrengthText');

            if (password.length === 0) {
                bar.className = 'password-strength-bar';
                text.textContent = '';
                return;
            }

            let strength = 0;
            if (password.length >= 6) strength++;
            if (password.length >= 8) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/\d/.test(password)) strength++;
            if (/[^a-zA-Z0-9]/.test(password)) strength++;

            if (strength <= 2) {
                bar.className = 'password-strength-bar weak';
                text.textContent = '‚ö†Ô∏è Faible - Ajoutez des majuscules, chiffres ou symboles';
                text.style.color = '#f44336';
            } else if (strength <= 3) {
                bar.className = 'password-strength-bar medium';
                text.textContent = '‚ö° Moyen - Bon d√©but !';
                text.style.color = '#ff9800';
            } else {
                bar.className = 'password-strength-bar strong';
                text.textContent = '‚úÖ Fort - Excellent mot de passe !';
                text.style.color = '#4caf50';
            }
        }

        function saveNewPassword() {
            const currentPassword = document.getElementById('currentPasswordInput').value;
            const newPassword = document.getElementById('newPasswordInput').value;
            const confirmPassword = document.getElementById('confirmPasswordInput').value;

            // Validations
            if (!currentPassword || !newPassword || !confirmPassword) {
                alert('‚ö†Ô∏è Veuillez remplir tous les champs');
                return;
            }

            if (newPassword.length < 6) {
                alert('‚ö†Ô∏è Le nouveau mot de passe doit contenir au moins 6 caract√®res');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('‚ö†Ô∏è Les mots de passe ne correspondent pas');
                return;
            }

            // V√©rifier le mot de passe actuel
            const users = getUsers();
            const userIndex = users.findIndex(u => u.email === currentUser.email);

            if (userIndex === -1) {
                alert('‚ùå Erreur: Utilisateur non trouv√©');
                return;
            }

            if (users[userIndex].password !== currentPassword) {
                alert('‚ùå Mot de passe actuel incorrect');
                return;
            }

            // Mettre √† jour le mot de passe
            users[userIndex].password = newPassword;
            saveUsers(users);

            // Mettre √† jour la session
            currentUser.password = newPassword;
            sessionStorage.setItem('currentUser', JSON.stringify(currentUser));

            alert('‚úÖ Mot de passe modifi√© avec succ√®s !');
            closeChangePasswordModal();

            console.log('üîê Mot de passe chang√© pour:', currentUser.email);
        }

        // ============================================
        // GESTION DU LOCALSTORAGE
        // ============================================
        function chargerDonnees() {
            const data = localStorage.getItem('appPointageData');
            if (data) {
                try {
                    const parsed = JSON.parse(data);
                    agents = parsed.agents || [];
                    sousTaches = parsed.sousTaches || [];
                    pointages = parsed.pointages || [];
                    dependances = parsed.dependances || [];
                    baseline = parsed.baseline || null;
                    console.log('Donn√©es charg√©es:', { agents: agents.length, sousTaches: sousTaches.length, pointages: pointages.length, dependances: dependances.length });
                } catch (e) {
                    console.error('Erreur de chargement:', e);
                    initialiserDonneesParDefaut();
                }
            } else {
                initialiserDonneesParDefaut();
            }
            
            // Charger le th√®me et la densit√©
            const theme = localStorage.getItem('appTheme') || 'light';
            const density = localStorage.getItem('appDensity') || 'normal';
            document.documentElement.setAttribute('data-theme', theme);
            if (density === 'compact') {
                document.body.classList.add('compact');
            }
            updateThemeButton();
            updateDensityButton();
            
            // Charger les vues sauvegard√©es
            loadSavedViews();

            // Charger la configuration m√©tier
            chargerConfiguration();
        }

        function sauvegarderDonnees() {
            const data = {
                agents,
                sousTaches,
                pointages,
                dependances,
                baseline,
                version: '2.0',
                dateModification: new Date().toISOString()
            };
            localStorage.setItem('appPointageData', JSON.stringify(data));
            console.log('Donn√©es sauvegard√©es');
        }

        function initialiserDonneesParDefaut() {
            agents = [
                { id: 1, nom: 'Ahmed BENALI', fonction: 'Ing√©nieur M√©thode Senior', email: 'ahmed.benali@cnim.ma' },
                { id: 2, nom: 'Fatima ALAOUI', fonction: 'Chef de Projet', email: 'fatima.alaoui@cnim.ma' },
                { id: 3, nom: 'Mohammed IDRISSI', fonction: 'Dessinateur Projeteur', email: 'mohammed.idrissi@cnim.ma' },
                { id: 4, nom: 'Karim TAZI', fonction: 'Ing√©nieur Proc√©d√©s', email: 'karim.tazi@cnim.ma' },
                { id: 5, nom: 'Salma BENJELLOUN', fonction: 'Technicienne Bureau d\'√âtudes', email: 'salma.benjelloun@cnim.ma' },
                { id: 6, nom: 'Youssef CHAKIR', fonction: 'Responsable Planning', email: 'youssef.chakir@cnim.ma' },
                { id: 7, nom: 'Nadia ESSAFI', fonction: 'Ing√©nieur Qualit√©', email: 'nadia.essafi@cnim.ma' }
            ];
            
            sousTaches = [
                // Affaire 1 : Chaudi√®re Biomasse OCP Youssoufia
                {
                    id: 1001,
                    numAffaire: 'CNIM-2025-001',
                    annee: '2025',
                    client: 'OCP Youssoufia',
                    designation: 'Chaudi√®re Biomasse 50 MW',
                    nom: '√âtude de faisabilit√© technique',
                    typeDossier: '√âtude',
                    agentId: 4,
                    budgetHeures: 120,
                    budgetEuros: 18000,
                    dateDebut: '2025-01-15',
                    dateFin: '2025-02-28',
                    priorite: 'haute',
                    statut: 'termine',
                    dateCreation: '2025-01-10T08:00:00'
                },
                {
                    id: 1002,
                    numAffaire: 'CNIM-2025-001',
                    annee: '2025',
                    client: 'OCP Youssoufia',
                    designation: 'Chaudi√®re Biomasse 50 MW',
                    nom: 'Plans d\'ensemble et sch√©mas process',
                    typeDossier: 'Plans',
                    agentId: 3,
                    budgetHeures: 180,
                    budgetEuros: 24000,
                    dateDebut: '2025-03-01',
                    dateFin: '2025-04-30',
                    priorite: 'urgente',
                    statut: 'en-cours',
                    dateCreation: '2025-02-25T09:30:00'
                },
                {
                    id: 1003,
                    numAffaire: 'CNIM-2025-001',
                    annee: '2025',
                    client: 'OCP Youssoufia',
                    designation: 'Chaudi√®re Biomasse 50 MW',
                    nom: 'Calculs thermiques et hydrauliques',
                    typeDossier: 'Calculs',
                    agentId: 4,
                    budgetHeures: 95,
                    budgetEuros: 14250,
                    dateDebut: '2025-03-15',
                    dateFin: '2025-04-15',
                    priorite: 'haute',
                    statut: 'en-cours',
                    dateCreation: '2025-03-10T10:15:00'
                },
                {
                    id: 1004,
                    numAffaire: 'CNIM-2025-001',
                    annee: '2025',
                    client: 'OCP Youssoufia',
                    designation: 'Chaudi√®re Biomasse 50 MW',
                    nom: 'Dossier de fabrication chaudronnerie',
                    typeDossier: 'Fabrication',
                    agentId: 1,
                    budgetHeures: 240,
                    budgetEuros: 36000,
                    dateDebut: '2025-05-01',
                    dateFin: '2025-07-31',
                    priorite: 'haute',
                    statut: 'en-attente',
                    dateCreation: '2025-04-20T14:00:00'
                },
                {
                    id: 1005,
                    numAffaire: 'CNIM-2025-001',
                    annee: '2025',
                    client: 'OCP Youssoufia',
                    designation: 'Chaudi√®re Biomasse 50 MW',
                    nom: '√âpreuves hydrauliques et tests',
                    typeDossier: 'Tests',
                    agentId: 7,
                    budgetHeures: 80,
                    budgetEuros: 12000,
                    dateDebut: '2025-08-01',
                    dateFin: '2025-09-15',
                    priorite: 'moyenne',
                    statut: 'en-attente',
                    dateCreation: '2025-07-15T11:30:00'
                },
                
                // Affaire 2 : Incin√©rateur D√©chets Hospitaliers Rabat
                {
                    id: 2001,
                    numAffaire: 'CNIM-2025-002',
                    annee: '2025',
                    client: 'CHU Rabat',
                    designation: 'Incin√©rateur D√©chets Hospitaliers 2 t/h',
                    nom: 'Analyse des d√©chets et dimensionnement',
                    typeDossier: '√âtude',
                    agentId: 4,
                    budgetHeures: 85,
                    budgetEuros: 12750,
                    dateDebut: '2025-02-01',
                    dateFin: '2025-03-15',
                    priorite: 'haute',
                    statut: 'termine',
                    dateCreation: '2025-01-25T09:00:00'
                },
                {
                    id: 2002,
                    numAffaire: 'CNIM-2025-002',
                    annee: '2025',
                    client: 'CHU Rabat',
                    designation: 'Incin√©rateur D√©chets Hospitaliers 2 t/h',
                    nom: 'Plans chambre de combustion',
                    typeDossier: 'Plans',
                    agentId: 3,
                    budgetHeures: 145,
                    budgetEuros: 19350,
                    dateDebut: '2025-03-16',
                    dateFin: '2025-05-31',
                    priorite: 'urgente',
                    statut: 'en-cours',
                    dateCreation: '2025-03-10T13:45:00'
                },
                {
                    id: 2003,
                    numAffaire: 'CNIM-2025-002',
                    annee: '2025',
                    client: 'CHU Rabat',
                    designation: 'Incin√©rateur D√©chets Hospitaliers 2 t/h',
                    nom: 'Syst√®me de traitement des fum√©es',
                    typeDossier: '√âtude',
                    agentId: 1,
                    budgetHeures: 110,
                    budgetEuros: 16500,
                    dateDebut: '2025-04-01',
                    dateFin: '2025-05-30',
                    priorite: 'haute',
                    statut: 'en-cours',
                    dateCreation: '2025-03-28T10:20:00'
                },
                {
                    id: 2004,
                    numAffaire: 'CNIM-2025-002',
                    annee: '2025',
                    client: 'CHU Rabat',
                    designation: 'Incin√©rateur D√©chets Hospitaliers 2 t/h',
                    nom: 'Sch√©mas √©lectriques et automatisme',
                    typeDossier: 'Plans',
                    agentId: 5,
                    budgetHeures: 95,
                    budgetEuros: 12350,
                    dateDebut: '2025-06-01',
                    dateFin: '2025-07-15',
                    priorite: 'moyenne',
                    statut: 'en-attente',
                    dateCreation: '2025-05-20T15:00:00'
                },
                
                // Affaire 3 : R√©novation Four Cimenterie Lafarge
                {
                    id: 3001,
                    numAffaire: 'CNIM-2025-003',
                    annee: '2025',
                    client: 'Lafarge Holcim Maroc',
                    designation: 'R√©novation Four Rotatif Ligne 3',
                    nom: 'Expertise et diagnostic √©tat actuel',
                    typeDossier: 'Expertise',
                    agentId: 1,
                    budgetHeures: 60,
                    budgetEuros: 9000,
                    dateDebut: '2025-01-20',
                    dateFin: '2025-02-15',
                    priorite: 'urgente',
                    statut: 'termine',
                    dateCreation: '2025-01-15T08:30:00'
                },
                {
                    id: 3002,
                    numAffaire: 'CNIM-2025-003',
                    annee: '2025',
                    client: 'Lafarge Holcim Maroc',
                    designation: 'R√©novation Four Rotatif Ligne 3',
                    nom: 'Plans de r√©fection virole et bandages',
                    typeDossier: 'Plans',
                    agentId: 3,
                    budgetHeures: 135,
                    budgetEuros: 18000,
                    dateDebut: '2025-02-16',
                    dateFin: '2025-04-30',
                    priorite: 'haute',
                    statut: 'en-cours',
                    dateCreation: '2025-02-10T11:00:00'
                },
                {
                    id: 3003,
                    numAffaire: 'CNIM-2025-003',
                    annee: '2025',
                    client: 'Lafarge Holcim Maroc',
                    designation: 'R√©novation Four Rotatif Ligne 3',
                    nom: 'M√©thodologie intervention sur site',
                    typeDossier: 'M√©thodes',
                    agentId: 6,
                    budgetHeures: 75,
                    budgetEuros: 11250,
                    dateDebut: '2025-05-01',
                    dateFin: '2025-06-15',
                    priorite: 'haute',
                    statut: 'en-attente',
                    dateCreation: '2025-04-25T09:45:00'
                },
                
                // Affaire 4 : Centrale Solaire Thermique Ouarzazate
                {
                    id: 4001,
                    numAffaire: 'CNIM-2025-004',
                    annee: '2025',
                    client: 'MASEN Ouarzazate',
                    designation: 'Extension CSP Noor IV - 150 MW',
                    nom: '√âtude r√©cepteur solaire',
                    typeDossier: '√âtude',
                    agentId: 4,
                    budgetHeures: 200,
                    budgetEuros: 30000,
                    dateDebut: '2025-03-01',
                    dateFin: '2025-06-30',
                    priorite: 'urgente',
                    statut: 'en-cours',
                    dateCreation: '2025-02-20T10:00:00'
                },
                {
                    id: 4002,
                    numAffaire: 'CNIM-2025-004',
                    annee: '2025',
                    client: 'MASEN Ouarzazate',
                    designation: 'Extension CSP Noor IV - 150 MW',
                    nom: 'Conception √©changeurs thermiques',
                    typeDossier: 'Calculs',
                    agentId: 1,
                    budgetHeures: 165,
                    budgetEuros: 24750,
                    dateDebut: '2025-04-01',
                    dateFin: '2025-06-30',
                    priorite: 'haute',
                    statut: 'en-cours',
                    dateCreation: '2025-03-25T14:30:00'
                },
                {
                    id: 4003,
                    numAffaire: 'CNIM-2025-004',
                    annee: '2025',
                    client: 'MASEN Ouarzazate',
                    designation: 'Extension CSP Noor IV - 150 MW',
                    nom: 'Plans tuyauterie vapeur HP',
                    typeDossier: 'Plans',
                    agentId: 5,
                    budgetHeures: 190,
                    budgetEuros: 24700,
                    dateDebut: '2025-07-01',
                    dateFin: '2025-09-30',
                    priorite: 'moyenne',
                    statut: 'en-attente',
                    dateCreation: '2025-06-15T11:15:00'
                },
                
                // Affaire 5 : Maintenance STEP Casablanca
                {
                    id: 5001,
                    numAffaire: 'CNIM-2025-005',
                    annee: '2025',
                    client: 'LYDEC Casablanca',
                    designation: 'Maintenance STEP M√©diouna',
                    nom: 'Audit installations existantes',
                    typeDossier: 'Expertise',
                    agentId: 7,
                    budgetHeures: 45,
                    budgetEuros: 6750,
                    dateDebut: '2025-02-10',
                    dateFin: '2025-03-10',
                    priorite: 'moyenne',
                    statut: 'termine',
                    dateCreation: '2025-02-05T09:00:00'
                },
                {
                    id: 5002,
                    numAffaire: 'CNIM-2025-005',
                    annee: '2025',
                    client: 'LYDEC Casablanca',
                    designation: 'Maintenance STEP M√©diouna',
                    nom: 'Plan de maintenance pr√©ventive',
                    typeDossier: 'M√©thodes',
                    agentId: 6,
                    budgetHeures: 65,
                    budgetEuros: 9750,
                    dateDebut: '2025-03-11',
                    dateFin: '2025-04-30',
                    priorite: 'moyenne',
                    statut: 'en-cours',
                    dateCreation: '2025-03-08T13:20:00'
                },
                {
                    id: 5003,
                    numAffaire: 'CNIM-2025-005',
                    annee: '2025',
                    client: 'LYDEC Casablanca',
                    designation: 'Maintenance STEP M√©diouna',
                    nom: 'Remplacement pompes et agitateurs',
                    typeDossier: 'Fabrication',
                    agentId: 1,
                    budgetHeures: 85,
                    budgetEuros: 12750,
                    dateDebut: '2025-05-01',
                    dateFin: '2025-06-30',
                    priorite: 'faible',
                    statut: 'en-attente',
                    dateCreation: '2025-04-25T10:45:00'
                }
            ];
            
            pointages = [
                // Pointages Octobre 2025
                { id: 2001, date: '2025-10-01', agentId: 3, sousTacheId: 1002, heures: 7.5, heuresNettes: 7.5, commentaire: 'Avancement plans ensemble' },
                { id: 2002, date: '2025-10-01', agentId: 4, sousTacheId: 1003, heures: 8, heuresNettes: 8, commentaire: 'Calculs thermiques foyer' },
                { id: 2003, date: '2025-10-01', agentId: 1, sousTacheId: 2003, heures: 6, heuresNettes: 6, commentaire: '√âtude laveur de fum√©es' },
                
                { id: 2004, date: '2025-10-02', agentId: 3, sousTacheId: 1002, heures: 8, heuresNettes: 8, commentaire: 'Plans d√©tails tuyauterie' },
                { id: 2005, date: '2025-10-02', agentId: 4, sousTacheId: 1003, heures: 7, heuresNettes: 7, commentaire: 'Validation calculs' },
                { id: 2006, date: '2025-10-02', agentId: 3, sousTacheId: 2002, heures: 4, heuresNettes: 4, commentaire: 'Plans chambre combustion' },
                { id: 2007, date: '2025-10-02', agentId: 1, sousTacheId: 4001, heures: 5, heuresNettes: 5, commentaire: 'Analyse r√©cepteur solaire' },
                
                { id: 2008, date: '2025-10-03', agentId: 3, sousTacheId: 3002, heures: 8, heuresNettes: 8, commentaire: 'Plans virole four' },
                { id: 2009, date: '2025-10-03', agentId: 4, sousTacheId: 4001, heures: 6.5, heuresNettes: 6.5, commentaire: '√âtude thermique r√©cepteur' },
                { id: 2010, date: '2025-10-03', agentId: 1, sousTacheId: 4002, heures: 7, heuresNettes: 7, commentaire: 'Conception √©changeur' },
                
                { id: 2011, date: '2025-10-04', agentId: 3, sousTacheId: 1002, heures: 7.5, heuresNettes: 7.5, commentaire: 'R√©vision plans' },
                { id: 2012, date: '2025-10-04', agentId: 5, sousTacheId: 2002, heures: 8, heuresNettes: 8, commentaire: 'Plans chambre' },
                { id: 2013, date: '2025-10-04', agentId: 6, sousTacheId: 5002, heures: 6, heuresNettes: 6, commentaire: 'Planning maintenance' },
                
                { id: 2014, date: '2025-10-07', agentId: 3, sousTacheId: 2002, heures: 8, heuresNettes: 8, commentaire: 'Finalisation plans' },
                { id: 2015, date: '2025-10-07', agentId: 4, sousTacheId: 1003, heures: 7, heuresNettes: 7, commentaire: 'Rapport calculs' },
                { id: 2016, date: '2025-10-07', agentId: 1, sousTacheId: 2003, heures: 7.5, heuresNettes: 7.5, commentaire: 'Filtres √† manches' },
                
                { id: 2017, date: '2025-10-08', agentId: 3, sousTacheId: 1002, heures: 6.5, heuresNettes: 6.5, commentaire: 'Modifications plans' },
                { id: 2018, date: '2025-10-08', agentId: 4, sousTacheId: 4001, heures: 8, heuresNettes: 8, commentaire: 'Mod√©lisation thermique' },
                { id: 2019, date: '2025-10-08', agentId: 1, sousTacheId: 4002, heures: 7, heuresNettes: 7, commentaire: 'Dimensionnement' },
                
                { id: 2020, date: '2025-10-09', agentId: 5, sousTacheId: 2002, heures: 7.5, heuresNettes: 7.5, commentaire: 'Sch√©mas d√©taill√©s' },
                { id: 2021, date: '2025-10-09', agentId: 3, sousTacheId: 3002, heures: 8, heuresNettes: 8, commentaire: 'Plans bandages' },
                { id: 2022, date: '2025-10-09', agentId: 6, sousTacheId: 5002, heures: 6, heuresNettes: 6, commentaire: 'Proc√©dures maintenance' },
                
                { id: 2023, date: '2025-10-10', agentId: 3, sousTacheId: 1002, heures: 8, heuresNettes: 8, commentaire: 'Validation finale plans' },
                { id: 2024, date: '2025-10-10', agentId: 4, sousTacheId: 1003, heures: 6.5, heuresNettes: 6.5, commentaire: 'Note de calcul' },
                { id: 2025, date: '2025-10-10', agentId: 1, sousTacheId: 2003, heures: 7, heuresNettes: 7, commentaire: 'Sch√©ma process fum√©es' },
                
                { id: 2026, date: '2025-10-11', agentId: 3, sousTacheId: 2002, heures: 7.5, heuresNettes: 7.5, commentaire: 'Correction plans' },
                { id: 2027, date: '2025-10-11', agentId: 4, sousTacheId: 4001, heures: 8, heuresNettes: 8, commentaire: 'Simulation CFD' },
                { id: 2028, date: '2025-10-11', agentId: 1, sousTacheId: 4002, heures: 6, heuresNettes: 6, commentaire: 'S√©lection mat√©riaux' },
                
                // Pointages r√©cents Novembre
                { id: 2029, date: '2025-11-01', agentId: 3, sousTacheId: 1002, heures: 7, heuresNettes: 7, commentaire: 'Mise √† jour plans' },
                { id: 2030, date: '2025-11-01', agentId: 4, sousTacheId: 4001, heures: 8, heuresNettes: 8, commentaire: 'Optimisation r√©cepteur' },
                { id: 2031, date: '2025-11-01', agentId: 1, sousTacheId: 2003, heures: 6.5, heuresNettes: 6.5, commentaire: 'Sp√©cifications techniques' }
            ];
            
            dependances = [];
            baseline = null;
            
            sauvegarderDonnees();
            
            console.log('‚úÖ Donn√©es d\'exemple CNIM initialis√©es:', {
                agents: agents.length,
                sousTaches: sousTaches.length,
                pointages: pointages.length
            });
        }

        // ============================================
        // INITIALISATION AU CHARGEMENT
        // ============================================
        window.addEventListener('DOMContentLoaded', function() {
            // V√©rifier d'abord si l'utilisateur est d√©j√† connect√©
            const isLoggedIn = checkAutoLogin();
            
            if (!isLoggedIn) {
                // Afficher l'√©cran de connexion
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('appContent').classList.remove('show');
            }
            
            // Masquer l'√©cran de chargement apr√®s initialisation
            setTimeout(function() {
                const loader = document.getElementById('loaderOverlay');
                if (loader) {
                    loader.classList.add('hidden');
                }
            }, 1000);

            // Si d√©j√† connect√©, initialiser l'application
            if (isLoggedIn) {
                initialiserHorloge();
                peuplerSelecteurs();
                afficherAffaires();
                afficherVueParAffaire();
                afficherSynthese();
                afficherRetards();
                afficherAgents();
                afficherSuiviBudget();
                
                // Initialiser le calcul du temps
                calculerTempsTotal();
                
                // Date par d√©faut pour le pointage
                const datePointage = document.getElementById('datePointage');
                const dateAgenda = document.getElementById('dateAgenda');
                if (datePointage) datePointage.valueAsDate = new Date();
                if (dateAgenda) dateAgenda.valueAsDate = new Date();
            }
            
            console.log('‚ú® Application CNIM charg√©e');
        });

        // ============================================
        // HORLOGE EN TEMPS R√âEL
        // ============================================
        function initialiserHorloge() {
            function updateClock() {
                const now = new Date();
                
                // Heure
                const heures = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const secondes = String(now.getSeconds()).padStart(2, '0');
                document.getElementById('clockTime').textContent = `${heures}:${minutes}:${secondes}`;
                
                // Date
                const jours = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                const mois = ['janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin', 'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre'];
                const jourSemaine = jours[now.getDay()];
                const jour = now.getDate();
                const moisNom = mois[now.getMonth()];
                const annee = now.getFullYear();
                document.getElementById('clockDate').textContent = `${jourSemaine} ${jour} ${moisNom} ${annee}`;
            }
            
            updateClock();
            setInterval(updateClock, 1000);

            // Initialiser la recherche globale
            document.getElementById('globalSearchInput').addEventListener('input', applyGlobalFilters);
        }

        // ============================================
        // GESTION DES ONGLETS
        // ============================================
        function switchTab(tabName) {
            // D√©sactiver tous les onglets (desktop)
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            // D√©sactiver tous les items de navigation mobile
            document.querySelectorAll('.mobile-nav-item').forEach(item => item.classList.remove('active'));
            
            // D√©sactiver tous les contenus
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Activer l'onglet desktop cliqu√© (si existe)
            if(event && event.target && event.target.classList.contains('tab')) {
                event.target.classList.add('active');
            }
            
            // Activer le bouton mobile correspondant
            const mobileBtn = document.querySelector(`.mobile-nav-item[onclick*="${tabName}"]`);
            if(mobileBtn) {
                mobileBtn.classList.add('active');
            }
            
            // Activer l'onglet desktop correspondant
            const desktopTab = document.querySelector(`.tab[onclick*="${tabName}"]`);
            if(desktopTab) {
                desktopTab.classList.add('active');
            }
            
            // Activer le contenu
            document.getElementById('tab-' + tabName).classList.add('active');
            
            // Rafra√Æchissements cibl√©s
            switch(tabName) {
                case 'affaires':
                    afficherAffaires();
                    afficherVueParAffaire();
                    afficherSynthese();
                    afficherRetards();
                    break;
                case 'pointage':
                    afficherHistoriquePointages();
                    peuplerSousTachesPointage();
                    break;
                case 'journalier':
                    peuplerAgentJournalier();
                    afficherPointageJournalier();
                    break;
                case 'mensuel':
                    peuplerFiltresMensuel();
                    afficherPointageMensuel();
                    break;
                case 'planning':
                    afficherGantt();
                    break;
                case 'analytics':
                    afficherAnalytics();
                    break;
                case 'rapports':
                    // Pas de chargement sp√©cifique pour l'instant
                    break;
                case 'parametres':
                    afficherAgents();
                    afficherStatistiques();
                    break;
            }
        }

        // ============================================
        // PEUPLEMENT DES S√âLECTEURS
        // ============================================
        function peuplerSelecteurs() {
            // S√©lecteur d'agents (affaires)
            const selectAgent = document.getElementById('agentAssigne');
            selectAgent.innerHTML = '<option value="">S√©lectionner...</option>';
            agents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.id;
                option.textContent = agent.nom;
                selectAgent.appendChild(option);
            });
            
            // S√©lecteur d'agents (pointage)
            const selectAgentPointage = document.getElementById('agentPointage');
            selectAgentPointage.innerHTML = '<option value="">S√©lectionner...</option>';
            agents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.id;
                option.textContent = agent.nom;
                selectAgentPointage.appendChild(option);
            });
        }

        function peuplerSousTachesPointage() {
            const select = document.getElementById('sousTachePointage');
            select.innerHTML = '<option value="">S√©lectionner...</option>';
            
            // Filtrer les sous-t√¢ches actives
            const maintenant = new Date();
            const tachesActives = sousTaches.filter(st => {
                const debut = new Date(st.dateDebut);
                const fin = new Date(st.dateFin);
                return debut <= maintenant && fin >= maintenant;
            });
            
            tachesActives.forEach(st => {
                const option = document.createElement('option');
                option.value = st.id;
                option.textContent = `${st.numAffaire} - ${st.nom}`;
                select.appendChild(option);
            });
        }

        // ============================================
        // GESTION DES AFFAIRES
        // ============================================
        function ajouterAffaire(event) {
            event.preventDefault();
            
            // Afficher l'indicateur de processus
            showProcessIndicator('Cr√©ation Nouvelle Affaire', [
                { label: 'Validation des donn√©es', description: 'V√©rification des champs', icon: 'üìã' },
                { label: 'V√©rification doublons', description: 'Contr√¥le unicit√©', icon: 'üîç' },
                { label: 'Cr√©ation affaire', description: 'Enregistrement BDD', icon: 'üíæ' },
                { label: 'Mise √† jour interface', description: 'Actualisation vues', icon: 'üîÑ' },
                { label: 'Finalisation', description: 'Processus termin√©', icon: '‚úÖ' }
            ]);
            
            // √âtape 1 : Validation des donn√©es
            updateProcessStep(0, 'active');
            
            const numAffaire = document.getElementById('numAffaire').value.trim();
            const annee = document.getElementById('anneeAffaire')?.value || new Date().getFullYear();
            const client = document.getElementById('clientAffaire').value.trim();
            const designation = document.getElementById('designationAffaire').value.trim();
            const agentId = parseInt(document.getElementById('agentAssigne').value);
            const budgetHeures = parseFloat(document.getElementById('budgetHeures').value);
            const budgetEuros = parseFloat(document.getElementById('budgetEuros')?.value || 0);
            const dateDebut = document.getElementById('dateDebut').value;
            const dateFin = document.getElementById('dateFin').value;
            const priorite = document.getElementById('priorite').value;
            const statut = document.getElementById('statutAffaire').value;
            
            // Le nom de la sous-t√¢che = d√©signation de l'affaire
            const nom = designation;
            const typeDossier = 'Affaire principale';

            // ===== VALIDATIONS M√âTIER =====
            
            // 1. Validation des champs requis
            if (!numAffaire || !client || !designation || !agentId || !budgetHeures || !dateDebut || !dateFin) {
                updateProcessStep(0, 'completed', '‚ùå √âchec');
                closeProcessIndicator();
                afficherNotification('‚ùå Tous les champs obligatoires doivent √™tre remplis', 'error');
                return;
            }

            // 2. Validation format date ISO
            const regexISO = /^\d{4}-\d{2}-\d{2}$/;
            if (!regexISO.test(dateDebut) || !regexISO.test(dateFin)) {
                updateProcessStep(0, 'completed', '‚ùå √âchec');
                closeProcessIndicator();
                afficherNotification('‚ùå Les dates doivent √™tre au format YYYY-MM-DD', 'error');
                return;
            }

            // 3. Validation dates coh√©rentes
            if (new Date(dateDebut) > new Date(dateFin)) {
                updateProcessStep(0, 'completed', '‚ùå √âchec');
                closeProcessIndicator();
                afficherNotification('‚ùå La date de d√©but doit √™tre ant√©rieure √† la date de fin', 'error');
                return;
            }

            // 4. Validation budget > 0
            if (budgetHeures <= 0) {
                updateProcessStep(0, 'completed', '‚ùå √âchec');
                closeProcessIndicator();
                afficherNotification('‚ùå Le budget doit √™tre sup√©rieur √† 0 heures', 'error');
                return;
            }

            // 5. Validation agent existe
            const agentExiste = agents.find(a => a.id === agentId);
            if (!agentExiste) {
                updateProcessStep(0, 'completed', '‚ùå √âchec');
                closeProcessIndicator();
                afficherNotification('‚ùå L\'agent s√©lectionn√© n\'existe pas', 'error');
                return;
            }
            
            // Validation r√©ussie
            setTimeout(() => {
                updateProcessStep(0, 'completed');
                
                // √âtape 2 : V√©rification doublons
                updateProcessStep(1, 'active');
                
                setTimeout(() => {
                    // V√©rification doublon sur numAffaire uniquement
                    const doublonAffaire = sousTaches.find(st => st.numAffaire === numAffaire);

                    if (doublonAffaire) {
                        updateProcessStep(1, 'completed', '‚ùå Doublon');
                        closeProcessIndicator();
                        afficherNotification(`‚ùå Une affaire avec le N¬∞ ${numAffaire} existe d√©j√†`, 'error');
                        return;
                    }
                    
                    updateProcessStep(1, 'completed');
                    
                    // √âtape 3 : Cr√©ation affaire
                    updateProcessStep(2, 'active');
                    
                    setTimeout(() => {
                        const sousTache = {
                            id: Date.now(),
                            numAffaire,
                            annee,
                            client,
                            designation,
                            nom,
                            typeDossier,
                            agentId,
                            budgetHeures,
                            budgetEuros,
                            dateDebut,
                            dateFin,
                            priorite,
                            statut,
                            dateCreation: new Date().toISOString()
                        };
                        
                        sousTaches.push(sousTache);
                        sauvegarderDonnees();
                        
                        updateProcessStep(2, 'completed');
                        
                        // √âtape 4 : Mise √† jour interface
                        updateProcessStep(3, 'active');
                        
                        setTimeout(() => {
                            document.getElementById('formAffaire').reset();
                            document.getElementById('anneeAffaire').value = new Date().getFullYear();
                            document.getElementById('statutAffaire').value = 'en-cours';
                            document.getElementById('priorite').value = 'moyenne';
                            afficherAffaires();
                            afficherVueParAffaire();
                            afficherSynthese();
                            afficherRetards();
                            
                            updateProcessStep(3, 'completed');
                            
                            // √âtape 5 : Finalisation
                            updateProcessStep(4, 'active');
                            
                            setTimeout(() => {
                                updateProcessStep(4, 'completed');
                                afficherNotification(`‚úÖ Affaire ${numAffaire} ajout√©e avec succ√®s !`, 'success');
                            }, 300);
                        }, 400);
                    }, 500);
                }, 500);
            }, 500);
        }

        // ============================================
        // EXPORT EXCEL DES AFFAIRES
        // ============================================
        function exporterAffairesExcel() {
            if (typeof XLSX === 'undefined') {
                afficherNotification('‚ùå Biblioth√®que XLSX non charg√©e', 'error');
                return;
            }
            
            // Grouper par affaire principale
            const affairesMap = {};
            sousTaches.forEach(st => {
                if (!affairesMap[st.numAffaire]) {
                    affairesMap[st.numAffaire] = {
                        numAffaire: st.numAffaire,
                        annee: st.annee || '2025',
                        client: st.client,
                        designation: st.designation,
                        agentId: st.agentId,
                        dateDebut: st.dateDebut,
                        dateFin: st.dateFin,
                        budgetEuros: st.budgetEuros || 0,
                        budgetHeures: 0,
                        sousTaches: []
                    };
                }
                affairesMap[st.numAffaire].sousTaches.push(st);
                affairesMap[st.numAffaire].budgetHeures += st.budgetHeures || 0;
            });
            
            const affaires = Object.values(affairesMap);
            
            // Cr√©er les donn√©es pour Excel
            const sheetData = [];
            
            // En-t√™te CNIM
            sheetData.push(['CNIM BABCOCK MAROC']);
            sheetData.push(['D√©partement M√©thode - Gestion des Affaires']);
            sheetData.push(['']);
            sheetData.push(['LISTE DES AFFAIRES PRINCIPALES']);
            sheetData.push(['G√©n√©r√© le: ' + new Date().toLocaleDateString('fr-FR', {
                year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
            })]);
            sheetData.push([]);
            
            // En-t√™te du tableau
            sheetData.push([
                'N¬∞ Affaire',
                'Ann√©e',
                'Client',
                'D√©signation',
                'Responsable',
                'Date D√©but',
                'Date Fin',
                'Budget (‚Ç¨)',
                'Budget (h)',
                'Nb Sous-t√¢ches',
                'Heures R√©alis√©es',
                'Avancement (%)'
            ]);
            
            // Donn√©es
            affaires.forEach(affaire => {
                const agent = agents.find(a => a.id == affaire.agentId);
                const nbSousTaches = affaire.sousTaches.length;
                
                // Calculer avancement global
                let budgetTotal = 0;
                let realiseTotal = 0;
                affaire.sousTaches.forEach(st => {
                    budgetTotal += st.budgetHeures || 0;
                    realiseTotal += calculerRealise(st.id);
                });
                const avancement = budgetTotal > 0 ? Math.round((realiseTotal / budgetTotal) * 100) : 0;
                
                sheetData.push([
                    affaire.numAffaire,
                    affaire.annee,
                    affaire.client,
                    affaire.designation,
                    agent ? agent.nom : 'Non assign√©',
                    affaire.dateDebut ? new Date(affaire.dateDebut).toLocaleDateString('fr-FR') : '',
                    affaire.dateFin ? new Date(affaire.dateFin).toLocaleDateString('fr-FR') : '',
                    affaire.budgetEuros,
                    affaire.budgetHeures,
                    nbSousTaches,
                    realiseTotal.toFixed(1),
                    avancement
                ]);
            });
            
            // Ligne de statistiques
            sheetData.push([]);
            sheetData.push([
                'TOTAL',
                '',
                '',
                '',
                '',
                '',
                '',
                affaires.reduce((sum, a) => sum + (a.budgetEuros || 0), 0),
                affaires.reduce((sum, a) => sum + (a.budgetHeures || 0), 0),
                affaires.reduce((sum, a) => sum + a.sousTaches.length, 0),
                '',
                ''
            ]);
            
            // Cr√©er la feuille Excel
            const ws = XLSX.utils.aoa_to_sheet(sheetData);
            
            // Styles et largeurs de colonnes
            ws['!cols'] = [
                { wch: 12 },  // N¬∞ Affaire
                { wch: 8 },   // Ann√©e
                { wch: 25 },  // Client
                { wch: 40 },  // D√©signation
                { wch: 20 },  // Responsable
                { wch: 12 },  // Date D√©but
                { wch: 12 },  // Date Fin
                { wch: 15 },  // Budget ‚Ç¨
                { wch: 12 },  // Budget h
                { wch: 15 },  // Nb Sous-t√¢ches
                { wch: 15 },  // Heures R√©alis√©es
                { wch: 15 }   // Avancement
            ];
            
            // Cr√©er le classeur
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Affaires Principales');
            
            // T√©l√©charger
            const filename = `Affaires_Principales_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            afficherNotification('‚úÖ Export Excel r√©ussi !', 'success');
        }
        
        // ============================================
        // EXPORT EXCEL DES SOUS-T√ÇCHES
        // ============================================
        function exporterSousTachesExcel() {
            if (typeof XLSX === 'undefined') {
                afficherNotification('‚ùå Biblioth√®que XLSX non charg√©e', 'error');
                return;
            }
            
            const filtre = document.getElementById('filtreSousTaches')?.value || '';
            let sousTachesFiltrees = sousTaches;
            if (filtre) {
                sousTachesFiltrees = sousTaches.filter(st => st.numAffaire === filtre);
            }
            
            // Cr√©er les donn√©es pour Excel
            const sheetData = [];
            
            // En-t√™te CNIM
            sheetData.push(['CNIM BABCOCK MAROC']);
            sheetData.push(['D√©partement M√©thode - Gestion des Sous-T√¢ches']);
            sheetData.push(['']);
            sheetData.push([filtre ? `SOUS-T√ÇCHES DE L'AFFAIRE ${filtre}` : 'TOUTES LES SOUS-T√ÇCHES']);
            sheetData.push(['G√©n√©r√© le: ' + new Date().toLocaleDateString('fr-FR', {
                year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
            })]);
            sheetData.push([]);
            
            // En-t√™te du tableau
            sheetData.push([
                'N¬∞ Affaire',
                'Type',
                'Description',
                'Responsable',
                'Date D√©but',
                'Date Fin',
                'Priorit√©',
                'Statut',
                'Budget (h)',
                'R√©alis√© (h)',
                'Avancement (%)'
            ]);
            
            // Donn√©es
            sousTachesFiltrees.forEach(st => {
                const agent = agents.find(a => a.id == st.agentId);
                const realise = calculerRealise(st.id);
                const budget = st.budgetHeures || 0;
                const avancement = budget > 0 ? Math.round((realise / budget) * 100) : 0;
                
                sheetData.push([
                    st.numAffaire,
                    st.typeDossier || '-',
                    st.nom,
                    agent ? agent.nom : 'Non assign√©',
                    st.dateDebut ? new Date(st.dateDebut).toLocaleDateString('fr-FR') : '',
                    st.dateFin ? new Date(st.dateFin).toLocaleDateString('fr-FR') : '',
                    st.priorite,
                    st.statut,
                    budget,
                    realise.toFixed(1),
                    avancement
                ]);
            });
            
            // Ligne de statistiques
            sheetData.push([]);
            sheetData.push([
                'TOTAL',
                '',
                `${sousTachesFiltrees.length} sous-t√¢ches`,
                '',
                '',
                '',
                '',
                '',
                sousTachesFiltrees.reduce((sum, st) => sum + (st.budgetHeures || 0), 0),
                sousTachesFiltrees.reduce((sum, st) => sum + calculerRealise(st.id), 0).toFixed(1),
                ''
            ]);
            
            // Cr√©er la feuille Excel
            const ws = XLSX.utils.aoa_to_sheet(sheetData);
            
            // Styles et largeurs de colonnes
            ws['!cols'] = [
                { wch: 12 },  // N¬∞ Affaire
                { wch: 20 },  // Type
                { wch: 40 },  // Description
                { wch: 20 },  // Responsable
                { wch: 12 },  // Date D√©but
                { wch: 12 },  // Date Fin
                { wch: 12 },  // Priorit√©
                { wch: 12 },  // Statut
                { wch: 12 },  // Budget
                { wch: 12 },  // R√©alis√©
                { wch: 15 }   // Avancement
            ];
            
            // Cr√©er le classeur
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Sous-T√¢ches');
            
            // T√©l√©charger
            const affaireText = filtre ? `_${filtre}` : '_Toutes';
            const filename = `Sous_Taches${affaireText}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            afficherNotification('‚úÖ Export Excel r√©ussi !', 'success');
        }

        function getTypeLabel(type) {
            const types = {
                'expression-besoin': 'Expression de besoin',
                'preparation-dossier': 'Pr√©paration dossier',
                'achat-matiere': 'Achat mati√®re',
                'chassis-transport': 'Ch√¢ssis transport',
                'liste-colisage': 'Liste de colisage',
                'mise-camion': 'Mise en camion',
                'schema': 'Sch√©ma',
                'epreuve-hydraulique': '√âpreuve hydraulique',
                'etude': '√âtude',
                'fabrication': 'Fabrication'
            };
            return types[type] || type;
        }

        function calculerRealise(sousTacheId) {
            // Calculer les heures r√©alis√©es √† partir des pointages (utiliser heuresNettes si disponible)
            const pointagesSousTache = pointages.filter(p => p.sousTacheId === sousTacheId);
            return pointagesSousTache.reduce((sum, p) => {
                // Utiliser heuresNettes si disponible, sinon heures
                const heures = p.heuresNettes !== undefined ? p.heuresNettes : p.heures;
                return sum + heures;
            }, 0);
        }

        function calculerAvancement(realise, budget) {
            if (budget === 0) return 0;
            // Avancement entre 0 et 100
            const avancement = Math.round((realise / budget) * 100);
            return Math.max(0, Math.min(avancement, 100));
        }

        function calculerAvancementAffaire(numAffaire) {
            // Avancement calcul√© (pond√©r√© par budget heures)
            const sousTachesAffaire = sousTaches.filter(st => st.numAffaire === numAffaire);
            
            if (sousTachesAffaire.length === 0) return 0;

            let totalPoids = 0;
            let avancementPondere = 0;

            sousTachesAffaire.forEach(st => {
                const poids = st.budgetHeures || 1; // Poids = heures pr√©vues
                const realise = calculerRealise(st.id);
                const avancement = calculerAvancement(realise, st.budgetHeures);
                
                totalPoids += poids;
                avancementPondere += avancement * poids;
            });

            return totalPoids > 0 ? Math.round(avancementPondere / totalPoids) : 0;
        }

        function afficherAffaires() {
            afficherAffairesPrincipales();
            afficherSousTaches();
            peuplerSelecteurAffaires();
            peuplerFiltreSousTaches();
        }
        
        // Afficher le tableau des affaires principales
        function afficherAffairesPrincipales() {
            const tbody = document.getElementById('listeAffairesPrincipales');
            if (!tbody) return;
            
            // Grouper par affaire principale
            const affairesMap = {};
            sousTaches.forEach(st => {
                if (!affairesMap[st.numAffaire]) {
                    affairesMap[st.numAffaire] = {
                        numAffaire: st.numAffaire,
                        annee: st.annee || '2025',
                        client: st.client,
                        designation: st.designation,
                        agentId: st.agentId,
                        dateDebut: st.dateDebut,
                        dateFin: st.dateFin,
                        budgetEuros: st.budgetEuros || 0,
                        budgetHeures: 0,
                        sousTaches: []
                    };
                }
                affairesMap[st.numAffaire].sousTaches.push(st);
                affairesMap[st.numAffaire].budgetHeures += st.budgetHeures || 0;
            });
            
            const affaires = Object.values(affairesMap);
            
            let html = '';
            affaires.forEach((affaire, index) => {
                const agent = agents.find(a => a.id == affaire.agentId);
                const nbSousTaches = affaire.sousTaches.length;
                
                // Calculer avancement global
                let budgetTotal = 0;
                let realiseTotal = 0;
                affaire.sousTaches.forEach(st => {
                    budgetTotal += st.budgetHeures || 0;
                    realiseTotal += calculerRealise(st.id);
                });
                const avancement = budgetTotal > 0 ? Math.round((realiseTotal / budgetTotal) * 100) : 0;
                
                // Couleur de la barre selon l'avancement
                let barColor = '#e74c3c'; // Rouge par d√©faut
                if (avancement >= 75) barColor = '#27ae60'; // Vert
                else if (avancement >= 50) barColor = '#f39c12'; // Orange
                else if (avancement >= 25) barColor = '#3498db'; // Bleu
                
                const bgColor = index % 2 === 0 ? '#ffffff' : '#f8fbff';
                
                html += `
                    <tr style="border-left: 5px solid #0066cc; background: ${bgColor}; transition: all 0.2s;" 
                        onmouseover="this.style.background='#e3f2fd'; this.style.transform='translateX(2px)';" 
                        onmouseout="this.style.background='${bgColor}'; this.style.transform='translateX(0)';">
                        <td style="padding: 14px 12px; font-weight: 700; color: #0066cc; font-size: 14px;">${affaire.numAffaire}</td>
                        <td style="padding: 14px 12px; text-align: center; font-weight: 600; color: #7f8c8d;">${affaire.annee}</td>
                        <td style="padding: 14px 12px; font-weight: 600; color: #2c3e50;">${affaire.client}</td>
                        <td style="padding: 14px 12px; color: #34495e; line-height: 1.4;">${affaire.designation}</td>
                        <td style="padding: 14px 12px;">
                            <span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-block;">
                                üë§ ${agent ? agent.nom : 'Non assign√©'}
                            </span>
                        </td>
                        <td style="padding: 14px 12px; text-align: center; color: #7f8c8d; font-size: 13px;">${affaire.dateDebut ? new Date(affaire.dateDebut).toLocaleDateString('fr-FR') : '-'}</td>
                        <td style="padding: 14px 12px; text-align: center; color: #7f8c8d; font-size: 13px;">${affaire.dateFin ? new Date(affaire.dateFin).toLocaleDateString('fr-FR') : '-'}</td>
                        <td style="padding: 14px 12px; text-align: right; font-weight: 700; color: #16a085; font-size: 14px;">${affaire.budgetEuros.toLocaleString('fr-FR')} ‚Ç¨</td>
                        <td style="padding: 14px 12px; text-align: right; font-weight: 700; color: #2980b9; font-size: 14px;">${affaire.budgetHeures}h</td>
                        <td style="padding: 14px 12px; text-align: center;">
                            <span style="background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; padding: 6px 14px; border-radius: 25px; font-weight: 700; font-size: 13px; box-shadow: 0 2px 6px rgba(39,174,96,0.3);">
                                ${nbSousTaches}
                            </span>
                        </td>
                        <td style="padding: 14px 12px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="flex: 1; background: #ecf0f1; border-radius: 12px; height: 24px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                                    <div style="width: ${avancement}%; background: linear-gradient(90deg, ${barColor}, ${barColor}dd); height: 100%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                                        ${avancement > 15 ? '<span style="color: white; font-size: 11px; font-weight: 700;">' + avancement + '%</span>' : ''}
                                    </div>
                                </div>
                                <span style="font-weight: 700; color: ${barColor}; min-width: 48px; font-size: 14px;">${avancement}%</span>
                            </div>
                        </td>
                        <td style="padding: 14px 12px; text-align: center;">
                            <button class="btn btn-sm" onclick="supprimerAffairePrincipale('${affaire.numAffaire}')" title="Supprimer l'affaire" 
                                style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; border: none; padding: 8px 12px; border-radius: 8px; font-weight: 600; box-shadow: 0 2px 6px rgba(231,76,60,0.3); transition: all 0.3s;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(231,76,60,0.4)';"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(231,76,60,0.3)';">
                                üóëÔ∏è Supprimer
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html || '<tr><td colspan="12" style="text-align: center; padding: 40px; color: #95a5a6; font-size: 16px;"><div style="font-size: 48px; margin-bottom: 10px;">üìÇ</div>Aucune affaire enregistr√©e</td></tr>';
        }
        
        // Afficher le tableau des sous-t√¢ches
        function afficherSousTaches() {
            const tbody = document.getElementById('listeSousTaches');
            const filtre = document.getElementById('filtreSousTaches')?.value || '';
            if (!tbody) return;
            
            let sousTachesFiltrees = sousTaches;
            if (filtre) {
                sousTachesFiltrees = sousTaches.filter(st => st.numAffaire === filtre);
            }
            
            let html = '';
            sousTachesFiltrees.forEach((st, index) => {
                const agent = agents.find(a => a.id == st.agentId);
                const realise = calculerRealise(st.id);
                const budget = st.budgetHeures || 0;
                const avancementCalcule = budget > 0 ? Math.round((realise / budget) * 100) : 0;
                
                // Utiliser l'avancement manuel si d√©fini, sinon calcul√©
                const avancement = st.avancementManuel !== undefined ? st.avancementManuel : avancementCalcule;
                const estManuel = st.avancementManuel !== undefined;
                
                const prioriteIcons = {
                    'faible': '‚¨áÔ∏è',
                    'moyenne': '‚û°Ô∏è',
                    'haute': '‚¨ÜÔ∏è',
                    'urgente': 'üî¥'
                };
                const prioriteColors = {
                    'faible': '#95a5a6',
                    'moyenne': '#3498db',
                    'haute': '#f39c12',
                    'urgente': '#e74c3c'
                };
                const prioriteColor = prioriteColors[st.priorite] || '#95a5a6';
                const prioriteIcon = prioriteIcons[st.priorite] || '';
                
                const statutIcons = {
                    'en-attente': '‚è∏Ô∏è',
                    'en-cours': '‚ñ∂Ô∏è',
                    'termine': '‚úÖ',
                    'suspendu': '‚èπÔ∏è'
                };
                const statutColors = {
                    'en-attente': '#95a5a6',
                    'en-cours': '#3498db',
                    'termine': '#27ae60',
                    'suspendu': '#e67e22'
                };
                const statutColor = statutColors[st.statut] || '#95a5a6';
                const statutIcon = statutIcons[st.statut] || '';
                
                // Couleur de la barre d'avancement
                let barColor = '#e74c3c';
                if (avancement >= 75) barColor = '#27ae60';
                else if (avancement >= 50) barColor = '#f39c12';
                else if (avancement >= 25) barColor = '#3498db';
                
                const bgColor = index % 2 === 0 ? '#ffffff' : '#fafcff';
                
                html += `
                    <tr style="background: ${bgColor}; border-left: 3px solid #27ae60; transition: all 0.2s;"
                        onmouseover="this.style.background='#e8f5e9'; this.style.transform='translateX(2px)';" 
                        onmouseout="this.style.background='${bgColor}'; this.style.transform='translateX(0)';">
                        <td style="padding: 12px; font-weight: 700; color: #0066cc; font-size: 13px;">${st.numAffaire}</td>
                        <td style="padding: 12px; color: #5d6d7e; font-size: 12px; font-weight: 500;">${st.typeDossier || '-'}</td>
                        <td style="padding: 12px; color: #34495e; line-height: 1.5; max-width: 300px;">${st.nom}</td>
                        <td style="padding: 12px;">
                            <span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 4px 10px; border-radius: 15px; font-size: 11px; font-weight: 600;">
                                üë§ ${agent ? agent.nom : 'Non assign√©'}
                            </span>
                        </td>
                        <td style="padding: 12px; text-align: center; color: #7f8c8d; font-size: 12px;">${st.dateDebut ? new Date(st.dateDebut).toLocaleDateString('fr-FR') : '-'}</td>
                        <td style="padding: 12px; text-align: center; color: #7f8c8d; font-size: 12px;">${st.dateFin ? new Date(st.dateFin).toLocaleDateString('fr-FR') : '-'}</td>
                        <td style="padding: 12px; text-align: center;">
                            <span style="background: ${prioriteColor}; color: white; padding: 5px 12px; border-radius: 15px; font-size: 11px; font-weight: 700; box-shadow: 0 2px 4px ${prioriteColor}44; display: inline-block;">
                                ${prioriteIcon} ${st.priorite}
                            </span>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <span style="background: ${statutColor}; color: white; padding: 5px 12px; border-radius: 15px; font-size: 11px; font-weight: 700; box-shadow: 0 2px 4px ${statutColor}44; display: inline-block;">
                                ${statutIcon} ${st.statut}
                            </span>
                        </td>
                        <td style="padding: 12px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="flex: 1; background: #ecf0f1; border-radius: 10px; height: 20px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); position: relative;">
                                    <div style="width: ${avancement}%; background: linear-gradient(90deg, ${barColor}, ${barColor}dd); height: 100%; transition: width 0.5s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.15);"></div>
                                    ${estManuel ? '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 10px;" title="Avancement manuel">‚úèÔ∏è</div>' : ''}
                                </div>
                                <span style="font-weight: 700; font-size: 12px; min-width: 42px; color: ${barColor};">${avancement}%</span>
                                <button onclick="modifierAvancementManuel(${st.id})" title="${estManuel ? 'Modifier l\'avancement manuel' : 'D√©finir un avancement manuel'}" 
                                    style="background: ${estManuel ? 'linear-gradient(135deg, #f39c12, #e67e22)' : 'linear-gradient(135deg, #95a5a6, #7f8c8d)'}; color: white; border: none; padding: 4px 8px; border-radius: 6px; font-size: 11px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"
                                    onmouseover="this.style.transform='scale(1.1)'"
                                    onmouseout="this.style.transform='scale(1)'">
                                    ${estManuel ? '‚úèÔ∏è' : '‚ûï'}
                                </button>
                                ${estManuel ? `<button onclick="reinitialiserAvancement(${st.id})" title="R√©initialiser (calcul auto)" style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; border: none; padding: 4px 8px; border-radius: 6px; font-size: 11px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.2);" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">‚Ü∫</button>` : ''}
                            </div>
                        </td>
                        <td style="padding: 12px; text-align: right; font-weight: 600; color: #34495e; font-size: 13px;">
                            <span style="color: ${realise > budget ? '#e74c3c' : '#27ae60'}; font-weight: 700;">${realise.toFixed(1)}h</span> / ${budget}h
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <div style="display: flex; gap: 6px; justify-content: center;">
                                <button class="btn btn-sm" onclick="modifierSousTache(${st.id})" title="Modifier" 
                                    style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none; padding: 6px 10px; border-radius: 6px; font-weight: 600; box-shadow: 0 2px 4px rgba(52,152,219,0.3); transition: all 0.2s;"
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(52,152,219,0.4)';"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(52,152,219,0.3)';">
                                    ‚úèÔ∏è
                                </button>
                                <button class="btn btn-sm" onclick="supprimerSousTache(${st.id})" title="Supprimer" 
                                    style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; border: none; padding: 6px 10px; border-radius: 6px; font-weight: 600; box-shadow: 0 2px 4px rgba(231,76,60,0.3); transition: all 0.2s;"
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(231,76,60,0.4)';"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(231,76,60,0.3)';">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html || '<tr><td colspan="11" style="text-align: center; padding: 40px; color: #95a5a6; font-size: 16px;"><div style="font-size: 48px; margin-bottom: 10px;">üìã</div>Aucune sous-t√¢che enregistr√©e</td></tr>';
            
            // Mettre √† jour le Kanban
            afficherKanban();
        }
        
        // Peupler le filtre des sous-t√¢ches
        function peuplerFiltreSousTaches() {
            const select = document.getElementById('filtreSousTaches');
            if (!select) return;
            
            const affairesUniques = {};
            sousTaches.forEach(st => {
                if (!affairesUniques[st.numAffaire]) {
                    affairesUniques[st.numAffaire] = st.designation;
                }
            });
            
            select.innerHTML = '<option value="">Toutes les affaires</option>';
            Object.entries(affairesUniques).forEach(([num, designation]) => {
                const option = document.createElement('option');
                option.value = num;
                option.textContent = `${num} - ${designation}`;
                select.appendChild(option);
            });
        }
        
        // Supprimer une affaire principale et toutes ses sous-t√¢ches
        function supprimerAffairePrincipale(numAffaire) {
            const sousTachesAffaire = sousTaches.filter(st => st.numAffaire === numAffaire);
            const nbSousTaches = sousTachesAffaire.length;
            
            if (!confirm(`Voulez-vous vraiment supprimer l'affaire ${numAffaire} et ses ${nbSousTaches} sous-t√¢che(s) ?`)) {
                return;
            }
            
            // Supprimer toutes les sous-t√¢ches de cette affaire
            sousTaches = sousTaches.filter(st => st.numAffaire !== numAffaire);
            
            // Supprimer les pointages associ√©s
            const idsSupprimes = sousTachesAffaire.map(st => st.id);
            pointages = pointages.filter(p => !idsSupprimes.includes(p.sousTacheId));
            
            sauvegarderDonnees();
            afficherAffaires();
            afficherNotification('‚úÖ Affaire supprim√©e', 'success');
        }
        
        // Modifier une sous-t√¢che
        function modifierSousTache(id) {
            const st = sousTaches.find(s => s.id === id);
            if (!st) return;
            
            // Passer en mode √©dition (√† impl√©menter selon vos besoins)
            afficherNotification('‚ö†Ô∏è Fonction en d√©veloppement', 'info');
        }
        
        // Modifier manuellement l'avancement d'une sous-t√¢che
        function modifierAvancementManuel(sousTacheId) {
            const st = sousTaches.find(s => s.id === sousTacheId);
            if (!st) return;
            
            const realise = calculerRealise(st.id);
            const budget = st.budgetHeures || 0;
            const avancementCalcule = budget > 0 ? Math.round((realise / budget) * 100) : 0;
            const avancementActuel = st.avancementManuel !== undefined ? st.avancementManuel : avancementCalcule;
            
            const nouveauAvancement = prompt(
                `üìä Modifier l'avancement de la sous-t√¢che\n\n` +
                `Affaire : ${st.numAffaire}\n` +
                `T√¢che : ${st.nom}\n\n` +
                `Budget : ${budget}h\n` +
                `R√©alis√© (pointages) : ${realise.toFixed(1)}h\n` +
                `Avancement calcul√© : ${avancementCalcule}%\n` +
                `Avancement actuel : ${avancementActuel}%\n\n` +
                `Entrez le nouvel avancement (0-100) :`,
                avancementActuel
            );
            
            if (nouveauAvancement === null) return;
            
            const avancement = parseInt(nouveauAvancement);
            if (isNaN(avancement) || avancement < 0 || avancement > 100) {
                afficherNotification('‚ùå Avancement invalide (0-100)', 'error');
                return;
            }
            
            st.avancementManuel = avancement;
            sauvegarderDonnees();
            afficherAffaires();
            afficherNotification(`‚úÖ Avancement modifi√© : ${avancement}%`, 'success');
        }
        
        // R√©initialiser l'avancement manuel (revenir au calcul auto)
        function reinitialiserAvancement(sousTacheId) {
            const st = sousTaches.find(s => s.id === sousTacheId);
            if (!st) return;
            
            if (!confirm('Voulez-vous r√©initialiser l\'avancement √† la valeur calcul√©e automatiquement ?')) {
                return;
            }
            
            delete st.avancementManuel;
            sauvegarderDonnees();
            afficherAffaires();
            afficherNotification('‚úÖ Avancement r√©initialis√© (calcul auto)', 'success');
        }
        
        // Supprimer une sous-t√¢che
        function supprimerSousTache(id) {
            if (!confirm('Voulez-vous vraiment supprimer cette sous-t√¢che ?')) {
                return;
            }
            
            sousTaches = sousTaches.filter(st => st.id !== id);
            pointages = pointages.filter(p => p.sousTacheId !== id);
            
            sauvegarderDonnees();
            afficherAffaires();
            afficherNotification('‚úÖ Sous-t√¢che supprim√©e', 'success');
        }
        
        function afficherKanban() {
            const statuts = ['en-attente', 'en-cours', 'termine', 'suspendu'];
            
            statuts.forEach(statut => {
                const container = document.getElementById(`kanban-${statut}`);
                const count = document.getElementById(`count-${statut}`);
                if (!container) return;
                
                const sousTachesStatut = sousTaches.filter(st => st.statut === statut);
                count.textContent = sousTachesStatut.length;
                
                let html = '';
                sousTachesStatut.forEach(st => {
                    const agent = agents.find(a => a.id == st.agentId);
                    const realise = calculerRealise(st.id);
                    const budget = st.budgetHeures || 0;
                    const avancement = budget > 0 ? Math.round((realise / budget) * 100) : 0;
                    
                    const prioriteColors = {
                        'faible': '#95a5a6',
                        'moyenne': '#3498db',
                        'haute': '#f39c12',
                        'urgente': '#e74c3c'
                    };
                    const prioriteColor = prioriteColors[st.priorite] || '#95a5a6';
                    
                    html += `
                        <div class="kanban-card" draggable="true" data-id="${st.id}">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <span style="font-weight: 600; color: #0066cc; font-size: 12px;">${st.numAffaire}</span>
                                <span style="background: ${prioriteColor}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600;">
                                    ${st.priorite}
                                </span>
                            </div>
                            <div style="font-weight: 500; margin-bottom: 6px; font-size: 13px;">${st.nom}</div>
                            <div style="font-size: 11px; color: #666; margin-bottom: 8px;">
                                üë§ ${agent ? agent.nom : 'Non assign√©'}
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px; margin-top: 8px;">
                                <div style="flex: 1; background: #e9ecef; border-radius: 8px; height: 12px; overflow: hidden;">
                                    <div style="width: ${avancement}%; background: #3498db; height: 100%;"></div>
                                </div>
                                <span style="font-size: 11px; font-weight: 600;">${avancement}%</span>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html || '<div style="padding: 15px; text-align: center; color: #999; font-size: 12px;">Aucune t√¢che</div>';
            });
        }
        
        function peuplerSelecteurAffaires() {
            const select = document.getElementById('affaireSelectionnee');
            if (!select) return;
            
            // Obtenir les affaires uniques
            const affairesUniques = {};
            sousTaches.forEach(st => {
                if (!affairesUniques[st.numAffaire]) {
                    affairesUniques[st.numAffaire] = {
                        numAffaire: st.numAffaire,
                        client: st.client,
                        designation: st.designation,
                        agentId: st.agentId,
                        dateFin: st.dateFin
                    };
                }
            });
            
            // Remplir le select
            select.innerHTML = '<option value="">-- Choisir une affaire --</option>';
            Object.values(affairesUniques).forEach(affaire => {
                const option = document.createElement('option');
                option.value = affaire.numAffaire;
                option.textContent = `${affaire.numAffaire} - ${affaire.designation}`;
                select.appendChild(option);
            });
        }
        
        // Afficher le r√©sum√© de l'affaire s√©lectionn√©e
        function afficherResumeAffaire() {
            const select = document.getElementById('affaireSelectionnee');
            const numAffaire = select.value;
            const resumeDiv = document.getElementById('resumeAffaire');
            
            if (!numAffaire) {
                resumeDiv.style.display = 'none';
                return;
            }
            
            // R√©cup√©rer les sous-t√¢ches de cette affaire
            const sousTachesAffaire = sousTaches.filter(st => st.numAffaire === numAffaire);
            if (sousTachesAffaire.length === 0) {
                resumeDiv.style.display = 'none';
                return;
            }
            
            const affaire = sousTachesAffaire[0];
            const agent = agents.find(a => a.id === affaire.agentId);
            
            // Calculer l'avancement global
            let budgetTotal = 0;
            let realiseTotal = 0;
            sousTachesAffaire.forEach(st => {
                budgetTotal += st.budgetHeures || 0;
                realiseTotal += calculerRealise(st.id);
            });
            const avancement = budgetTotal > 0 ? Math.round((realiseTotal / budgetTotal) * 100) : 0;
            
            // Afficher le r√©sum√©
            document.getElementById('resumeClient').textContent = affaire.client;
            document.getElementById('resumeDesignation').textContent = affaire.designation;
            document.getElementById('resumeResponsable').textContent = agent ? agent.nom : 'Non assign√©';
            document.getElementById('resumeDateFin').textContent = new Date(affaire.dateFin).toLocaleDateString('fr-FR');
            document.getElementById('resumeProgressBar').style.width = avancement + '%';
            document.getElementById('resumeProgressText').textContent = avancement + '%';
            
            resumeDiv.style.display = 'block';
        }
        
        // Ajouter une sous-t√¢che √† une affaire existante
        function ajouterSousTache(event) {
            event.preventDefault();
            
            const numAffaire = document.getElementById('affaireSelectionnee').value;
            if (!numAffaire) {
                afficherNotification('‚ùå Veuillez d\'abord s√©lectionner une affaire', 'error');
                return;
            }
            
            // R√©cup√©rer les infos de l'affaire
            const affaireExistante = sousTaches.find(st => st.numAffaire === numAffaire);
            if (!affaireExistante) {
                afficherNotification('‚ùå Affaire introuvable', 'error');
                return;
            }
            
            const typeDossier = document.getElementById('typeSousTache').value;
            const description = document.getElementById('descriptionSousTache').value.trim();
            const agentId = parseInt(document.getElementById('responsableSousTache').value);
            const dateDebut = document.getElementById('dateDebutSousTache').value;
            const dateFin = document.getElementById('dateFinSousTache').value;
            const priorite = document.getElementById('prioriteSousTache').value;
            
            // Validation
            if (!typeDossier || !description || !agentId || !dateDebut || !dateFin) {
                afficherNotification('‚ùå Tous les champs sont obligatoires', 'error');
                return;
            }
            
            if (new Date(dateDebut) > new Date(dateFin)) {
                afficherNotification('‚ùå La date de d√©but doit √™tre ant√©rieure √† la date de fin', 'error');
                return;
            }
            
            // Cr√©er la sous-t√¢che
            const nouvelleSousTache = {
                id: Date.now(),
                numAffaire: affaireExistante.numAffaire,
                annee: affaireExistante.annee || new Date().getFullYear(),
                client: affaireExistante.client,
                designation: affaireExistante.designation,
                nom: description,
                typeDossier: typeDossier,
                agentId: agentId,
                budgetHeures: 0, // Peut √™tre ajust√© plus tard
                budgetEuros: 0,
                dateDebut: dateDebut,
                dateFin: dateFin,
                priorite: priorite,
                statut: 'en-cours',
                dateCreation: new Date().toISOString()
            };
            
            sousTaches.push(nouvelleSousTache);
            sauvegarderDonnees();
            
            // R√©initialiser le formulaire
            document.getElementById('formSousTache').reset();
            document.getElementById('prioriteSousTache').value = 'basse';
            
            // Rafra√Æchir l'affichage
            afficherAffaires();
            afficherVueParAffaire();
            afficherSynthese();
            afficherResumeAffaire();
            
            afficherNotification('‚úÖ Sous-t√¢che ajout√©e avec succ√®s !', 'success');
        }

        function afficherVueParAffaire() {
            const container = document.getElementById('vueParAffaire');
            
            if (sousTaches.length === 0) {
                container.innerHTML = '<div class="empty-state">Aucune affaire √† afficher</div>';
                return;
            }
            
            // Grouper par affaire
            const parAffaire = {};
            sousTaches.forEach(st => {
                if (!parAffaire[st.numAffaire]) {
                    parAffaire[st.numAffaire] = {
                        client: st.client,
                        designation: st.designation,
                        sousTaches: []
                    };
                }
                parAffaire[st.numAffaire].sousTaches.push(st);
            });
            
            let html = '';
            
            for (const [numAffaire, affaire] of Object.entries(parAffaire)) {
                // Calculer l'avancement global pond√©r√© par budget heures
                const avancementGlobal = calculerAvancementAffaire(numAffaire);
                
                // Trouver le responsable principal (celui avec le plus d'heures)
                const responsableId = affaire.sousTaches.reduce((prev, curr) => 
                    curr.budgetHeures > (prev?.budgetHeures || 0) ? curr : prev
                ).agentId;
                const responsable = agents.find(a => a.id === responsableId);
                
                // Date de fin la plus lointaine
                const dateFin = new Date(Math.max(...affaire.sousTaches.map(st => new Date(st.dateFin))));
                
                // Trier les sous-t√¢ches par date de d√©but pour la timeline
                const tachesTriees = [...affaire.sousTaches].sort((a, b) => 
                    new Date(a.dateDebut) - new Date(b.dateDebut)
                );
                
                html += `
                <div class="affaire-detail">
                    <div class="affaire-header" onclick="toggleAffaireDetail('${numAffaire}')">
                        <div class="affaire-header-left">
                            <h3>üìã ${numAffaire} - ${affaire.designation}</h3>
                            <p>üë§ Client: ${affaire.client}</p>
                        </div>
                        <div class="affaire-header-right">
                            <div class="affaire-progress-circle">${avancementGlobal}%</div>
                            <div>${affaire.sousTaches.length} sous-t√¢che(s)</div>
                        </div>
                    </div>
                    <div class="affaire-body" id="detail-${numAffaire}">
                        <div class="affaire-resume">
                            <div class="resume-item">
                                <label>Client</label>
                                <value>${affaire.client}</value>
                            </div>
                            <div class="resume-item">
                                <label>D√©signation</label>
                                <value>${affaire.designation}</value>
                            </div>
                            <div class="resume-item">
                                <label>Responsable principal</label>
                                <value>${responsable ? responsable.nom : 'Non assign√©'}</value>
                            </div>
                            <div class="resume-item">
                                <label>Date fin pr√©vue</label>
                                <value>${dateFin.toLocaleDateString('fr-FR')}</value>
                            </div>
                            <div class="resume-item">
                                <label>Avancement global</label>
                                <value>${avancementGlobal}% (${totalRealise}h / ${totalBudget}h)</value>
                            </div>
                        </div>
                        
                        <h4 style="margin-bottom: 15px;">üìã Liste des sous-t√¢ches</h4>
                        <div class="sous-taches-list">`;
                
                affaire.sousTaches.forEach(st => {
                    const agent = agents.find(a => a.id === st.agentId);
                    const realise = calculerRealise(st.id);
                    const avancement = calculerAvancement(realise, st.budgetHeures);
                    
                    html += `
                    <div class="sous-tache-item priority-${st.priorite}">
                        <div class="sous-tache-header">
                            <div class="sous-tache-title">${st.nom}</div>
                            <div>
                                <span class="sous-tache-type">${getTypeLabel(st.typeSousTache)}</span>
                                <span class="priority-badge priority-${st.priorite}" style="margin-left: 5px;">
                                    ${st.priorite === 'urgente' ? 'üî¥' : st.priorite === 'haute' ? 'üü†' : st.priorite === 'normale' ? 'üü°' : 'üü¢'}
                                </span>
                            </div>
                        </div>
                        <div class="sous-tache-details">
                            <div>üë§ ${agent ? agent.nom : 'Non assign√©'}</div>
                            <div>üìÖ ${new Date(st.dateDebut).toLocaleDateString('fr-FR')} ‚Üí ${new Date(st.dateFin).toLocaleDateString('fr-FR')}</div>
                            <div>‚è±Ô∏è ${realise}h / ${st.budgetHeures}h (${avancement}%)</div>
                            <div>üìä ${st.statut === 'en-cours' ? 'En cours' : st.statut === 'termine' ? 'Termin√©' : st.statut === 'en-attente' ? 'En attente' : 'Suspendu'}</div>
                        </div>
                        <div style="margin-top: 10px;">
                            <div class="progress-bar-container">
                                <div class="progress-bar ${avancement >= 100 ? 'danger' : avancement >= 80 ? 'warning' : ''}" style="width: ${avancement}%"></div>
                                <div class="progress-text">${avancement}%</div>
                            </div>
                        </div>
                    </div>`;
                });
                
                html += `
                        </div>
                        
                        <h4 style="margin: 20px 0 15px 0;">üìÖ Timeline (ordre chronologique)</h4>
                        <div class="timeline-container">`;
                
                tachesTriees.forEach(st => {
                    html += `
                    <div class="timeline-item">
                        <div class="timeline-dot ${st.priorite}"></div>
                        <div class="timeline-content">
                            <strong>${st.nom}</strong>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                ${getTypeLabel(st.typeSousTache)} ‚Ä¢ 
                                ${new Date(st.dateDebut).toLocaleDateString('fr-FR')} ‚Üí ${new Date(st.dateFin).toLocaleDateString('fr-FR')}
                            </div>
                        </div>
                    </div>`;
                });
                
                html += `
                        </div>
                    </div>
                </div>`;
            }
            
            container.innerHTML = html;
        }

        function toggleAffaireDetail(numAffaire) {
            const detail = document.getElementById(`detail-${numAffaire}`);
            detail.classList.toggle('active');
        }

        function editerAffaire(id) {
            const st = sousTaches.find(s => s.id === id);
            if (!st) return;
            
            // Remplir le formulaire avec les donn√©es existantes
            document.getElementById('numAffaire').value = st.numAffaire;
            document.getElementById('clientAffaire').value = st.client;
            document.getElementById('designationAffaire').value = st.designation;
            document.getElementById('sousTache').value = st.nom;
            document.getElementById('typeSousTache').value = st.typeSousTache;
            document.getElementById('agentAssigne').value = st.agentId;
            document.getElementById('budgetHeures').value = st.budgetHeures;
            document.getElementById('dateDebut').value = st.dateDebut;
            document.getElementById('dateFin').value = st.dateFin;
            document.getElementById('priorite').value = st.priorite;
            document.getElementById('statutAffaire').value = st.statut;
            
            // Supprimer l'ancienne version
            sousTaches = sousTaches.filter(s => s.id !== id);
            
            // Scroll vers le formulaire
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            alert('üìù Modifiez les champs et cliquez sur "Ajouter" pour enregistrer les changements');
        }

        function supprimerSousTache(id) {
            const st = sousTaches.find(s => s.id === id);
            if (!st) return;
            
            if (confirm(`Voulez-vous vraiment supprimer la sous-t√¢che "${st.nom}" ?`)) {
                sousTaches = sousTaches.filter(s => s.id !== id);
                
                // Supprimer aussi les pointages associ√©s
                pointages = pointages.filter(p => p.sousTacheId !== id);
                
                sauvegarderDonnees();
                afficherAffaires();
                afficherVueParAffaire();
                afficherSynthese();
                afficherRetards();
                afficherHistoriquePointages();
            }
        }

        function afficherRetards() {
            const container = document.getElementById('listeRetards');
            const countBadge = document.getElementById('countRetards');
            
            const aujourdhui = new Date();
            aujourdhui.setHours(0, 0, 0, 0);
            
            // Trouver les affaires/sous-t√¢ches en retard
            const enRetard = sousTaches.filter(st => {
                const dateFin = new Date(st.dateFin);
                dateFin.setHours(0, 0, 0, 0);
                
                // En retard si la date de fin est d√©pass√©e et le statut n'est pas "termin√©"
                return dateFin < aujourdhui && st.statut !== 'termine';
            });
            
            countBadge.textContent = enRetard.length;
            
            if (enRetard.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px; font-size: 13px;">‚úÖ Aucun retard</div>';
                return;
            }
            
            // Trier par nombre de jours de retard (du plus ancien au plus r√©cent)
            enRetard.sort((a, b) => new Date(a.dateFin) - new Date(b.dateFin));
            
            let html = '';
            enRetard.forEach(st => {
                const dateFin = new Date(st.dateFin);
                const joursRetard = Math.floor((aujourdhui - dateFin) / (1000 * 60 * 60 * 24));
                const agent = agents.find(a => a.id === st.agentId);
                
                html += `<div class="retard-item">
                    <div class="retard-item-header">
                        <div class="retard-item-title">${st.numAffaire}</div>
                        <div class="retard-item-days">-${joursRetard}j</div>
                    </div>
                    <div class="retard-item-details">
                        <strong>${st.designation}</strong><br>
                        üìã ${st.nom}<br>
                        üë§ ${agent ? agent.nom : 'Non assign√©'}<br>
                        üìÖ Fin pr√©vue: ${dateFin.toLocaleDateString('fr-FR')}
                    </div>
                </div>`;
            });
            
            container.innerHTML = html;
        }

        function afficherSynthese() {
            const container = document.getElementById('syntheseAffaires');
            
            const totalAffaires = new Set(sousTaches.map(st => st.numAffaire)).size;
            const totalSousTaches = sousTaches.length;
            const totalAgents = agents.length;
            
            // Calculer les heures totales des pointages
            const totalHeures = pointages.reduce((sum, p) => sum + p.heures, 0);
            
            // Calculer le budget total et le r√©alis√© total
            const budgetTotal = sousTaches.reduce((sum, st) => sum + st.budgetHeures, 0);
            const realiseTotal = sousTaches.reduce((sum, st) => sum + calculerRealise(st.id), 0);
            
            // Nombre d'affaires en retard
            const aujourdhui = new Date();
            aujourdhui.setHours(0, 0, 0, 0);
            const nbRetards = sousTaches.filter(st => {
                const dateFin = new Date(st.dateFin);
                dateFin.setHours(0, 0, 0, 0);
                return dateFin < aujourdhui && st.statut !== 'termine';
            }).length;
            
            container.innerHTML = `
                <div class="stat-card">
                    <h3>Affaires</h3>
                    <div class="value">${totalAffaires}</div>
                </div>
                <div class="stat-card">
                    <h3>Sous-t√¢ches</h3>
                    <div class="value">${totalSousTaches}</div>
                </div>
                <div class="stat-card">
                    <h3>Budget Total</h3>
                    <div class="value">${budgetTotal}h</div>
                </div>
                <div class="stat-card">
                    <h3>R√©alis√© Total</h3>
                    <div class="value">${realiseTotal}h</div>
                </div>
                <div class="stat-card" style="background: ${nbRetards > 0 ? 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)' : 'linear-gradient(135deg, #28a745 0%, #20c997 100%)'}">
                    <h3>Retards</h3>
                    <div class="value">${nbRetards}</div>
                </div>
                <div class="stat-card">
                    <h3>Agents actifs</h3>
                    <div class="value">${totalAgents}</div>
                </div>
            `;
        }

        // ============================================
        // GESTION DES POINTAGES
        // ============================================
        // ============================================
        // GESTION TEMPS D√âTAILL√â (HH:MM) - S√©lecteurs s√©par√©s
        // ============================================
        
        function calculerTempsTotal() {
            // R√©cup√©rer les valeurs des s√©lecteurs
            const heures = parseInt(document.getElementById('heuresSelect').value) || 0;
            const minutes = parseInt(document.getElementById('minutesSelect').value) || 0;
            
            // Calculer le temps total en d√©cimal
            const heuresDecimales = heures + (minutes / 60);
            
            // Formater l'affichage HH:MM
            const heuresFormatees = String(heures).padStart(2, '0');
            const minutesFormatees = String(minutes).padStart(2, '0');
            const tempsFormate = `${heuresFormatees}:${minutesFormatees}`;
            
            // Mettre √† jour les affichages
            document.getElementById('tempsTotal').textContent = tempsFormate;
            document.getElementById('tempsDecimal').textContent = heuresDecimales.toFixed(2) + 'h';
            
            // Mettre √† jour le champ cach√© pour compatibilit√©
            document.getElementById('tempsDetailleInput').value = tempsFormate;
            
            // Animation visuelle
            const totalDiv = document.getElementById('tempsTotal');
            totalDiv.style.transform = 'scale(1.1)';
            setTimeout(() => {
                totalDiv.style.transform = 'scale(1)';
            }, 200);
        }
        
        function setTempsRapide(tempsHHMM, type) {
            // Parser le temps HH:MM
            const parts = tempsHHMM.split(':');
            const heures = parseInt(parts[0]);
            const minutes = parseInt(parts[1]);
            
            // Mettre √† jour les s√©lecteurs
            document.getElementById('heuresSelect').value = heures;
            document.getElementById('minutesSelect').value = minutes;
            
            // Mettre en √©vidence le bouton cliqu√©
            document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            
            // Recalculer le total
            calculerTempsTotal();
            
            // Stocker le type pour compatibilit√©
            tempsSelectionne = type;
        }
        
        function validerFormatTemps(input) {
            const valeur = input.value.trim();
            
            // Permettre saisie progressive
            if (valeur === '') {
                document.getElementById('tempsDecimal').textContent = '0.00h';
                document.getElementById('tempsDecimal').style.color = '#999';
                input.style.borderColor = '#ced4da';
                input.style.color = '#495057';
                return;
            }
            
            // Analyser le format saisi
            let heuresDecimales = null;
            let formatReconnu = false;
            
            // Format 1: Nombre d√©cimal avec point (ex: "7.5")
            if (/^\d{1,2}\.\d{1,2}$/.test(valeur)) {
                heuresDecimales = parseFloat(valeur);
                formatReconnu = true;
            }
            
            // Format 2: Nombre d√©cimal avec virgule (ex: "7,5")
            else if (/^\d{1,2},\d{1,2}$/.test(valeur)) {
                heuresDecimales = parseFloat(valeur.replace(',', '.'));
                formatReconnu = true;
            }
            
            // Format 3: Juste un nombre entier (ex: "7")
            else if (/^\d{1,2}$/.test(valeur)) {
                heuresDecimales = parseInt(valeur);
                formatReconnu = true;
            }
            
            // Format 4: Heures avec 'h' ou 'H' (ex: "7h30", "7H30", "7h", "7H")
            else if (/^\d{1,2}[hH]\d{0,2}$/.test(valeur)) {
                const parts = valeur.toLowerCase().split('h');
                const h = parseInt(parts[0]);
                const m = parts[1] ? parseInt(parts[1]) : 0;
                heuresDecimales = h + (m / 60);
                formatReconnu = true;
            }
            
            // Format 5: HH:MM standard (ex: "7:30", "07:30")
            else if (/^\d{1,2}:\d{1,2}$/.test(valeur)) {
                const parts = valeur.split(':');
                const h = parseInt(parts[0]);
                const m = parseInt(parts[1]);
                if (h >= 0 && h <= 24 && m >= 0 && m < 60) {
                    heuresDecimales = h + (m / 60);
                    formatReconnu = true;
                }
            }
            
            // Format 6: Nombre sans s√©parateur (ex: "730" pour 7:30, "800" pour 8:00)
            else if (/^\d{3,4}$/.test(valeur)) {
                const num = valeur.padStart(4, '0'); // "730" -> "0730"
                const h = parseInt(num.substring(0, 2));
                const m = parseInt(num.substring(2, 4));
                if (h >= 0 && h <= 24 && m >= 0 && m < 60) {
                    heuresDecimales = h + (m / 60);
                    formatReconnu = true;
                }
            }
            
            // Format 7: Formats incomplets pendant la saisie
            else if (/^\d{1,2}:$/.test(valeur)) {
                // "7:" -> en cours de saisie, afficher preview
                const h = parseInt(valeur.replace(':', ''));
                document.getElementById('tempsDecimal').textContent = h.toFixed(2) + 'h';
                document.getElementById('tempsDecimal').style.color = '#6c757d';
                input.style.borderColor = '#ffc107';
                input.style.color = '#495057';
                return;
            }
            else if (/^:\d{1,2}$/.test(valeur)) {
                // ":30" -> en cours de saisie
                const m = parseInt(valeur.replace(':', ''));
                document.getElementById('tempsDecimal').textContent = (m / 60).toFixed(2) + 'h';
                document.getElementById('tempsDecimal').style.color = '#6c757d';
                input.style.borderColor = '#ffc107';
                input.style.color = '#495057';
                return;
            }
            
            // Validation finale
            if (formatReconnu && heuresDecimales !== null) {
                if (heuresDecimales >= 0 && heuresDecimales <= 24) {
                    // Format valide ‚úì
                    document.getElementById('tempsDecimal').textContent = heuresDecimales.toFixed(2) + 'h';
                    document.getElementById('tempsDecimal').style.color = '#28a745';
                    input.style.borderColor = '#28a745';
                    input.style.color = '#28a745';
                } else {
                    // Hors limites (> 24h)
                    document.getElementById('tempsDecimal').textContent = 'Max 24h';
                    document.getElementById('tempsDecimal').style.color = '#dc3545';
                    input.style.borderColor = '#dc3545';
                    input.style.color = '#dc3545';
                }
            } else {
                // Format non reconnu
                document.getElementById('tempsDecimal').textContent = 'Format?';
                document.getElementById('tempsDecimal').style.color = '#ffc107';
                input.style.borderColor = '#ffc107';
                input.style.color = '#495057';
            }
        }
        
        function finaliserFormatTemps(input) {
            // Appel√©e au blur - convertit la saisie en format HH:MM standard
            const valeur = input.value.trim();
            
            if (valeur === '') return;
            
            let heuresDecimales = null;
            
            // Reconna√Ætre tous les formats
            if (/^\d{1,2}\.\d{1,2}$/.test(valeur)) {
                // "7.5" -> 7.5
                heuresDecimales = parseFloat(valeur);
            }
            else if (/^\d{1,2},\d{1,2}$/.test(valeur)) {
                // "7,5" -> 7.5
                heuresDecimales = parseFloat(valeur.replace(',', '.'));
            }
            else if (/^\d{1,2}$/.test(valeur)) {
                // "7" -> 7.0
                heuresDecimales = parseInt(valeur);
            }
            else if (/^\d{1,2}[hH]\d{0,2}$/.test(valeur)) {
                // "7h30" -> 7.5
                const parts = valeur.toLowerCase().split('h');
                const h = parseInt(parts[0]);
                const m = parts[1] ? parseInt(parts[1]) : 0;
                heuresDecimales = h + (m / 60);
            }
            else if (/^\d{1,2}:\d{1,2}$/.test(valeur)) {
                // "7:30" -> d√©j√† bon format, v√©rifier
                const parts = valeur.split(':');
                const h = parseInt(parts[0]);
                const m = parseInt(parts[1]);
                if (h >= 0 && h <= 24 && m >= 0 && m < 60) {
                    heuresDecimales = h + (m / 60);
                }
            }
            else if (/^\d{3,4}$/.test(valeur)) {
                // "730" -> 7:30
                const num = valeur.padStart(4, '0');
                const h = parseInt(num.substring(0, 2));
                const m = parseInt(num.substring(2, 4));
                if (h >= 0 && h <= 24 && m >= 0 && m < 60) {
                    heuresDecimales = h + (m / 60);
                }
            }
            else if (/^\d{1,2}:$/.test(valeur)) {
                // "7:" -> "7:00"
                heuresDecimales = parseInt(valeur.replace(':', ''));
            }
            else if (/^:\d{1,2}$/.test(valeur)) {
                // ":30" -> "0:30"
                const m = parseInt(valeur.replace(':', ''));
                heuresDecimales = m / 60;
            }
            
            // Convertir en format HH:MM standard
            if (heuresDecimales !== null && heuresDecimales >= 0 && heuresDecimales <= 24) {
                const h = Math.floor(heuresDecimales);
                const m = Math.round((heuresDecimales - h) * 60);
                const formatted = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                
                input.value = formatted;
                
                // Mise √† jour visuelle finale
                document.getElementById('tempsDecimal').textContent = heuresDecimales.toFixed(2) + 'h';
                document.getElementById('tempsDecimal').style.color = '#007bff';
                input.style.borderColor = '#28a745';
                input.style.color = '#28a745';
            }
        }
        
        function convertirTempsVersHeures(tempsHHMM) {
            // Convertit "07:30" -> 7.5
            const regex = /^(\d{1,2}):(\d{2})$/;
            const match = tempsHHMM.match(regex);
            
            if (match) {
                const heures = parseInt(match[1]);
                const minutes = parseInt(match[2]);
                return heures + (minutes / 60);
            }
            
            return 0;
        }
        
        function convertirHeuresVersTemps(heuresDecimales) {
            // Convertit 7.5 -> "07:30"
            const heures = Math.floor(heuresDecimales);
            const minutes = Math.round((heuresDecimales - heures) * 60);
            return `${String(heures).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }
        
        function formaterHeuresAffichage(heuresDecimales) {
            // Pour affichage: 7.5 -> "7h30"
            const heures = Math.floor(heuresDecimales);
            const minutes = Math.round((heuresDecimales - heures) * 60);
            
            if (minutes === 0) {
                return `${heures}h`;
            }
            return `${heures}h${String(minutes).padStart(2, '0')}`;
        }

        function selectTemps(type) {
            // Fonction legacy pour compatibilit√©
            document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            tempsSelectionne = type;
        }

        function enregistrerPointage() {
            const date = document.getElementById('datePointage').value;
            const agentId = parseInt(document.getElementById('agentPointage').value);
            const sousTacheId = parseInt(document.getElementById('sousTachePointage').value);
            
            // R√©cup√©rer le temps saisi (format HH:MM)
            const tempsInput = document.getElementById('tempsDetailleInput').value.trim();
            
            // ===== VALIDATIONS =====
            if (!date || !agentId || !sousTacheId) {
                afficherNotification('‚ö†Ô∏è Veuillez remplir tous les champs', 'error');
                return;
            }
            
            // Valider le format du temps
            if (!tempsInput) {
                afficherNotification('‚ö†Ô∏è Veuillez saisir le temps travaill√©', 'error');
                return;
            }
            
            const regex = /^(\d{1,2}):(\d{2})$/;
            const match = tempsInput.match(regex);
            if (!match) {
                afficherNotification('‚ùå Format temps invalide (utilisez HH:MM)', 'error');
                return;
            }
            
            const heuresTemps = parseInt(match[1]);
            const minutesTemps = parseInt(match[2]);
            if (heuresTemps < 0 || heuresTemps > 24 || minutesTemps < 0 || minutesTemps >= 60) {
                afficherNotification('‚ùå Temps invalide (0:00 √† 24:00)', 'error');
                return;
            }

            // Validation format date ISO
            const regexISO = /^\d{4}-\d{2}-\d{2}$/;
            if (!regexISO.test(date)) {
                afficherNotification('‚ùå La date doit √™tre au format YYYY-MM-DD', 'error');
                return;
            }

            // V√©rifier si la date est un jour f√©ri√©
            if (estJourFerie(date)) {
                if (!confirm(`‚ö†Ô∏è Le ${new Date(date).toLocaleDateString('fr-FR')} est un jour f√©ri√©. Voulez-vous vraiment enregistrer ce pointage ?`)) {
                    return;
                }
            }

            // R√©cup√©rer les nouveaux champs
            const heuresSup = parseFloat(document.getElementById('heuresSup')?.value || 0);
            const pauseMin = parseFloat(document.getElementById('pauseMin')?.value || 0);
            const typeAbsence = document.getElementById('typeAbsence')?.value || '';
            const motifAbsence = document.getElementById('motifAbsence')?.value || '';
            
            // Convertir le temps HH:MM en heures d√©cimales
            let heures = convertirTempsVersHeures(tempsInput);
            const tempsHHMM = tempsInput; // Garder le format original
            
            // Si c'est une absence, forcer heures = 0
            if (typeAbsence) {
                heures = 0;
            }
            
            // Calculer heures nettes (heures + sup - pause)
            const heuresNettes = heures + heuresSup - (pauseMin / 60);
            
            const pointage = {
                id: Date.now(),
                date,
                agentId,
                sousTacheId,
                heures,
                tempsHHMM,  // Format HH:MM pour affichage pr√©cis
                heuresSup,
                pauseMin,
                heuresNettes: Math.max(0, heuresNettes),
                type: tempsSelectionne || 'personnalise',
                typeAbsence,
                motifAbsence,
                statut: 'brouillon', // brouillon, valid√©, verrouill√©
                dateCreation: new Date().toISOString()
            };
            
            // V√©rifier d√©passement budget
            const sousTache = sousTaches.find(st => st.id === sousTacheId);
            if (sousTache) {
                const realise = calculerRealise(sousTacheId) + heuresNettes;
                const tauxConsommation = (realise / sousTache.budgetHeures) * 100;
                
                if (tauxConsommation > 80 && tauxConsommation < 100) {
                    afficherNotification(`‚ö†Ô∏è Attention : Consommation √† ${tauxConsommation.toFixed(0)}% du budget !`, 'warning');
                } else if (tauxConsommation >= 100) {
                    if (!confirm(`üö® D√©passement budget ! Consommation √† ${tauxConsommation.toFixed(0)}%. Continuer ?`)) {
                        return;
                    }
                }
            }
            
            pointages.push(pointage);
            sauvegarderDonnees();
            
            // R√©initialiser le formulaire
            document.getElementById('agentPointage').value = '';
            document.getElementById('sousTachePointage').value = '';
            document.getElementById('heuresSelect').value = '8';
            document.getElementById('minutesSelect').value = '0';
            calculerTempsTotal();
            document.getElementById('heuresSup').value = '0';
            document.getElementById('pauseMin').value = '0';
            document.getElementById('typeAbsence').value = '';
            document.getElementById('motifAbsence').value = '';
            document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('selected'));
            tempsSelectionne = null;
            
            // R√©initialiser le titre du formulaire
            document.getElementById('pointageTitre').innerHTML = 'Pointage du jour';
            document.getElementById('pointageTitre').style.background = '';
            
            // Masquer le bouton Annuler et nettoyer
            document.getElementById('btnAnnuler').style.display = 'none';
            window.pointageEnModification = null;
            
            afficherHistoriquePointages();
            afficherSynthese();
            
            afficherNotification(`‚úÖ Pointage de ${formaterHeuresAffichage(heures)} enregistr√© !`, 'success');
        }

        function afficherHistoriquePointages() {
            const container = document.getElementById('historiquePointages');
            
            if (pointages.length === 0) {
                container.innerHTML = '<div class="empty-state">Aucun pointage enregistr√©</div>';
                return;
            }
            
            // Trier par date d√©croissante
            const pointagesTries = [...pointages].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let html = '<div style="overflow-x: auto;"><table class="table"><thead><tr>';
            html += '<th>Date</th><th>Agent</th><th>Sous-t√¢che</th><th>Heures</th><th>Sup.</th><th>Pause</th><th>Net</th><th>Type</th><th>Statut</th><th>Actions</th>';
            html += '</tr></thead><tbody>';
            
            pointagesTries.forEach(p => {
                const agent = agents.find(a => a.id === p.agentId);
                const sousTache = sousTaches.find(st => st.id === p.sousTacheId);
                
                const badgeClass = p.type === 'jour' ? 'badge-success' : 
                                  p.type === 'demi' ? 'badge-warning' : 
                                  p.type === 'absent' ? 'badge-danger' : 'badge-info';
                
                // Badge statut
                let statutBadge = '';
                if (p.statut === 'verrouill√©') {
                    statutBadge = '<span class="badge" style="background: #6c757d;">üîí Verrouill√©</span>';
                } else if (p.statut === 'valid√©') {
                    statutBadge = '<span class="badge badge-success">‚úì Valid√©</span>';
                } else {
                    statutBadge = '<span class="badge" style="background: #ffc107; color: #333;">üìù Brouillon</span>';
                }
                
                // Affichage heures au format HH:MM si disponible
                const heuresAffichage = p.tempsHHMM ? 
                    `<strong>${p.tempsHHMM}</strong>` : 
                    formaterHeuresAffichage(p.heures || 0);
                
                // Badge heures sup
                const heuresSupBadge = (p.heuresSup && p.heuresSup > 0) ? 
                    `<span style="color: #e74c3c; font-weight: bold;">+${formaterHeuresAffichage(p.heuresSup)}</span>` : '-';
                
                // Pause
                const pauseText = (p.pauseMin && p.pauseMin > 0) ? 
                    `${p.pauseMin}min` : '-';
                
                // Heures nettes avec badge si diff√©rent des heures de base
                const heuresNettes = p.heuresNettes || p.heures || 0;
                const heuresNettesAffichage = heuresNettes !== (p.heures || 0) ? 
                    `<strong style="color: #007bff;">${formaterHeuresAffichage(heuresNettes)}</strong>` : 
                    formaterHeuresAffichage(heuresNettes);
                
                // Actions selon le statut
                let actions = '';
                if (p.statut === 'verrouill√©') {
                    actions = '<span style="color: #999; font-size: 11px;">Verrouill√©</span>';
                } else if (p.statut === 'valid√©') {
                    actions = `<button class="btn btn-small" style="background: #ffc107;" onclick="deverrouillerPointage(${p.id})" title="D√©verrouiller">üîì</button>
                               <button class="btn btn-small" style="background: #6c757d;" onclick="verrouillerPointage(${p.id})" title="Verrouiller d√©finitivement">üîí</button>`;
                } else {
                    actions = `<button class="btn btn-primary btn-small" onclick="modifierPointage(${p.id})" title="Modifier">‚úèÔ∏è</button>
                               <button class="btn btn-success btn-small" onclick="validerPointage(${p.id})" title="Valider">‚úì</button>
                               <button class="btn btn-danger btn-small" onclick="supprimerPointage(${p.id})" title="Supprimer">üóëÔ∏è</button>`;
                }
                
                // Tooltip avec d√©tails
                let tooltip = `${sousTache ? sousTache.numAffaire + ' - ' + sousTache.nom : 'Inconnu'}`;
                if (p.typeAbsence) {
                    tooltip += ` | Absence: ${p.typeAbsence}`;
                }
                if (p.motifAbsence) {
                    tooltip += ` | Motif: ${p.motifAbsence}`;
                }
                
                html += `<tr ${p.statut === 'verrouill√©' ? 'style="background: #f8f9fa; opacity: 0.8;"' : ''}>
                    <td>${new Date(p.date).toLocaleDateString('fr-FR')}</td>
                    <td>${agent ? agent.nom : 'Inconnu'}</td>
                    <td title="${tooltip}">${sousTache ? `${sousTache.numAffaire}` : 'Inconnu'}</td>
                    <td>${heuresAffichage}</td>
                    <td>${heuresSupBadge}</td>
                    <td>${pauseText}</td>
                    <td>${heuresNettesAffichage}</td>
                    <td><span class="badge ${badgeClass}">${p.type || 'personnalis√©'}</span></td>
                    <td>${statutBadge}</td>
                    <td>${actions}</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function validerPointage(id) {
            const pointage = pointages.find(p => p.id === id);
            if (pointage && pointage.statut === 'brouillon') {
                pointage.statut = 'valid√©';
                sauvegarderDonnees();
                afficherHistoriquePointages();
                afficherNotification('‚úÖ Pointage valid√©', 'success');
            }
        }

        function deverrouillerPointage(id) {
            if (confirm('D√©verrouiller ce pointage valid√© ?')) {
                const pointage = pointages.find(p => p.id === id);
                if (pointage && pointage.statut === 'valid√©') {
                    pointage.statut = 'brouillon';
                    sauvegarderDonnees();
                    afficherHistoriquePointages();
                    afficherNotification('üîì Pointage d√©verrouill√©', 'success');
                }
            }
        }

        function verrouillerPointage(id) {
            if (confirm('‚ö†Ô∏è Verrouiller d√©finitivement ce pointage ? Il ne pourra plus √™tre modifi√©.')) {
                const pointage = pointages.find(p => p.id === id);
                if (pointage) {
                    pointage.statut = 'verrouill√©';
                    sauvegarderDonnees();
                    afficherHistoriquePointages();
                    afficherNotification('üîí Pointage verrouill√©', 'success');
                }
            }
        }

        function supprimerPointage(id) {
            const pointage = pointages.find(p => p.id === id);
            if (pointage && pointage.statut !== 'brouillon') {
                afficherNotification('‚ùå Impossible de supprimer un pointage valid√© ou verrouill√©', 'error');
                return;
            }
            
            if (confirm('Voulez-vous vraiment supprimer ce pointage ?')) {
                pointages = pointages.filter(p => p.id !== id);
                sauvegarderDonnees();
                afficherHistoriquePointages();
                afficherSynthese();
                afficherNotification('üóëÔ∏è Pointage supprim√©', 'success');
            }
        }

        function modifierPointage(id) {
            const pointage = pointages.find(p => p.id === id);
            
            if (!pointage) {
                afficherNotification('‚ùå Pointage introuvable', 'error');
                return;
            }
            
            if (pointage.statut !== 'brouillon') {
                afficherNotification('‚ùå Seuls les pointages en brouillon peuvent √™tre modifi√©s', 'error');
                return;
            }
            
            // Stocker l'ID du pointage en cours de modification (pour restauration si annul√©)
            window.pointageEnModification = { ...pointage };
            
            // Changer le titre pour indiquer la modification
            const agent = agents.find(a => a.id === pointage.agentId);
            const datePointage = new Date(pointage.date).toLocaleDateString('fr-FR');
            document.getElementById('pointageTitre').innerHTML = `‚úèÔ∏è Modification du pointage - ${agent ? agent.nom : ''} (${datePointage})`;
            document.getElementById('pointageTitre').style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
            
            // Afficher le bouton Annuler
            document.getElementById('btnAnnuler').style.display = 'block';
            
            // Pr√©-remplir le formulaire avec les donn√©es existantes
            document.getElementById('datePointage').value = pointage.date;
            document.getElementById('agentPointage').value = pointage.agentId;
            document.getElementById('sousTachePointage').value = pointage.sousTacheId;
            
            // Pr√©-remplir le temps avec les s√©lecteurs
            let tempsHHMM = pointage.tempsHHMM;
            if (!tempsHHMM && pointage.heures) {
                tempsHHMM = convertirHeuresVersTemps(pointage.heures);
            }
            
            if (tempsHHMM) {
                const parts = tempsHHMM.split(':');
                document.getElementById('heuresSelect').value = parseInt(parts[0]);
                document.getElementById('minutesSelect').value = parseInt(parts[1]);
                calculerTempsTotal();
            }
            
            // Pr√©-remplir les champs optionnels
            document.getElementById('heuresSup').value = pointage.heuresSup || 0;
            document.getElementById('pauseMin').value = pointage.pauseMin || 0;
            document.getElementById('typeAbsence').value = pointage.typeAbsence || '';
            document.getElementById('motifAbsence').value = pointage.motifAbsence || '';
            
            // Supprimer l'ancien pointage (il sera recr√©√© avec enregistrerPointage)
            pointages = pointages.filter(p => p.id !== id);
            
            // Scroller vers le formulaire
            document.querySelector('#tab-pointage').scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            afficherNotification('‚úèÔ∏è Modification en cours - Modifiez les champs et cliquez sur "Enregistrer"', 'info');
        }

        function annulerModification() {
            if (window.pointageEnModification) {
                // Restaurer le pointage original
                pointages.push(window.pointageEnModification);
                sauvegarderDonnees();
                window.pointageEnModification = null;
                
                // R√©initialiser le formulaire
                document.getElementById('agentPointage').value = '';
                document.getElementById('sousTachePointage').value = '';
                document.getElementById('heuresSelect').value = '8';
                document.getElementById('minutesSelect').value = '0';
                calculerTempsTotal();
                document.getElementById('heuresSup').value = '0';
                document.getElementById('pauseMin').value = '0';
                document.getElementById('typeAbsence').value = '';
                document.getElementById('motifAbsence').value = '';
                document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('selected'));
                
                // R√©initialiser le titre
                document.getElementById('pointageTitre').innerHTML = 'Pointage du jour';
                document.getElementById('pointageTitre').style.background = '';
                
                // Cacher le bouton Annuler
                document.getElementById('btnAnnuler').style.display = 'none';
                
                afficherHistoriquePointages();
                afficherNotification('‚ùå Modification annul√©e', 'info');
            }
        }


        // ============================================
        // GANTT CHART AVANC√â
        // ============================================
        function afficherGantt() {
            const container = document.getElementById('ganttContainer');
            
            // R√©cup√©rer les filtres
            const filtrePriorite = document.getElementById('ganttFiltrePriorite').value;
            const filtreStatut = document.getElementById('ganttFiltreStatut').value;
            const afficherCheminCrit = document.getElementById('afficherCheminCritique')?.checked || false;
            const afficherBase = document.getElementById('afficherBaseline')?.checked || false;
            
            // Calculer le chemin critique si demand√©
            const cheminCritique = afficherCheminCrit ? calculerCheminCritique() : new Set();
            
            // Filtrer les sous-t√¢ches
            let tachesFiltrees = sousTaches.filter(st => {
                if (filtrePriorite !== 'toutes' && st.priorite !== filtrePriorite) return false;
                if (filtreStatut !== 'tous' && st.statut !== filtreStatut) return false;
                return true;
            });
            
            if (tachesFiltrees.length === 0) {
                container.innerHTML = '<div class="empty-state">Aucune t√¢che √† afficher dans le Gantt</div>';
                return;
            }
            
            // Trouver les dates min et max
            const dates = tachesFiltrees.flatMap(st => [new Date(st.dateDebut), new Date(st.dateFin)]);
            const dateMin = new Date(Math.min(...dates));
            const dateMax = new Date(Math.max(...dates));
            
            // Ajouter une marge
            dateMin.setDate(dateMin.getDate() - 3);
            dateMax.setDate(dateMax.getDate() + 3);
            
            // Calculer la dur√©e totale selon l'√©chelle
            const dureeJours = Math.ceil((dateMax - dateMin) / (1000 * 60 * 60 * 24)) + 1;
            
            // G√©n√©rer les marqueurs de dates selon l'√©chelle
            const marqueurs = genererMarqueursTemporels(dateMin, dateMax, ganttEchelle);
            
            // Calculer la largeur de la timeline avec le zoom
            const largeurBase = Math.max(1000, dureeJours * (ganttEchelle === 'jours' ? 30 : ganttEchelle === 'semaines' ? 100 : 150));
            const largeurTimeline = largeurBase * (ganttZoom / 100);
            
            let html = '<div class="gantt-chart">';
            
            // En-t√™te
            html += '<div class="gantt-header">';
            html += '<div class="gantt-task-name">T√¢che / Affaire</div>';
            html += `<div class="gantt-timeline-header" style="width: ${largeurTimeline}px; position: relative;">`;
            
            // Marqueurs temporels
            marqueurs.forEach(m => {
                const offsetJours = Math.floor((m.date - dateMin) / (1000 * 60 * 60 * 24));
                const left = (offsetJours / dureeJours) * 100;
                const isToday = m.isToday;
                
                html += `<div class="gantt-date-label ${isToday ? 'gantt-today-label' : ''}" style="left: ${left}%;">
                    ${m.label}
                </div>`;
            });
            
            html += '</div></div>';
            
            // Trier par affaire puis par date de d√©but
            tachesFiltrees.sort((a, b) => {
                if (a.numAffaire !== b.numAffaire) {
                    return a.numAffaire.localeCompare(b.numAffaire);
                }
                return new Date(a.dateDebut) - new Date(b.dateDebut);
            });
            
            // Lignes des t√¢ches
            tachesFiltrees.forEach(st => {
                const agent = agents.find(a => a.id === st.agentId);
                const debut = new Date(st.dateDebut);
                const fin = new Date(st.dateFin);
                const realise = calculerRealise(st.id);
                const avancement = calculerAvancement(realise, st.budgetHeures);
                
                // Calculer la position et la largeur de la barre
                const offsetJours = Math.floor((debut - dateMin) / (1000 * 60 * 60 * 24));
                const dureeJoursTache = Math.ceil((fin - debut) / (1000 * 60 * 60 * 24)) + 1;
                
                const left = (offsetJours / dureeJours) * 100;
                const width = (dureeJoursTache / dureeJours) * 100;
                
                // D√©terminer la classe de couleur selon l'avancement
                let avancementClass = 'avancement-0-50';
                if (st.statut === 'termine') {
                    avancementClass = 'termine';
                } else if (avancement >= 100) {
                    avancementClass = 'avancement-100-plus';
                } else if (avancement >= 80) {
                    avancementClass = 'avancement-80-100';
                } else if (avancement >= 50) {
                    avancementClass = 'avancement-50-80';
                }
                
                const prioriteClass = st.priorite === 'urgente' ? 'priorite-urgente' : '';
                const cheminCritiqueClass = cheminCritique.has(st.id) ? 'chemin-critique' : '';
                
                html += '<div class="gantt-row">';
                html += `<div class="gantt-task-info">
                    <div class="gantt-task-title">
                        ${st.numAffaire} - ${st.nom}
                        ${cheminCritique.has(st.id) ? '<span style="color: #e74c3c; font-weight: bold; margin-left: 5px;">üî¥ Critique</span>' : ''}
                    </div>
                    <div class="gantt-task-subtitle">
                        ${agent ? agent.nom : 'Non assign√©'} ‚Ä¢ ${getTypeLabel(st.typeSousTache)}
                        <br>
                        <span class="priority-badge priority-${st.priorite}" style="margin-top: 3px; display: inline-block;">
                            ${st.priorite === 'urgente' ? 'üî¥' : st.priorite === 'haute' ? 'üü†' : st.priorite === 'normale' ? 'üü°' : 'üü¢'}
                        </span>
                    </div>
                </div>`;
                
                html += `<div class="gantt-timeline-content" style="width: ${largeurTimeline}px; position: relative;">`;
                
                // Marqueurs de dates (lignes verticales)
                marqueurs.forEach(m => {
                    const offsetJours = Math.floor((m.date - dateMin) / (1000 * 60 * 60 * 24));
                    const markerLeft = (offsetJours / dureeJours) * 100;
                    html += `<div class="gantt-date-marker ${m.isToday ? 'today' : ''}" style="left: ${markerLeft}%;"></div>`;
                });
                
                // Afficher la baseline si demand√©
                if (afficherBase && baseline) {
                    const baselineTask = baseline.taches.find(t => t.id === st.id);
                    if (baselineTask) {
                        const baseDebut = new Date(baselineTask.dateDebut);
                        const baseFin = new Date(baselineTask.dateFin);
                        const baseOffsetJours = Math.floor((baseDebut - dateMin) / (1000 * 60 * 60 * 24));
                        const baseDureeJours = Math.ceil((baseFin - baseDebut) / (1000 * 60 * 60 * 24)) + 1;
                        const baseLeft = (baseOffsetJours / dureeJours) * 100;
                        const baseWidth = (baseDureeJours / dureeJours) * 100;
                        
                        html += `<div class="gantt-baseline-bar" 
                            style="left: ${baseLeft}%; width: ${baseWidth}%;"
                            title="Baseline: ${baseDebut.toLocaleDateString('fr-FR')} ‚Üí ${baseFin.toLocaleDateString('fr-FR')}">
                        </div>`;
                    }
                }
                
                // Barre de la t√¢che actuelle
                html += `<div class="gantt-bar ${avancementClass} ${prioriteClass} ${cheminCritiqueClass}" 
                    style="left: ${left}%; width: ${width}%;"
                    title="${st.nom} - ${debut.toLocaleDateString('fr-FR')} ‚Üí ${fin.toLocaleDateString('fr-FR')} - ${avancement}%">
                    <div class="gantt-bar-content">
                        <span class="gantt-bar-text">${st.nom}</span>
                        <span class="gantt-bar-progress">${avancement}%</span>
                    </div>
                </div>`;
                
                // Afficher les fl√®ches de d√©pendances
                const depsSource = dependances.filter(d => d.sourceId === st.id);
                depsSource.forEach(dep => {
                    const cible = tachesFiltrees.find(t => t.id === dep.cibleId);
                    if (cible) {
                        const cibleDebut = new Date(cible.dateDebut);
                        const cibleOffset = Math.floor((cibleDebut - dateMin) / (1000 * 60 * 60 * 24));
                        const cibleLeft = (cibleOffset / dureeJours) * 100;
                        
                        // Dessiner une fl√®che simple (ligne)
                        html += `<div class="gantt-dependency-arrow" 
                            style="position: absolute; left: ${left + width}%; width: ${Math.abs(cibleLeft - (left + width))}%; top: 50%; height: 2px; background: #007bff; z-index: 1;"
                            title="D√©pendance ${dep.type}">
                        </div>`;
                    }
                });
                
                html += '</div></div>';
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function genererMarqueursTemporels(dateMin, dateMax, echelle) {
            const marqueurs = [];
            const aujourdhui = new Date();
            aujourdhui.setHours(0, 0, 0, 0);
            
            if (echelle === 'jours') {
                // Marqueurs par jour
                let date = new Date(dateMin);
                while (date <= dateMax) {
                    const isToday = date.getTime() === aujourdhui.getTime();
                    marqueurs.push({
                        date: new Date(date),
                        label: `${date.getDate()}/${date.getMonth() + 1}`,
                        isToday
                    });
                    date.setDate(date.getDate() + 1);
                }
            } else if (echelle === 'semaines') {
                // Marqueurs par semaine (lundi de chaque semaine)
                let date = new Date(dateMin);
                // Aller au lundi de la semaine
                while (date.getDay() !== 1) {
                    date.setDate(date.getDate() + 1);
                }
                
                while (date <= dateMax) {
                    const isToday = date.getTime() === aujourdhui.getTime();
                    const finSemaine = new Date(date);
                    finSemaine.setDate(finSemaine.getDate() + 6);
                    
                    marqueurs.push({
                        date: new Date(date),
                        label: `S${getNumeroSemaine(date)} (${date.getDate()}/${date.getMonth() + 1})`,
                        isToday
                    });
                    date.setDate(date.getDate() + 7);
                }
            } else if (echelle === 'mois') {
                // Marqueurs par mois
                let date = new Date(dateMin.getFullYear(), dateMin.getMonth(), 1);
                
                while (date <= dateMax) {
                    const isToday = date.getMonth() === aujourdhui.getMonth() && 
                                   date.getFullYear() === aujourdhui.getFullYear();
                    const mois = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Ao√ª', 'Sep', 'Oct', 'Nov', 'D√©c'];
                    
                    marqueurs.push({
                        date: new Date(date),
                        label: `${mois[date.getMonth()]} ${date.getFullYear()}`,
                        isToday
                    });
                    date.setMonth(date.getMonth() + 1);
                }
            }
            
            return marqueurs;
        }

        function getNumeroSemaine(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function changerEchelleGantt() {
            ganttEchelle = document.getElementById('ganttEchelle').value;
            afficherGantt();
        }

        function zoomGantt(direction) {
            // direction: -1 pour zoom out, 1 pour zoom in
            if (direction > 0) {
                ganttZoom = Math.min(200, ganttZoom + 25);
            } else {
                ganttZoom = Math.max(50, ganttZoom - 25);
            }
            
            document.getElementById('zoomLevel').textContent = ganttZoom + '%';
            afficherGantt();
        }

        function rafraichirGantt() {
            afficherGantt();
            
            // Animation de feedback
            const btn = event.target;
            btn.textContent = '‚úì Rafra√Æchi';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-secondary');
            
            setTimeout(() => {
                btn.textContent = 'üîÑ Rafra√Æchir';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-secondary');
            }, 1500);
        }

        function exporterGanttPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // Paysage pour le Gantt
            
            // R√©cup√©rer les filtres
            const filtrePriorite = document.getElementById('ganttFiltrePriorite').value;
            const filtreStatut = document.getElementById('ganttFiltreStatut').value;
            const echelle = ganttEchelle;
            
            // Filtrer les sous-t√¢ches
            let tachesFiltrees = sousTaches.filter(st => {
                if (filtrePriorite !== 'toutes' && st.priorite !== filtrePriorite) return false;
                if (filtreStatut !== 'tous' && st.statut !== filtreStatut) return false;
                return true;
            });
            
            if (tachesFiltrees.length === 0) {
                afficherNotification('‚ùå Aucune t√¢che √† afficher avec les filtres actuels.', 'error');
                return;
            }
            
            // Ajouter l'en-t√™te CNIM
            let sousTitre = `√âchelle: ${echelle}`;
            if (filtrePriorite !== 'toutes') sousTitre += ` | Priorit√©: ${filtrePriorite}`;
            if (filtreStatut !== 'tous') sousTitre += ` | Statut: ${filtreStatut}`;
            let yPos = ajouterEnteteCNIM(doc, 'Diagramme de Gantt - Planning des Affaires', sousTitre);
            
            // Tableau des t√¢ches
            let y = yPos + 5;
            const lineHeight = 8;
            const maxY = 190; // Limite avant nouvelle page
            
            doc.setFontSize(9);
            
            // En-t√™te du tableau
            doc.setFillColor(0, 102, 204); // Bleu CNIM
            doc.setTextColor(255, 255, 255);
            doc.rect(10, y, 70, 7, 'F');
            doc.rect(80, y, 50, 7, 'F');
            doc.rect(130, y, 25, 7, 'F');
            doc.rect(155, y, 25, 7, 'F');
            doc.rect(180, y, 30, 7, 'F');
            doc.rect(210, y, 77, 7, 'F');
            
            doc.text('Affaire', 12, y + 5);
            doc.text('Agent', 82, y + 5);
            doc.text('D√©but', 132, y + 5);
            doc.text('Fin', 157, y + 5);
            doc.text('Statut', 182, y + 5);
            doc.text('Avancement', 212, y + 5);
            
            y += 7;
            
            // Lignes de donn√©es
            tachesFiltrees.slice(0, 20).forEach((st, index) => { // Limit√© √† 20 t√¢ches
                if (y > maxY) {
                    doc.addPage();
                    y = 20;
                }
                
                const agent = agents.find(a => a.id === st.agentId);
                const heuresRealisees = pointages
                    .filter(p => p.sousTacheId === st.id)
                    .reduce((sum, p) => sum + p.heures, 0);
                const avancement = st.budgetHeures > 0 
                    ? Math.round((heuresRealisees / st.budgetHeures) * 100) 
                    : 0;
                
                // Couleur de fond altern√©e
                if (index % 2 === 0) {
                    doc.setFillColor(248, 249, 250);
                    doc.rect(10, y, 277, lineHeight, 'F');
                }
                
                doc.setTextColor(60, 60, 60);
                doc.setFontSize(8);
                
                // Donn√©es
                doc.text(`${st.numAffaire} - ${st.nom.substring(0, 25)}`, 12, y + 5);
                doc.text(agent ? agent.nom : 'N/A', 82, y + 5);
                doc.text(new Date(st.dateDebut).toLocaleDateString('fr-FR'), 132, y + 5);
                doc.text(new Date(st.dateFin).toLocaleDateString('fr-FR'), 157, y + 5);
                
                // Statut avec couleur
                const statutColors = {
                    'en-attente': [108, 117, 125],
                    'en-cours': [0, 123, 255],
                    'termine': [40, 167, 69],
                    'suspendu': [220, 53, 69]
                };
                const color = statutColors[st.statut] || [100, 100, 100];
                doc.setTextColor(...color);
                doc.text(st.statut, 182, y + 5);
                
                // Barre de progression
                doc.setDrawColor(200, 200, 200);
                doc.rect(212, y + 1.5, 60, 5);
                
                // Couleur de la barre selon l'avancement
                let barColor;
                if (avancement <= 50) barColor = [40, 167, 69]; // Vert
                else if (avancement <= 80) barColor = [255, 193, 7]; // Jaune
                else if (avancement <= 100) barColor = [253, 126, 20]; // Orange
                else barColor = [220, 53, 69]; // Rouge
                
                doc.setFillColor(...barColor);
                const barWidth = Math.min(60, (avancement / 100) * 60);
                doc.rect(212, y + 1.5, barWidth, 5, 'F');
                
                // Texte pourcentage
                doc.setTextColor(60, 60, 60);
                doc.setFontSize(7);
                doc.text(`${avancement}%`, 275, y + 5);
                
                y += lineHeight;
            });
            
            // L√©gende
            y += 5;
            if (y > maxY - 30) {
                doc.addPage();
                y = 20;
            }
            
            doc.setFontSize(10);
            doc.setTextColor(60, 60, 60);
            doc.text('L√©gende Avancement:', 10, y);
            y += 6;
            
            doc.setFontSize(8);
            const legendeItems = [
                { color: [40, 167, 69], label: '0-50% : En bonne voie' },
                { color: [255, 193, 7], label: '50-80% : Attention' },
                { color: [253, 126, 20], label: '80-100% : Presque d√©pass√©' },
                { color: [220, 53, 69], label: '>100% : D√©passement budget' }
            ];
            
            legendeItems.forEach((item, i) => {
                doc.setFillColor(...item.color);
                doc.rect(10 + (i * 70), y, 4, 4, 'F');
                doc.setTextColor(60, 60, 60);
                doc.text(item.label, 16 + (i * 70), y + 3);
            });
            
            // Pied de page
            doc.setFontSize(7);
            doc.setTextColor(150, 150, 150);
            doc.text('Document g√©n√©r√© automatiquement par l\'application de gestion de pointage', 148, 200, { align: 'center' });
            
            // Avertissement si trop de t√¢ches
            if (tachesFiltrees.length > 20) {
                doc.setTextColor(220, 53, 69);
                doc.text(`Note: Seules les 20 premi√®res t√¢ches sur ${tachesFiltrees.length} sont affich√©es`, 148, 203, { align: 'center' });
            }
            
            
            // Ajouter pied de page CNIM
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                ajouterPiedDePageCNIM(doc, i, totalPages);
            }
            
            // Sauvegarder
            const dateStr = new Date().toISOString().split('T')[0];
            doc.save(`Gantt_Planning_CNIM_${dateStr}.pdf`);
            
            afficherNotification('‚úÖ Export PDF Gantt g√©n√©r√© avec logo CNIM !', 'success');
        }

        // ============================================
        // POINTAGE MENSUEL
        // ============================================
        function peuplerAgentJournalier() {
            const select = document.getElementById('agentJournalier');
            select.innerHTML = '<option value="">S√©lectionner un agent...</option>';
            agents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.id;
                option.textContent = agent.nom;
                select.appendChild(option);
            });
            
            // D√©finir le mois courant
            const maintenant = new Date();
            document.getElementById('moisJournalier').value = maintenant.getMonth();
            document.getElementById('anneeJournalier').value = maintenant.getFullYear();
        }

        // ============================================
        // AUTO-REMPLISSAGE INTELLIGENT
        // ============================================
        function repeterSemainePrecedente() {
            const agentId = document.getElementById('agentJournalier').value;
            const mois = parseInt(document.getElementById('moisJournalier').value);
            const annee = parseInt(document.getElementById('anneeJournalier').value);
            
            if (!agentId) {
                afficherNotification('‚ö†Ô∏è Veuillez s√©lectionner un agent', 'error');
                return;
            }
            
            if (!confirm('R√©p√©ter les pointages de la semaine pr√©c√©dente sur la semaine courante ?\n(Les week-ends et jours f√©ri√©s seront ignor√©s)')) {
                return;
            }
            
            const maintenant = new Date(annee, mois, new Date().getDate());
            const aujourdHui = new Date(maintenant);
            const jourSemaine = aujourdHui.getDay(); // 0 = dimanche, 1 = lundi, etc.
            
            // Trouver le lundi de cette semaine
            const lundiCetteSemaine = new Date(aujourdHui);
            lundiCetteSemaine.setDate(aujourdHui.getDate() - (jourSemaine === 0 ? 6 : jourSemaine - 1));
            
            // Trouver le lundi de la semaine pr√©c√©dente
            const lundiSemainePrecedente = new Date(lundiCetteSemaine);
            lundiSemainePrecedente.setDate(lundiCetteSemaine.getDate() - 7);
            
            // R√©cup√©rer les pointages de la semaine pr√©c√©dente pour cet agent
            const pointagesSemainePrecedente = pointages.filter(p => {
                const dateP = new Date(p.date);
                const diff = Math.floor((dateP - lundiSemainePrecedente) / (1000 * 60 * 60 * 24));
                return p.agentId == agentId && diff >= 0 && diff < 7;
            });
            
            if (pointagesSemainePrecedente.length === 0) {
                afficherNotification('‚ÑπÔ∏è Aucun pointage trouv√© dans la semaine pr√©c√©dente', 'warning');
                return;
            }
            
            let nbCopies = 0;
            
            // Copier chaque pointage vers cette semaine
            pointagesSemainePrecedente.forEach(p => {
                const dateSource = new Date(p.date);
                const jourSemaineSource = dateSource.getDay();
                
                // Calculer la date cible (m√™me jour de la semaine, mais semaine suivante)
                const dateCible = new Date(dateSource);
                dateCible.setDate(dateSource.getDate() + 7);
                
                // V√©rifier si le jour cible est un week-end
                const jourSemaineCible = dateCible.getDay();
                if (jourSemaineCible === 0 || jourSemaineCible === 6) {
                    return; // Ignorer les week-ends
                }
                
                // V√©rifier si c'est un jour f√©ri√©
                const dateCibleStr = dateCible.toISOString().split('T')[0];
                if (estJourFerie(dateCibleStr)) {
                    return; // Ignorer les jours f√©ri√©s
                }
                
                // V√©rifier si un pointage existe d√©j√† pour cette date/agent/t√¢che
                const existe = pointages.some(point => 
                    point.date === dateCibleStr && 
                    point.agentId === p.agentId && 
                    point.sousTacheId === p.sousTacheId
                );
                
                if (!existe) {
                    const nouveauPointage = {
                        id: Date.now() + nbCopies, // ID unique
                        date: dateCibleStr,
                        agentId: p.agentId,
                        sousTacheId: p.sousTacheId,
                        heures: p.heures || 0,
                        heuresSup: p.heuresSup || 0,
                        pauseMin: p.pauseMin || 0,
                        heuresNettes: p.heuresNettes || p.heures || 0,
                        type: p.type,
                        typeAbsence: p.typeAbsence || '',
                        motifAbsence: '',
                        statut: 'brouillon',
                        dateCreation: new Date().toISOString()
                    };
                    
                    pointages.push(nouveauPointage);
                    nbCopies++;
                }
            });
            
            if (nbCopies > 0) {
                sauvegarderDonnees();
                afficherPointageJournalier();
                afficherHistoriquePointages();
                afficherNotification(`‚úÖ ${nbCopies} pointage(s) copi√©(s) depuis la semaine pr√©c√©dente`, 'success');
            } else {
                afficherNotification('‚ÑπÔ∏è Aucun nouveau pointage copi√© (tous existent d√©j√†)', 'warning');
            }
        }

        // ============================================
        // SUIVI BUDGET vs R√âALIS√â
        // ============================================
        function afficherSuiviBudget() {
            const container = document.getElementById('suiviBudgetContainer');
            const affaireFiltre = document.getElementById('suiviAffaire').value;
            const agentFiltre = document.getElementById('suiviAgent').value;
            const seuil = parseFloat(document.getElementById('suiviSeuil').value) || 80;
            
            // Pr√©parer les selects
            const suiviAffaireSelect = document.getElementById('suiviAffaire');
            const suiviAgentSelect = document.getElementById('suiviAgent');
            
            // Peupler les selects si vides
            if (suiviAffaireSelect.options.length === 1) {
                const affairesUniques = [...new Set(sousTaches.map(st => st.numAffaire))];
                affairesUniques.forEach(num => {
                    const option = document.createElement('option');
                    option.value = num;
                    option.textContent = num;
                    suiviAffaireSelect.appendChild(option);
                });
            }
            
            if (suiviAgentSelect.options.length === 1) {
                agents.forEach(a => {
                    const option = document.createElement('option');
                    option.value = a.id;
                    option.textContent = a.nom;
                    suiviAgentSelect.appendChild(option);
                });
            }
            
            // Filtrer les t√¢ches
            let tachesFiltrees = sousTaches.filter(st => {
                if (affaireFiltre && st.numAffaire !== affaireFiltre) return false;
                if (agentFiltre && st.agentId != agentFiltre) return false;
                return true;
            });
            
            if (tachesFiltrees.length === 0) {
                container.innerHTML = '<div class="empty-state">Aucune t√¢che √† afficher</div>';
                return;
            }
            
            // Calculer les donn√©es pour chaque t√¢che
            const donnees = tachesFiltrees.map(st => {
                const agent = agents.find(a => a.id === st.agentId);
                const realise = calculerRealise(st.id);
                const budget = st.budgetHeures;
                const taux = budget > 0 ? (realise / budget) * 100 : 0;
                const reste = budget - realise;
                
                return {
                    id: st.id,
                    numAffaire: st.numAffaire,
                    nom: st.nom,
                    agent: agent ? agent.nom : 'Non assign√©',
                    budget,
                    realise,
                    reste,
                    taux,
                    statut: st.statut
                };
            });
            
            // Trier par taux d√©croissant (les plus consomm√©s en premier)
            donnees.sort((a, b) => b.taux - a.taux);
            
            // G√©n√©rer le tableau
            let html = '<div style="overflow-x: auto;"><table class="table"><thead><tr>';
            html += '<th>Affaire</th><th>T√¢che</th><th>Agent</th><th>Budget</th><th>R√©alis√©</th><th>Reste</th><th>Taux</th><th>Alerte</th>';
            html += '</tr></thead><tbody>';
            
            donnees.forEach(d => {
                // D√©terminer la classe de couleur selon le taux
                let tauxClass = '';
                let alerte = '';
                
                if (d.taux >= 100) {
                    tauxClass = 'style="background: #ffe6e6; color: #c82333; font-weight: bold;"';
                    alerte = '<span style="color: #dc3545; font-weight: bold;">üö® D√âPASS√â</span>';
                } else if (d.taux >= seuil) {
                    tauxClass = 'style="background: #fff3cd; color: #856404; font-weight: bold;"';
                    alerte = '<span style="color: #ffc107; font-weight: bold;">‚ö†Ô∏è CRITIQUE</span>';
                } else if (d.taux >= 50) {
                    tauxClass = 'style="background: #e7f3ff; color: #004085;"';
                    alerte = '<span style="color: #17a2b8;">‚ÑπÔ∏è Normal</span>';
                } else {
                    alerte = '<span style="color: #28a745;">‚úÖ OK</span>';
                }
                
                const progressBarColor = d.taux >= 100 ? '#dc3545' : d.taux >= seuil ? '#ffc107' : '#28a745';
                const progressBarWidth = Math.min(100, d.taux);
                
                html += `<tr ${tauxClass}>
                    <td><strong>${d.numAffaire}</strong></td>
                    <td>${d.nom}</td>
                    <td>${d.agent}</td>
                    <td>${d.budget.toFixed(1)}h</td>
                    <td><strong>${d.realise.toFixed(1)}h</strong></td>
                    <td>${d.reste > 0 ? d.reste.toFixed(1) + 'h' : '<span style="color: #dc3545;">-' + Math.abs(d.reste).toFixed(1) + 'h</span>'}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <strong>${d.taux.toFixed(0)}%</strong>
                            <div style="flex: 1; background: #e9ecef; border-radius: 4px; height: 8px; min-width: 100px;">
                                <div style="background: ${progressBarColor}; height: 100%; border-radius: 4px; width: ${progressBarWidth}%;"></div>
                            </div>
                        </div>
                    </td>
                    <td>${alerte}</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            
            // Ajouter un r√©sum√© global
            const totalBudget = donnees.reduce((sum, d) => sum + d.budget, 0);
            const totalRealise = donnees.reduce((sum, d) => sum + d.realise, 0);
            const tauxGlobal = totalBudget > 0 ? (totalRealise / totalBudget) * 100 : 0;
            const alertes = {
                depasse: donnees.filter(d => d.taux >= 100).length,
                critique: donnees.filter(d => d.taux >= seuil && d.taux < 100).length,
                normal: donnees.filter(d => d.taux < seuil).length
            };
            
            html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="card" style="text-align: center; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <div style="font-size: 28px; font-weight: bold;">${totalBudget.toFixed(0)}h</div>
                        <div style="font-size: 12px; opacity: 0.9;">Budget Total</div>
                    </div>
                    <div class="card" style="text-align: center; padding: 15px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                        <div style="font-size: 28px; font-weight: bold;">${totalRealise.toFixed(0)}h</div>
                        <div style="font-size: 12px; opacity: 0.9;">R√©alis√© Total</div>
                    </div>
                    <div class="card" style="text-align: center; padding: 15px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                        <div style="font-size: 28px; font-weight: bold;">${tauxGlobal.toFixed(0)}%</div>
                        <div style="font-size: 12px; opacity: 0.9;">Taux Global</div>
                    </div>
                    <div class="card" style="text-align: center; padding: 15px; background: ${alertes.depasse > 0 ? 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)' : 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)'}; color: white;">
                        <div style="font-size: 28px; font-weight: bold;">
                            ${alertes.depasse > 0 ? 'üö® ' + alertes.depasse : '‚úÖ ' + alertes.normal}
                        </div>
                        <div style="font-size: 12px; opacity: 0.9;">${alertes.depasse > 0 ? 'D√©passements' : 'T√¢ches OK'}</div>
                    </div>
                </div>
            ` + html;
            
            container.innerHTML = html;
        }

        // ============================================
        // POINTAGE JOURNALIER SIMPLIFI√â (Vue horizontale)
        // ============================================
        function afficherPointageJournalierSimple() {
            const container = document.getElementById('grilleJournaliereSimple');
            const agentId = document.getElementById('agentJournalier').value;
            const mois = parseInt(document.getElementById('moisJournalier').value);
            const annee = parseInt(document.getElementById('anneeJournalier').value);
            
            if (!agentId) {
                container.innerHTML = '<div class="empty-state">‚ö†Ô∏è Veuillez s√©lectionner un agent</div>';
                return;
            }
            
            const agent = agents.find(a => a.id == agentId);
            const nbJours = new Date(annee, mois + 1, 0).getDate();
            const moisNoms = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                             'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
            const joursNoms = ['dim.', 'lun.', 'mar.', 'mer.', 'jeu.', 'ven.', 'sam.'];
            
            // R√©cup√©rer les affaires de l'agent
            const affairesAgent = sousTaches.filter(st => st.agentId == agentId);
            
            if (affairesAgent.length === 0) {
                container.innerHTML = '<div class="empty-state">‚ö†Ô∏è Cet agent n\'a aucune affaire assign√©e</div>';
                return;
            }
            
            // Cr√©er le tableau HTML
            let html = `
                <div style="background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #34495e, #2c3e50); color: white;">
                                <th style="padding: 12px; text-align: left; min-width: 180px; position: sticky; left: 0; background: #2c3e50; z-index: 2; border-right: 2px solid #1a252f;">Affaire</th>
            `;
            
            // En-t√™tes des jours
            for (let jour = 1; jour <= nbJours; jour++) {
                const date = new Date(annee, mois, jour);
                const jourSemaine = date.getDay();
                const nomJour = joursNoms[jourSemaine];
                const isWeekend = jourSemaine === 0 || jourSemaine === 6;
                
                html += `
                    <th style="padding: 8px 4px; text-align: center; min-width: 45px; font-weight: 600; 
                        background: ${isWeekend ? '#95a5a6' : '#34495e'}; border-left: 1px solid rgba(255,255,255,0.1);">
                        <div style="font-size: 11px;">${jour}</div>
                        <div style="font-size: 9px; opacity: 0.8;">${nomJour}</div>
                    </th>
                `;
            }
            
            html += `
                                <th style="padding: 12px; text-align: center; min-width: 60px; background: #2c3e50; border-left: 2px solid #1a252f;">
                                    <div style="font-weight: 700;">Total (H)</div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Lignes des affaires
            affairesAgent.forEach((affaire, index) => {
                const bgColor = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                let totalHeuresAffaire = 0;
                
                html += `
                    <tr style="background: ${bgColor}; border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 12px; position: sticky; left: 0; background: ${bgColor}; z-index: 1; border-right: 2px solid #dee2e6;">
                            <div style="font-weight: 600; color: #2c3e50; margin-bottom: 2px;">${affaire.numAffaire}</div>
                            <div style="font-size: 10px; color: #7f8c8d;">${affaire.nom}</div>
                        </td>
                `;
                
                // Cases des jours
                for (let jour = 1; jour <= nbJours; jour++) {
                    const date = new Date(annee, mois, jour);
                    const dateStr = date.toISOString().split('T')[0];
                    const jourSemaine = date.getDay();
                    const isWeekend = jourSemaine === 0 || jourSemaine === 6;
                    
                    // Trouver le pointage pour ce jour et cette affaire
                    const pointage = pointages.find(p => 
                        p.date === dateStr && 
                        p.agentId == agentId && 
                        p.sousTacheId === affaire.id
                    );
                    
                    const heures = pointage ? pointage.heures : 0;
                    totalHeuresAffaire += heures;
                    
                    let bgCell = '#ffffff';
                    let textColor = '#2c3e50';
                    let content = '';
                    
                    if (isWeekend) {
                        bgCell = '#ecf0f1';
                    } else if (heures > 0) {
                        if (heures === 8) {
                            bgCell = '#f39c12'; // Orange
                            textColor = '#ffffff';
                            content = '‚óè';
                        } else if (heures === 4) {
                            bgCell = '#3498db'; // Bleu
                            textColor = '#ffffff';
                            content = '‚óê';
                        } else {
                            bgCell = '#27ae60'; // Vert
                            textColor = '#ffffff';
                            content = heures;
                        }
                    }
                    
                    html += `
                        <td onclick="modifierPointageSimple('${dateStr}', ${agentId}, ${affaire.id}, ${heures})" 
                            style="padding: 8px 4px; text-align: center; background: ${bgCell}; color: ${textColor}; 
                            cursor: pointer; border-left: 1px solid #dee2e6; font-weight: 600; font-size: 14px;
                            transition: all 0.2s;"
                            onmouseover="this.style.transform='scale(1.1)'; this.style.zIndex='10';"
                            onmouseout="this.style.transform='scale(1)'; this.style.zIndex='1';">
                            ${content}
                        </td>
                    `;
                }
                
                // Total de l'affaire
                html += `
                        <td style="padding: 12px; text-align: center; font-weight: 700; background: ${bgColor}; border-left: 2px solid #dee2e6; color: #0066cc;">
                            ${totalHeuresAffaire}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                    
                    <!-- L√©gende -->
                    <div style="padding: 15px; background: #f8f9fa; border-top: 2px solid #dee2e6; display: flex; gap: 20px; flex-wrap: wrap; align-items: center;">
                        <div style="font-weight: 600; color: #2c3e50;">L√©gende:</div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 24px; height: 24px; background: #f39c12; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">‚óè</div>
                            <span style="font-size: 12px;">Journ√©e compl√®te (8h)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 24px; height: 24px; background: #3498db; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">‚óê</div>
                            <span style="font-size: 12px;">Demi-journ√©e (4h)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 24px; height: 24px; background: #27ae60; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">H</div>
                            <span style="font-size: 12px;">Heures personnalis√©es</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 24px; height: 24px; background: #ecf0f1; border-radius: 4px;"></div>
                            <span style="font-size: 12px;">Week-end</span>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // Modifier un pointage dans la vue simplifi√©e
        function modifierPointageSimple(dateStr, agentId, sousTacheId, heuresActuelles) {
            const choix = prompt(
                `Modifier le pointage\n` +
                `Actuel: ${heuresActuelles}h\n\n` +
                `Entrez le nombre d'heures (0-24):`,
                heuresActuelles
            );
            
            if (choix === null) return;
            
            const heures = parseFloat(choix);
            if (isNaN(heures) || heures < 0 || heures > 24) {
                afficherNotification('‚ùå Heures invalides', 'error');
                return;
            }
            
            // Trouver ou cr√©er le pointage
            let pointage = pointages.find(p => 
                p.date === dateStr && 
                p.agentId == agentId && 
                p.sousTacheId === sousTacheId
            );
            
            if (pointage) {
                if (heures === 0) {
                    // Supprimer si 0 heures
                    const index = pointages.indexOf(pointage);
                    pointages.splice(index, 1);
                } else {
                    pointage.heures = heures;
                }
            } else if (heures > 0) {
                // Cr√©er nouveau pointage
                pointages.push({
                    id: Date.now(),
                    date: dateStr,
                    agentId: agentId,
                    sousTacheId: sousTacheId,
                    heures: heures,
                    dateCreation: new Date().toISOString()
                });
            }
            
            sauvegarderDonnees();
            afficherPointageJournalierSimple();
            afficherNotification('‚úÖ Pointage mis √† jour', 'success');
        }
        
        // Enregistrer tous les pointages
        function enregistrerPointageJournalierSimple() {
            sauvegarderDonnees();
            afficherNotification('‚úÖ Tous les pointages ont √©t√© enregistr√©s', 'success');
        }

        function afficherPointageJournalier() {
            const container = document.getElementById('grilleJournaliere');
            const agentId = document.getElementById('agentJournalier').value;
            const mois = parseInt(document.getElementById('moisJournalier').value);
            const annee = parseInt(document.getElementById('anneeJournalier').value);
            
            if (!agentId) {
                container.innerHTML = '<div class="empty-state">Veuillez s√©lectionner un agent</div>';
                return;
            }
            
            const agent = agents.find(a => a.id == agentId);
            const nbJours = new Date(annee, mois + 1, 0).getDate();
            
            const joursNoms = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
            
            // Calculer les totaux
            let totalJ = 0;
            let totalD = 0;
            let totalA = 0;
            let totalHeures = 0;
            
            let html = '<div class="grille-journaliere">';
            
            for (let jour = 1; jour <= nbJours; jour++) {
                const date = new Date(annee, mois, jour);
                const dateStr = date.toISOString().split('T')[0];
                const jourSemaine = date.getDay();
                const nomJour = joursNoms[jourSemaine];
                const isWeekend = jourSemaine === 0 || jourSemaine === 6;
                
                // Trouver tous les pointages de cet agent pour ce jour
                const pointagesJour = pointages.filter(p => 
                    p.date === dateStr && p.agentId == agentId
                );
                
                // Calculer le total des heures du jour (avec gestion Ramadan/f√©ri√©s)
                const heuresJour = pointagesJour.reduce((sum, p) => sum + p.heures, 0);
                
                // D√©terminer les heures attendues pour ce jour
                const heuresJourAttendu = getHeuresTravail(dateStr, 'jour');
                const heuresDemiAttendu = getHeuresTravail(dateStr, 'demi');
                
                let type = '';
                let typeLabel = '';
                let typeClass = '';
                
                if (heuresJour >= heuresJourAttendu && heuresJourAttendu > 0) {
                    type = 'J';
                    typeLabel = heuresJour + 'h';
                    typeClass = 'type-j';
                    totalJ++;
                    totalHeures += heuresJour;
                } else if (heuresJour >= heuresDemiAttendu && heuresDemiAttendu > 0) {
                    type = 'D';
                    typeLabel = heuresJour + 'h';
                    typeClass = 'type-d';
                    totalD++;
                    totalHeures += heuresJour;
                } else if (heuresJour === 0 && !isWeekend) {
                    type = 'A';
                    typeLabel = '0h';
                    typeClass = 'type-a';
                    totalA++;
                } else if (heuresJour > 0) {
                    type = heuresJour + 'h';
                    typeLabel = heuresJour + 'h';
                    typeClass = 'type-j';
                    totalHeures += heuresJour;
                }
                
                html += `
                <div class="jour-cell ${isWeekend ? 'weekend' : typeClass}" 
                     onclick="editerJourPointage('${dateStr}', ${agentId})"
                     title="${date.toLocaleDateString('fr-FR')}">
                    <div>
                        <div class="jour-numero">${jour}</div>
                        <div class="jour-nom">${nomJour}</div>
                    </div>
                    <div class="jour-type ${typeClass}">${type || (isWeekend ? '‚Äî' : '')}</div>
                    <div class="jour-heures">${typeLabel || (isWeekend ? 'WE' : '')}</div>
                </div>`;
            }
            
            html += '</div>';
            
            // Ajouter les totaux
            html += `
            <div class="journalier-totaux">
                <div class="total-item">
                    <h3>Journ√©es compl√®tes (J)</h3>
                    <div class="value">${totalJ}</div>
                </div>
                <div class="total-item">
                    <h3>Demi-journ√©es (D)</h3>
                    <div class="value">${totalD}</div>
                </div>
                <div class="total-item">
                    <h3>Absences (A)</h3>
                    <div class="value">${totalA}</div>
                </div>
                <div class="total-item">
                    <h3>Total heures</h3>
                    <div class="value">${totalHeures}h</div>
                </div>
            </div>`;
            
            container.innerHTML = html;
        }

        function editerJourPointage(dateStr, agentId) {
            // Fonction pour permettre la modification rapide d'un jour
            const date = new Date(dateStr);
            const jour = date.getDate();
            const jourSemaine = date.getDay();
            
            if (jourSemaine === 0 || jourSemaine === 6) {
                alert('‚ö†Ô∏è Week-end - pas de pointage possible');
                return;
            }
            
            // Trouver les pointages existants
            const pointagesJour = pointages.filter(p => 
                p.date === dateStr && p.agentId == agentId
            );
            
            const heuresActuelles = pointagesJour.reduce((sum, p) => sum + p.heures, 0);
            
            let typeActuel = '';
            if (heuresActuelles === 8) typeActuel = 'J - Journ√©e (8h)';
            else if (heuresActuelles === 4) typeActuel = 'D - Demi-journ√©e (4h)';
            else if (heuresActuelles === 0) typeActuel = 'A - Absent (0h)';
            else typeActuel = `${heuresActuelles}h`;
            
            const choix = prompt(
                `Modifier le pointage du ${date.toLocaleDateString('fr-FR')}\n` +
                `Actuel: ${typeActuel}\n\n` +
                `Entrez:\n` +
                `J = Journ√©e compl√®te (8h)\n` +
                `D = Demi-journ√©e (4h)\n` +
                `A = Absent (0h)\n` +
                `ou un nombre d'heures`,
                heuresActuelles === 8 ? 'J' : heuresActuelles === 4 ? 'D' : heuresActuelles === 0 ? 'A' : heuresActuelles
            );
            
            if (choix === null) return; // Annul√©
            
            let heures = 0;
            if (choix.toUpperCase() === 'J') heures = 8;
            else if (choix.toUpperCase() === 'D') heures = 4;
            else if (choix.toUpperCase() === 'A') heures = 0;
            else heures = parseFloat(choix) || 0;
            
            // V√©rifier qu'il y a une sous-t√¢che active
            const sousTachesAgent = sousTaches.filter(st => st.agentId == agentId);
            if (sousTachesAgent.length === 0) {
                alert('‚ö†Ô∏è Aucune affaire assign√©e √† cet agent');
                return;
            }
            
            // Prendre la premi√®re sous-t√¢che active
            const sousTache = sousTachesAgent[0];
            
            // Supprimer les pointages existants pour ce jour
            pointages = pointages.filter(p => !(p.date === dateStr && p.agentId == agentId));
            
            // Ajouter le nouveau pointage si > 0
            if (heures > 0) {
                const type = heures === 8 ? 'jour' : heures === 4 ? 'demi' : 'autre';
                pointages.push({
                    id: Date.now(),
                    date: dateStr,
                    agentId: parseInt(agentId),
                    sousTacheId: sousTache.id,
                    heures: heures,
                    type: type,
                    dateCreation: new Date().toISOString()
                });
            }
            
            sauvegarderDonnees();
            afficherPointageJournalier();
        }

        // ============================================
        // EXPORT PDF avec jsPDF
        // ============================================
        
        // Fonction helper pour ajouter l'en-t√™te CNIM √† tous les PDF
        function ajouterEnteteCNIM(doc, titre, sousTitre = '') {
            // Logo CNIM en base64 (version simplifi√©e pour PDF)
            const logoCNIM = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';
            
            // Rectangle d'en-t√™te bleu CNIM
            doc.setFillColor(0, 102, 204); // #0066cc
            doc.rect(0, 0, 210, 35, 'F');
            
            // Texte CNIM BABCOCK MAROC
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('CNIM BABCOCK MAROC', 15, 15);
            
            // D√©partement M√©thode
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('D√©partement M√©thode', 15, 22);
            
            // Date de g√©n√©ration √† droite
            const dateGeneration = new Date().toLocaleDateString('fr-FR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            doc.setFontSize(8);
            doc.text('G√©n√©r√© le:', 160, 15);
            doc.text(dateGeneration, 160, 20);
            
            // Titre du document
            doc.setTextColor(0, 102, 204);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text(titre, 105, 45, { align: 'center' });
            
            // Sous-titre si fourni
            if (sousTitre) {
                doc.setFontSize(12);
                doc.setTextColor(60, 60, 60);
                doc.setFont(undefined, 'normal');
                doc.text(sousTitre, 105, 52, { align: 'center' });
            }
            
            // Ligne de s√©paration
            doc.setDrawColor(0, 102, 204);
            doc.setLineWidth(0.8);
            doc.line(15, sousTitre ? 56 : 50, 195, sousTitre ? 56 : 50);
            
            return sousTitre ? 62 : 56; // Retourne la position Y apr√®s l'en-t√™te
        }
        
        // Fonction pour ajouter le pied de page CNIM
        function ajouterPiedDePageCNIM(doc, pageNum, totalPages) {
            const pageHeight = doc.internal.pageSize.height;
            
            // Ligne de s√©paration
            doc.setDrawColor(0, 102, 204);
            doc.setLineWidth(0.5);
            doc.line(15, pageHeight - 20, 195, pageHeight - 20);
            
            // Informations CNIM
            doc.setTextColor(100, 100, 100);
            doc.setFontSize(8);
            doc.text('CNIM BABCOCK MAROC - D√©partement M√©thode', 15, pageHeight - 12);
            doc.text('Syst√®me de Gestion de Pointage et Planning', 15, pageHeight - 8);
            
            // Num√©ro de page
            doc.text(`Page ${pageNum}/${totalPages}`, 195, pageHeight - 10, { align: 'right' });
            
            // Contact
            doc.setFontSize(7);
            doc.text('www.cnim.com', 105, pageHeight - 5, { align: 'center' });
        }
        
        function exporterJournalierPDF() {
            const agentId = document.getElementById('agentJournalier').value;
            const mois = parseInt(document.getElementById('moisJournalier').value);
            const annee = parseInt(document.getElementById('anneeJournalier').value);
            
            if (!agentId) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner un agent');
                return;
            }
            
            const agent = agents.find(a => a.id == agentId);
            const moisNoms = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                             'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
            const nbJours = new Date(annee, mois + 1, 0).getDate();
            const joursNoms = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
            
            // Cr√©er le document PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Ajouter l'en-t√™te CNIM
            let yPos = ajouterEnteteCNIM(doc, 'Pointage Journalier', `${agent.nom} - ${moisNoms[mois]} ${annee}`);
            
            yPos += 5; // Espacement
            
            // Calculer les totaux
            let totalJ = 0;
            let totalD = 0;
            let totalA = 0;
            let totalHeures = 0;
            
            // Pr√©parer les donn√©es de la grille
            const donnees = [];
            for (let jour = 1; jour <= nbJours; jour++) {
                const date = new Date(annee, mois, jour);
                const dateStr = date.toISOString().split('T')[0];
                const jourSemaine = date.getDay();
                const nomJour = joursNoms[jourSemaine];
                const isWeekend = jourSemaine === 0 || jourSemaine === 6;
                
                const pointagesJour = pointages.filter(p => 
                    p.date === dateStr && p.agentId == agentId
                );
                
                const heuresJour = pointagesJour.reduce((sum, p) => sum + p.heures, 0);
                
                let type = '';
                if (heuresJour === 8) {
                    type = 'J';
                    totalJ++;
                    totalHeures += 8;
                } else if (heuresJour === 4) {
                    type = 'D';
                    totalD++;
                    totalHeures += 4;
                } else if (heuresJour === 0 && !isWeekend) {
                    type = 'A';
                    totalA++;
                } else if (heuresJour > 0) {
                    type = heuresJour + 'h';
                    totalHeures += heuresJour;
                }
                
                donnees.push({
                    jour: jour,
                    nomJour: nomJour,
                    type: isWeekend ? 'WE' : (type || ''),
                    heures: isWeekend ? '-' : (heuresJour > 0 ? heuresJour + 'h' : ''),
                    isWeekend: isWeekend
                });
            }
            
            // Afficher la grille (7 colonnes)
            let startY = 50;
            const cellWidth = 24;
            const cellHeight = 18;
            
            doc.setFontSize(9);
            
            for (let i = 0; i < donnees.length; i += 7) {
                const ligne = donnees.slice(i, i + 7);
                
                ligne.forEach((jour, index) => {
                    const x = 20 + (index * cellWidth);
                    const y = startY;
                    
                    // Couleur de fond selon le type
                    if (jour.isWeekend) {
                        doc.setFillColor(241, 243, 245);
                    } else if (jour.type === 'J') {
                        doc.setFillColor(209, 244, 224);
                    } else if (jour.type === 'D') {
                        doc.setFillColor(255, 243, 205);
                    } else if (jour.type === 'A') {
                        doc.setFillColor(248, 215, 218);
                    } else {
                        doc.setFillColor(255, 255, 255);
                    }
                    
                    doc.rect(x, y, cellWidth, cellHeight, 'FD');
                    
                    // Bordure
                    doc.setDrawColor(200, 200, 200);
                    doc.rect(x, y, cellWidth, cellHeight);
                    
                    // Texte
                    doc.setTextColor(60, 60, 60);
                    doc.setFontSize(10);
                    doc.text(jour.jour.toString(), x + cellWidth / 2, y + 6, { align: 'center' });
                    
                    doc.setFontSize(8);
                    doc.setTextColor(120, 120, 120);
                    doc.text(jour.nomJour, x + cellWidth / 2, y + 11, { align: 'center' });
                    
                    doc.setFontSize(11);
                    doc.setTextColor(102, 126, 234);
                    doc.text(jour.type, x + cellWidth / 2, y + 16, { align: 'center' });
                });
                
                startY += cellHeight + 2;
            }
            
            // Cadre des totaux
            startY += 10;
            doc.setFillColor(102, 126, 234);
            doc.rect(20, startY, 168, 35, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.text('TOTAUX DU MOIS', 104, startY + 8, { align: 'center' });
            
            doc.setFontSize(14);
            const totalWidth = 168 / 4;
            
            doc.text(`J: ${totalJ}`, 20 + totalWidth / 2, startY + 20, { align: 'center' });
            doc.text(`D: ${totalD}`, 20 + totalWidth + totalWidth / 2, startY + 20, { align: 'center' });
            doc.text(`A: ${totalA}`, 20 + totalWidth * 2 + totalWidth / 2, startY + 20, { align: 'center' });
            doc.text(`${totalHeures}h`, 20 + totalWidth * 3 + totalWidth / 2, startY + 20, { align: 'center' });
            
            doc.setFontSize(8);
            doc.text('Journ√©es', 20 + totalWidth / 2, startY + 28, { align: 'center' });
            doc.text('Demi-j.', 20 + totalWidth + totalWidth / 2, startY + 28, { align: 'center' });
            doc.text('Absences', 20 + totalWidth * 2 + totalWidth / 2, startY + 28, { align: 'center' });
            doc.text('Total heures', 20 + totalWidth * 3 + totalWidth / 2, startY + 28, { align: 'center' });
            
            // L√©gende
            startY += 45;
            doc.setTextColor(60, 60, 60);
            doc.setFontSize(10);
            doc.text('L√©gende:', 20, startY);
            
            doc.setFontSize(9);
            doc.text('J = Journ√©e compl√®te (8h)', 25, startY + 6);
            doc.text('D = Demi-journ√©e (4h)', 25, startY + 12);
            doc.text('A = Absent (0h)', 25, startY + 18);
            doc.text('WE = Week-end', 25, startY + 24);
            
            // Ajouter le pied de page CNIM
            ajouterPiedDePageCNIM(doc, 1, 1);
            
            // Sauvegarder le PDF
            doc.save(`Pointage_${agent.nom.replace(/\s+/g, '_')}_${moisNoms[mois]}_${annee}.pdf`);
            
            afficherNotification('‚úÖ PDF g√©n√©r√© avec succ√®s avec logo CNIM !', 'success');
        }

        // ============================================
        // RAPPORTS (PLACEHOLDERS)
        // ============================================
        function genererRapportMensuelGlobal() {
            alert('‚ÑπÔ∏è Fonctionnalit√© en d√©veloppement\n\nLe rapport mensuel global sera bient√¥t disponible.\nIl inclura :\n‚Ä¢ Synth√®se de tous les agents\n‚Ä¢ R√©capitulatif par affaire\n‚Ä¢ Indicateurs de performance\n‚Ä¢ Statistiques d\'avancement');
        }

        function genererRapportParAgent() {
            alert('‚ÑπÔ∏è Fonctionnalit√© en d√©veloppement\n\nLe rapport par agent sera bient√¥t disponible.\nIl inclura :\n‚Ä¢ D√©tail des heures par jour\n‚Ä¢ Liste des affaires trait√©es\n‚Ä¢ Taux d\'occupation\n‚Ä¢ Comparaison budget/r√©alis√©');
        }

        function genererRapportParAffaire() {
            alert('‚ÑπÔ∏è Fonctionnalit√© en d√©veloppement\n\nLe rapport par affaire sera bient√¥t disponible.\nIl inclura :\n‚Ä¢ Avancement d√©taill√©\n‚Ä¢ Consommation budget\n‚Ä¢ Jalons et √©ch√©ances\n‚Ä¢ Analyse des retards');
        }

        function genererRapportAnnuel() {
            alert('‚ÑπÔ∏è Fonctionnalit√© en d√©veloppement\n\nLe rapport annuel sera bient√¥t disponible.\nIl inclura :\n‚Ä¢ Bilan des 12 mois\n‚Ä¢ Tendances et √©volutions\n‚Ä¢ Performance globale\n‚Ä¢ Statistiques comparatives');
        }

        function exporterRapportPDF(type) {
            alert(`‚ÑπÔ∏è Export PDF (${type})\n\nCette fonctionnalit√© sera disponible une fois les rapports impl√©ment√©s.`);
        }

        function exporterRapportExcel(type) {
            alert(`‚ÑπÔ∏è Export Excel (${type})\n\nCette fonctionnalit√© sera disponible une fois les rapports impl√©ment√©s.`);
        }

        function fermerApercuRapport() {
            document.getElementById('rapportApercu').style.display = 'none';
        }

        // ============================================
        // POINTAGE MENSUEL (suite)
        // ============================================
        function peuplerFiltresMensuel() {
            // Peupler le filtre des agents
            const selectAgent = document.getElementById('agentMensuel');
            selectAgent.innerHTML = '<option value="">Tous les agents</option>';
            agents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.id;
                option.textContent = agent.nom;
                selectAgent.appendChild(option);
            });
            
            // Peupler le filtre des affaires
            const selectAffaire = document.getElementById('affaireMensuel');
            selectAffaire.innerHTML = '<option value="">Toutes les affaires</option>';
            const affaires = [...new Set(sousTaches.map(st => st.numAffaire))];
            affaires.forEach(numAffaire => {
                const option = document.createElement('option');
                option.value = numAffaire;
                option.textContent = numAffaire;
                selectAffaire.appendChild(option);
            });
            
            // D√©finir le mois courant par d√©faut
            const maintenant = new Date();
            document.getElementById('moisMensuel').value = maintenant.getMonth();
            document.getElementById('anneeMensuel').value = maintenant.getFullYear();
        }

        function afficherPointageMensuel() {
            const container = document.getElementById('grilleMensuelle');
            const mois = parseInt(document.getElementById('moisMensuel').value);
            const annee = parseInt(document.getElementById('anneeMensuel').value);
            const filtreAgent = document.getElementById('agentMensuel').value;
            const filtreAffaire = document.getElementById('affaireMensuel').value;
            
            // Filtrer les agents
            let agentsFiltres = agents;
            if (filtreAgent) {
                agentsFiltres = agents.filter(a => a.id == filtreAgent);
            }
            
            // Filtrer les sous-t√¢ches
            let sousTachesFiltrees = sousTaches;
            if (filtreAffaire) {
                sousTachesFiltrees = sousTaches.filter(st => st.numAffaire === filtreAffaire);
            }
            
            // Nombre de jours dans le mois
            const nbJours = new Date(annee, mois + 1, 0).getDate();
            
            // G√©n√©rer le tableau
            let html = '<div class="grille-mensuelle-container">';
            html += '<table class="table-mensuelle">';
            
            // En-t√™te
            html += '<thead><tr>';
            html += '<th class="agent-col">Agent / Affaire</th>';
            
            for (let jour = 1; jour <= nbJours; jour++) {
                const date = new Date(annee, mois, jour);
                const jourSemaine = date.getDay();
                const isWeekend = jourSemaine === 0 || jourSemaine === 6;
                
                html += `<th class="${isWeekend ? 'weekend-header' : ''}" title="${date.toLocaleDateString('fr-FR')}">${jour}</th>`;
            }
            
            html += '<th class="total-cell">Total (h)</th>';
            html += '</tr></thead><tbody>';
            
            // Lignes par agent et affaire
            if (agentsFiltres.length === 0) {
                html += '<tr><td colspan="' + (nbJours + 2) + '" class="empty-state">Aucun agent √† afficher</td></tr>';
            } else {
                agentsFiltres.forEach(agent => {
                    // Trouver les affaires de cet agent
                    const affairesAgent = sousTachesFiltrees.filter(st => st.agentId === agent.id);
                    
                    if (affairesAgent.length === 0) return;
                    
                    // Ligne de l'agent
                    html += `<tr>`;
                    html += `<td class="agent-cell" rowspan="${affairesAgent.length + 1}">${agent.nom}</td>`;
                    html += '</tr>';
                    
                    let totalAgentMois = 0;
                    
                    // Lignes par affaire
                    affairesAgent.forEach(st => {
                        html += '<tr>';
                        html += `<td class="affaire-cell">${st.numAffaire} - ${st.nom}</td>`;
                        
                        let totalLigne = 0;
                        
                        // Cellules pour chaque jour
                        for (let jour = 1; jour <= nbJours; jour++) {
                            const date = new Date(annee, mois, jour);
                            const dateStr = date.toISOString().split('T')[0];
                            const jourSemaine = date.getDay();
                            const isWeekend = jourSemaine === 0 || jourSemaine === 6;
                            
                            // Trouver le pointage
                            const pointage = pointages.find(p => 
                                p.date === dateStr && 
                                p.agentId === agent.id && 
                                p.sousTacheId === st.id
                            );
                            
                            let cellClass = isWeekend ? 'weekend' : '';
                            let cellContent = '';
                            
                            if (pointage) {
                                totalLigne += pointage.heures;
                                totalAgentMois += pointage.heures;
                                
                                if (pointage.heures === 8) {
                                    cellClass += ' jour-pointe';
                                    cellContent = '8';
                                } else if (pointage.heures === 4) {
                                    cellClass += ' jour-demi';
                                    cellContent = '4';
                                } else if (pointage.heures === 0) {
                                    cellClass += ' jour-absent';
                                    cellContent = '0';
                                } else {
                                    cellContent = pointage.heures;
                                }
                            }
                            
                            html += `<td class="${cellClass}">${cellContent}</td>`;
                        }
                        
                        html += `<td class="total-cell">${totalLigne}h</td>`;
                        html += '</tr>';
                    });
                    
                    // Ligne de total pour l'agent
                    html += '<tr style="border-top: 2px solid #667eea;">';
                    html += `<td class="affaire-cell" style="font-weight: 700; background: #e7f3ff;">Total ${agent.nom}</td>`;
                    
                    // Totaux par jour pour l'agent
                    for (let jour = 1; jour <= nbJours; jour++) {
                        const date = new Date(annee, mois, jour);
                        const dateStr = date.toISOString().split('T')[0];
                        
                        const totalJour = pointages
                            .filter(p => p.date === dateStr && p.agentId === agent.id)
                            .reduce((sum, p) => sum + p.heures, 0);
                        
                        html += `<td class="total-cell">${totalJour > 0 ? totalJour : ''}</td>`;
                    }
                    
                    html += `<td class="total-cell" style="background: #667eea; color: white;">${totalAgentMois}h</td>`;
                    html += '</tr>';
                });
            }
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
            
            // Afficher la synth√®se des √©carts
            afficherSyntheseEcarts(mois, annee, filtreAgent, filtreAffaire);
        }

        function afficherSyntheseEcarts(mois, annee, filtreAgent, filtreAffaire) {
            const container = document.getElementById('syntheseEcarts');
            
            // Filtrer les sous-t√¢ches
            let sousTachesFiltrees = sousTaches;
            if (filtreAffaire) {
                sousTachesFiltrees = sousTaches.filter(st => st.numAffaire === filtreAffaire);
            }
            if (filtreAgent) {
                sousTachesFiltrees = sousTachesFiltrees.filter(st => st.agentId == filtreAgent);
            }
            
            if (sousTachesFiltrees.length === 0) {
                container.innerHTML = '<div class="empty-state">Aucune donn√©e pour la synth√®se</div>';
                return;
            }
            
            let html = '<div class="ecarts-grid">';
            
            sousTachesFiltrees.forEach(st => {
                const agent = agents.find(a => a.id === st.agentId);
                const budget = st.budgetHeures;
                const realise = calculerRealise(st.id);
                const ecart = realise - budget;
                const pourcentage = calculerAvancement(realise, budget);
                
                // D√©terminer le statut
                let statut = 'conforme';
                let statutLabel = '‚úÖ Conforme';
                if (pourcentage > 100) {
                    statut = 'depassement';
                    statutLabel = '‚ö†Ô∏è D√©passement';
                } else if (pourcentage >= 80) {
                    statut = 'risque';
                    statutLabel = '‚ö° Risque';
                }
                
                html += `
                <div class="ecart-card ${statut}">
                    <div class="ecart-header">
                        <div class="ecart-title">${st.numAffaire} - ${st.nom}</div>
                        <div class="ecart-badge ${statut}">${statutLabel}</div>
                    </div>
                    <div class="ecart-details">
                        üë§ <strong>${agent ? agent.nom : 'Non assign√©'}</strong><br>
                        üíº Budget: ${budget}h<br>
                        ‚úÖ R√©alis√©: ${realise}h<br>
                        üìä √âcart: <strong style="color: ${ecart > 0 ? '#dc3545' : '#28a745'}">
                            ${ecart > 0 ? '+' : ''}${ecart}h
                        </strong>
                    </div>
                    <div class="ecart-progress">
                        <div class="progress-bar-container">
                            <div class="progress-bar ${pourcentage >= 100 ? 'danger' : pourcentage >= 80 ? 'warning' : ''}" 
                                style="width: ${Math.min(pourcentage, 100)}%"></div>
                            <div class="progress-text">${pourcentage}%</div>
                        </div>
                    </div>
                </div>`;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // ============================================
        // EXPORT EXCEL (.XLSX)
        // ============================================
        function exporterExcel() {
            const mois = parseInt(document.getElementById('moisMensuel').value);
            const annee = parseInt(document.getElementById('anneeMensuel').value);
            const nbJours = new Date(annee, mois + 1, 0).getDate();
            
            const moisNoms = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                             'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
            
            const dateExport = new Date().toLocaleDateString('fr-FR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Cr√©er un nouveau classeur Excel
            const wb = XLSX.utils.book_new();
            
            // Propri√©t√©s du document
            wb.Props = {
                Title: `Pointage Mensuel - ${moisNoms[mois]} ${annee}`,
                Subject: "CNIM BABCOCK MAROC - D√©partement M√©thode",
                Author: "Syst√®me de Gestion de Pointage",
                CreatedDate: new Date()
            };
            
            // Pour chaque agent, cr√©er une feuille
            agents.forEach(agent => {
                const affairesAgent = sousTaches.filter(st => st.agentId === agent.id);
                
                if (affairesAgent.length === 0) return;
                
                // Pr√©parer les donn√©es pour cette feuille
                const sheetData = [];
                
                // En-t√™te CNIM
                sheetData.push(['CNIM BABCOCK MAROC']);
                sheetData.push(['D√©partement M√©thode']);
                sheetData.push(['']);
                sheetData.push([`Pointage Mensuel - ${agent.nom}`]);
                sheetData.push([`${moisNoms[mois]} ${annee}`]);
                sheetData.push(['G√©n√©r√© le: ' + dateExport]);
                sheetData.push([]); // Ligne vide
                
                // En-t√™te du tableau
                const headerRow = ['Affaire'];
                for (let jour = 1; jour <= nbJours; jour++) {
                    headerRow.push(jour);
                }
                headerRow.push('Total (h)');
                sheetData.push(headerRow);
                
                // Donn√©es par affaire
                let totalAgent = 0;
                affairesAgent.forEach(st => {
                    const row = [`${st.numAffaire} - ${st.nom}`];
                    let totalLigne = 0;
                    
                    for (let jour = 1; jour <= nbJours; jour++) {
                        const date = new Date(annee, mois, jour);
                        const dateStr = date.toISOString().split('T')[0];
                        
                        const pointage = pointages.find(p => 
                            p.date === dateStr && 
                            p.agentId === agent.id && 
                            p.sousTacheId === st.id
                        );
                        
                        if (pointage) {
                            row.push(pointage.heures);
                            totalLigne += pointage.heures;
                        } else {
                            row.push('');
                        }
                    }
                    
                    row.push(totalLigne);
                    totalAgent += totalLigne;
                    sheetData.push(row);
                });
                
                // Ligne de total
                sheetData.push([]); // Ligne vide
                const totalRow = ['TOTAL AGENT'];
                for (let jour = 1; jour <= nbJours; jour++) {
                    let totalJour = 0;
                    affairesAgent.forEach(st => {
                        const date = new Date(annee, mois, jour);
                        const dateStr = date.toISOString().split('T')[0];
                        const pointage = pointages.find(p => 
                            p.date === dateStr && 
                            p.agentId === agent.id && 
                            p.sousTacheId === st.id
                        );
                        if (pointage) totalJour += pointage.heures;
                    });
                    totalRow.push(totalJour || '');
                }
                totalRow.push(totalAgent);
                sheetData.push(totalRow);
                
                // Cr√©er la feuille
                const ws = XLSX.utils.aoa_to_sheet(sheetData);
                
                // D√©finir la largeur des colonnes
                const colWidths = [{ wch: 30 }]; // Colonne Affaire
                for (let i = 0; i < nbJours; i++) {
                    colWidths.push({ wch: 5 }); // Colonnes jours
                }
                colWidths.push({ wch: 10 }); // Colonne Total
                ws['!cols'] = colWidths;
                
                // Ajouter la feuille au classeur (nom limit√© √† 31 caract√®res)
                const sheetName = agent.nom.substring(0, 31);
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            });
            
            // Cr√©er une feuille de synth√®se globale
            // Synth√®se globale
            const syntheseData = [];
            syntheseData.push(['CNIM BABCOCK MAROC - D√©partement M√©thode']);
            syntheseData.push([`Synth√®se Globale - ${moisNoms[mois]} ${annee}`]);
            syntheseData.push(['G√©n√©r√© le: ' + dateExport]);
            syntheseData.push([]);
            syntheseData.push(['Agent', 'Fonction', 'Nb Affaires', 'Heures R√©alis√©es', 'Budget Total']);
            
            agents.forEach(agent => {
                const affairesAgent = sousTaches.filter(st => st.agentId === agent.id);
                const heuresAgent = pointages
                    .filter(p => p.agentId === agent.id && 
                                 p.date.startsWith(`${annee}-${String(mois + 1).padStart(2, '0')}`))
                    .reduce((sum, p) => sum + (p.heures || 0), 0);
                const budgetAgent = affairesAgent.reduce((sum, st) => sum + (st.budgetHeures || 0), 0);
                
                syntheseData.push([
                    agent.nom,
                    agent.fonction,
                    affairesAgent.length,
                    heuresAgent,
                    budgetAgent
                ]);
            });
            
            const wsSynthese = XLSX.utils.aoa_to_sheet(syntheseData);
            wsSynthese['!cols'] = [
                { wch: 20 }, // Agent
                { wch: 20 }, // Fonction
                { wch: 12 }, // Nb Affaires
                { wch: 15 }, // Heures
                { wch: 15 }  // Budget
            ];
            XLSX.utils.book_append_sheet(wb, wsSynthese, 'Synth√®se');
            
            // T√©l√©charger le fichier Excel
            XLSX.writeFile(wb, `CNIM_Pointage_${moisNoms[mois]}_${annee}.xlsx`);
            
            afficherNotification('‚úÖ Export Excel CNIM g√©n√©r√© avec succ√®s !', 'success');
        }

        // ============================================
        // EXPORT PDF
        // ============================================
        function exporterPDF() {
            const mois = parseInt(document.getElementById('moisMensuel').value);
            const annee = parseInt(document.getElementById('anneeMensuel').value);
            
            const moisNoms = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                             'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
            
            // Cr√©er une fen√™tre d'impression avec style
            const printWindow = window.open('', '', 'width=800,height=600');
            
            let html = `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>CNIM - Pointage Mensuel - ${moisNoms[mois]} ${annee}</title>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                        padding: 20px;
                    }
                    .header-cnim {
                        background: linear-gradient(135deg, #0066cc, #003d7a);
                        color: white;
                        padding: 20px;
                        margin-bottom: 20px;
                        border-radius: 5px;
                    }
                    .header-cnim h1 {
                        margin: 0;
                        font-size: 24px;
                    }
                    .header-cnim .subtitle {
                        margin: 5px 0 0 0;
                        font-size: 14px;
                        opacity: 0.9;
                    }
                    .header-cnim .date-export {
                        margin-top: 10px;
                        font-size: 12px;
                        opacity: 0.8;
                    }
                    h1 {
                        text-align: center;
                        color: #0066cc;
                    }
                    table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-top: 20px;
                        font-size: 11px;
                    }
                    th {
                        background: #0066cc;
                        color: white;
                        padding: 8px;
                        border: 1px solid #003d7a;
                        text-align: center;
                    }
                    td {
                        padding: 6px;
                        border: 1px solid #ddd;
                        text-align: center;
                    }
                    .agent-cell {
                        background: #f8f9fa;
                        font-weight: bold;
                        text-align: left;
                    }
                    .affaire-cell {
                        text-align: left;
                        padding-left: 20px;
                    }
                    .total-cell {
                        background: #e7f3ff;
                        font-weight: bold;
                        color: #0066cc;
                    }
                    .weekend {
                        background: #f1f3f5;
                    }
                    .jour-pointe {
                        background: #d1f4e0;
                        font-weight: bold;
                    }
                    .footer-cnim {
                        margin-top: 30px;
                        text-align: center;
                        font-size: 10px;
                        color: #666;
                        padding-top: 20px;
                        border-top: 2px solid #0066cc;
                    }
                    @media print {
                        body { padding: 10px; }
                        table { font-size: 9px; }
                    }
                </style>
            </head>
            <body>
                <div class="header-cnim">
                    <h1>CNIM BABCOCK MAROC</h1>
                    <div class="subtitle">D√©partement M√©thode - Gestion de Pointage et Planning</div>
                    <div class="date-export">G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })}</div>
                </div>
                
                <h1>üìä Pointage Mensuel - ${moisNoms[mois]} ${annee}</h1>
            `;
            
            // R√©cup√©rer le tableau
            const grille = document.querySelector('.table-mensuelle');
            if (grille) {
                html += grille.outerHTML;
            } else {
                html += '<p>Aucune donn√©e √† afficher</p>';
            }
            
            html += `
                <div style="margin-top: 30px; page-break-before: always;">
                    <h2 style="color: #0066cc;">üìà Synth√®se des √©carts</h2>
            `;
            
            // Ajouter la synth√®se des √©carts
            sousTaches.forEach(st => {
                const agent = agents.find(a => a.id === st.agentId);
                const budget = st.budgetHeures;
                const realise = calculerRealise(st.id);
                const ecart = realise - budget;
                const pourcentage = calculerAvancement(realise, budget);
                
                html += `
                <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-left: 4px solid ${ecart > 0 ? '#dc3545' : '#28a745'};">
                    <strong>${st.numAffaire} - ${st.nom}</strong><br>
                    Agent: ${agent ? agent.nom : 'Non assign√©'}<br>
                    Budget: ${budget}h | R√©alis√©: ${realise}h | √âcart: ${ecart > 0 ? '+' : ''}${ecart}h (${pourcentage}%)
                </div>`;
            });
            
            html += `
                </div>
                
                <div class="footer-cnim">
                    <p><strong>CNIM BABCOCK MAROC - D√©partement M√©thode</strong></p>
                    <p>Syst√®me de Gestion de Pointage et Planning</p>
                    <p>¬© CNIM - Tous droits r√©serv√©s | www.cnim.com</p>
                </div>
            </body>
            </html>`;
            
            printWindow.document.write(html);
            printWindow.document.close();
            
            // Lancer l'impression
            printWindow.onload = function() {
                printWindow.print();
            };
        }

        // ============================================
        // MODAL AGENDA
        // ============================================
        function openAgenda() {
            document.getElementById('modalAgenda').classList.add('active');
            afficherAgenda();
        }

        function closeAgenda() {
            document.getElementById('modalAgenda').classList.remove('active');
        }

        function afficherAgenda() {
            const dateSelectionnee = document.getElementById('dateAgenda').value;
            const container = document.getElementById('agendaContent');
            
            if (!dateSelectionnee) {
                container.innerHTML = '<div class="empty-state">Veuillez s√©lectionner une date</div>';
                return;
            }
            
            const date = new Date(dateSelectionnee);
            
            // Filtrer les sous-t√¢ches actives pour cette date
            const tachesActives = sousTaches.filter(st => {
                const debut = new Date(st.dateDebut);
                const fin = new Date(st.dateFin);
                return debut <= date && fin >= date;
            });
            
            if (tachesActives.length === 0) {
                container.innerHTML = '<div class="empty-state">Aucune t√¢che active pour cette date</div>';
                return;
            }
            
            let html = '';
            sousTaches.forEach(st => {
                const agent = agents.find(a => a.id === st.agentId);
                
                html += `<div class="agenda-item">
                    <div class="agenda-item-header">
                        <div class="agenda-item-title">üè¢ ${st.numAffaire} - ${st.designation}</div>
                        <div class="agenda-item-agent">${agent ? agent.nom : 'Non assign√©'}</div>
                    </div>
                    <div class="agenda-item-details">
                        üìã ${st.nom}<br>
                        üè¢ Client: ${st.client}<br>
                        üìÖ ${new Date(st.dateDebut).toLocaleDateString('fr-FR')} ‚Üí ${new Date(st.dateFin).toLocaleDateString('fr-FR')}
                    </div>
                </div>`;
            });
            
            container.innerHTML = html;
        }

        // ============================================
        // GESTION DES AGENTS
        // ============================================
        function ouvrirModalAgent(agentId = null) {
            const modal = document.getElementById('modalAgent');
            const titre = document.getElementById('modalAgentTitre');
            const form = document.getElementById('formAgent');
            
            form.reset();
            document.getElementById('agentIdEdit').value = '';
            
            if (agentId) {
                // Mode √©dition
                const agent = agents.find(a => a.id === agentId);
                if (agent) {
                    titre.textContent = '‚úèÔ∏è Modifier l\'Agent';
                    document.getElementById('agentIdEdit').value = agent.id;
                    document.getElementById('nomAgent').value = agent.nom;
                    document.getElementById('fonctionAgent').value = agent.fonction;
                    document.getElementById('emailAgent').value = agent.email || '';
                }
            } else {
                // Mode ajout
                titre.textContent = '‚ûï Ajouter un Agent';
            }
            
            modal.style.display = 'flex';
        }

        function fermerModalAgent() {
            document.getElementById('modalAgent').style.display = 'none';
            document.getElementById('formAgent').reset();
        }

        function sauvegarderAgent(event) {
            event.preventDefault();
            
            const nom = document.getElementById('nomAgent').value.trim();
            const fonction = document.getElementById('fonctionAgent').value.trim();
            const email = document.getElementById('emailAgent').value.trim();
            const agentIdEdit = document.getElementById('agentIdEdit').value;
            
            // Validation : √©viter les doublons
            const existant = agents.find(a => 
                a.nom.toLowerCase() === nom.toLowerCase() && 
                (!agentIdEdit || a.id !== parseInt(agentIdEdit))
            );
            
            if (existant) {
                alert('‚ùå Erreur : Un agent avec ce nom existe d√©j√† !');
                return;
            }
            
            if (agentIdEdit) {
                // Mode √©dition
                const agent = agents.find(a => a.id === parseInt(agentIdEdit));
                if (agent) {
                    agent.nom = nom;
                    agent.fonction = fonction;
                    agent.email = email;
                    
                    sauvegarderDonnees();
                    afficherAgents();
                    peuplerSelecteurs();
                    afficherStatistiques();
                    
                    // Rafra√Æchir l'onglet actif si n√©cessaire
                    const activeTab = document.querySelector('.tab.active');
                    if (activeTab) {
                        const tabName = activeTab.textContent.toLowerCase();
                        if (tabName.includes('planning')) {
                            afficherGantt();
                        }
                    }
                    
                    fermerModalAgent();
                    
                    // Message de succ√®s avec animation
                    afficherNotification('‚úÖ Agent modifi√© avec succ√®s !', 'success');
                }
            } else {
                // Mode ajout
                const agent = {
                    id: Date.now(),
                    nom,
                    fonction,
                    email
                };
                
                agents.push(agent);
                sauvegarderDonnees();
                afficherAgents();
                peuplerSelecteurs();
                afficherStatistiques();
                
                fermerModalAgent();
                
                // Message de succ√®s avec animation
                afficherNotification('‚úÖ Agent ajout√© avec succ√®s !', 'success');
            }
        }

        function afficherAgents() {
            const container = document.getElementById('listeAgents');
            
            if (agents.length === 0) {
                container.innerHTML = '<div class="empty-state">üë§ Aucun agent enregistr√©. Cliquez sur "Nouvel Agent" pour commencer.</div>';
                return;
            }
            
            let html = '<table class="table">';
            html += '<thead><tr>';
            html += '<th>üë§ Nom</th>';
            html += '<th>üíº Fonction</th>';
            html += '<th>üìß Email</th>';
            html += '<th style="text-align: center;">üè¢ Affaires</th>';
            html += '<th style="text-align: center;">‚è±Ô∏è Heures</th>';
            html += '<th style="text-align: center;">Actions</th>';
            html += '</tr></thead><tbody>';
            
            agents.forEach(agent => {
                // Calculer les statistiques de l'agent
                const affairesAgent = sousTaches.filter(st => st.agentId === agent.id);
                const nbAffaires = affairesAgent.length;
                const heuresRealisees = pointages
                    .filter(p => p.agentId === agent.id)
                    .reduce((sum, p) => sum + (p.heures || 0), 0);
                
                html += `<tr>
                    <td><strong>${agent.nom}</strong></td>
                    <td>${agent.fonction}</td>
                    <td>${agent.email || '<span style="color: #999;">Non renseign√©</span>'}</td>
                    <td style="text-align: center;">${nbAffaires}</td>
                    <td style="text-align: center;"><strong>${heuresRealisees}h</strong></td>
                    <td style="text-align: center;">
                        <button class="btn btn-info btn-small" onclick="ouvrirModalAgent(${agent.id})" title="Modifier">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-small" onclick="supprimerAgent(${agent.id})" title="Supprimer">üóëÔ∏è</button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function supprimerAgent(id) {
            const agent = agents.find(a => a.id === id);
            if (!agent) return;
            
            // V√©rifier si l'agent a des affaires ou pointages
            const affairesAgent = sousTaches.filter(st => st.agentId === id);
            const pointagesAgent = pointages.filter(p => p.agentId === id);
            
            let message = `Voulez-vous vraiment supprimer l'agent "${agent.nom}" ?\n\n`;
            
            if (affairesAgent.length > 0 || pointagesAgent.length > 0) {
                message += `‚ö†Ô∏è ATTENTION :\n`;
                if (affairesAgent.length > 0) {
                    message += `‚Ä¢ ${affairesAgent.length} affaire(s) assign√©e(s)\n`;
                }
                if (pointagesAgent.length > 0) {
                    message += `‚Ä¢ ${pointagesAgent.length} pointage(s) enregistr√©(s)\n`;
                }
                message += `\nCes donn√©es seront √©galement supprim√©es.`;
            }
            
            if (confirm(message)) {
                // Supprimer l'agent
                agents = agents.filter(a => a.id !== id);
                
                // Supprimer ses affaires
                sousTaches = sousTaches.filter(st => st.agentId !== id);
                
                // Supprimer ses pointages
                pointages = pointages.filter(p => p.agentId !== id);
                
                sauvegarderDonnees();
                afficherAgents();
                peuplerSelecteurs();
                afficherStatistiques();
                
                // Rafra√Æchir les autres vues si n√©cessaire
                const activeTab = document.querySelector('.tab.active');
                if (activeTab) {
                    const tabName = activeTab.textContent.toLowerCase();
                    if (tabName.includes('affaires')) {
                        afficherAffaires();
                    } else if (tabName.includes('planning')) {
                        afficherGantt();
                    }
                }
                
                afficherNotification('‚úÖ Agent supprim√© avec succ√®s !', 'success');
            }
        }

        function afficherStatistiques() {
            const container = document.getElementById('statistiquesGenerales');
            
            // Calculer les statistiques
            const nbAgents = agents.length;
            const nbAffaires = sousTaches.length;
            const nbAffairesEnCours = sousTaches.filter(st => st.statut === 'en-cours').length;
            const nbAffairesTerminees = sousTaches.filter(st => st.statut === 'termine').length;
            const totalHeuresRealisees = pointages.reduce((sum, p) => sum + (p.heures || 0), 0);
            const totalHeuresBudget = sousTaches.reduce((sum, st) => sum + (st.budgetHeures || 0), 0);
            const tauxRealisation = totalHeuresBudget > 0 ? ((totalHeuresRealisees / totalHeuresBudget) * 100).toFixed(1) : 0;
            
            let html = '';
            
            // Carte Agents
            html += `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px;">
                    <div style="font-size: 14px; opacity: 0.9;">üë• Agents</div>
                    <div style="font-size: 32px; font-weight: bold; margin: 10px 0;">${nbAgents}</div>
                    <div style="font-size: 12px; opacity: 0.8;">Total enregistr√©s</div>
                </div>
            `;
            
            // Carte Affaires
            html += `
                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 8px;">
                    <div style="font-size: 14px; opacity: 0.9;">üè¢ Affaires</div>
                    <div style="font-size: 32px; font-weight: bold; margin: 10px 0;">${nbAffaires}</div>
                    <div style="font-size: 12px; opacity: 0.8;">${nbAffairesEnCours} en cours ‚Ä¢ ${nbAffairesTerminees} termin√©es</div>
                </div>
            `;
            
            // Carte Heures
            html += `
                <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 8px;">
                    <div style="font-size: 14px; opacity: 0.9;">‚è±Ô∏è Heures R√©alis√©es</div>
                    <div style="font-size: 32px; font-weight: bold; margin: 10px 0;">${totalHeuresRealisees}h</div>
                    <div style="font-size: 12px; opacity: 0.8;">Budget: ${totalHeuresBudget}h</div>
                </div>
            `;
            
            // Carte Taux
            const couleurTaux = tauxRealisation > 100 ? '#dc3545' : tauxRealisation > 80 ? '#ffc107' : '#28a745';
            html += `
                <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 20px; border-radius: 8px;">
                    <div style="font-size: 14px; opacity: 0.9;">üìä Taux de R√©alisation</div>
                    <div style="font-size: 32px; font-weight: bold; margin: 10px 0;">${tauxRealisation}%</div>
                    <div style="font-size: 12px; opacity: 0.8;">Budget vs R√©alis√©</div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function afficherNotification(message, type = 'info') {
            // Cr√©er une notification temporaire
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
                color: white;
                border-radius: 4px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
                font-weight: 600;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ============================================
        // ANALYTICS & DASHBOARD
        // ============================================
        function afficherAnalytics() {
            // Calculer les KPIs
            calculerKPIs();
            
            // G√©n√©rer les graphiques
            setTimeout(() => {
                genererGraphiqueDistribution();
                genererGraphiqueEvolution();
                genererGraphiqueTopAgents();
                genererGraphiqueBudgetRealise();
                genererTableauPerformance();
            }, 100);
        }

        function calculerKPIs() {
            // KPI 1: Total Heures
            const totalHeures = pointages.reduce((sum, p) => sum + (p.heures || 0), 0);
            document.getElementById('kpiTotalHeures').textContent = totalHeures.toFixed(0) + 'h';
            
            // Calculer √©volution (simulation - √† adapter selon vos besoins)
            const evolution = '+12.5';
            document.getElementById('kpiTotalHeuresEvolution').innerHTML = 
                `üìà ${evolution}% vs mois dernier`;

            // KPI 2: Projets Actifs
            const projetsUniques = new Set(sousTaches.map(st => st.numAffaire));
            const projetsActifs = projetsUniques.size;
            document.getElementById('kpiProjetsActifs').textContent = projetsActifs;
            
            const projetsEnCours = sousTaches.filter(st => st.statut === 'en-cours').length;
            document.getElementById('kpiProjetsDetails').innerHTML = 
                `üéØ ${projetsEnCours} en cours`;

            // KPI 3: Taux de Compl√©tion
            const totalBudget = sousTaches.reduce((sum, st) => sum + (st.budgetHeures || 0), 0);
            const totalRealise = sousTaches.reduce((sum, st) => sum + calculerRealise(st.id), 0);
            const tauxCompletion = totalBudget > 0 ? (totalRealise / totalBudget) * 100 : 0;
            document.getElementById('kpiTauxCompletion').textContent = tauxCompletion.toFixed(0) + '%';

            // KPI 4: Agents Actifs
            const agentsAvecPointage = new Set(pointages.map(p => p.agentId));
            document.getElementById('kpiAgentsActifs').textContent = agentsAvecPointage.size;
            document.getElementById('kpiAgentsDetails').innerHTML = 
                `üë• ${agents.length} total agents`;
        }

        function genererGraphiqueDistribution() {
            const canvas = document.getElementById('chartHeuresParProjet');
            const ctx = canvas.getContext('2d');
            
            // Pr√©parer les donn√©es
            const projetsData = {};
            sousTaches.forEach(st => {
                const heures = calculerRealise(st.id);
                if (heures > 0) {
                    if (!projetsData[st.numAffaire]) {
                        projetsData[st.numAffaire] = 0;
                    }
                    projetsData[st.numAffaire] += heures;
                }
            });

            const labels = Object.keys(projetsData).slice(0, 10);
            const data = Object.values(projetsData).slice(0, 10);
            const total = data.reduce((a, b) => a + b, 0);
            
            // Couleurs
            const colors = [
                '#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a',
                '#feca57', '#48dbfb', '#ff6348', '#8e44ad', '#3498db'
            ];

            // Dessiner le graphique (camembert)
            canvas.width = canvas.offsetWidth;
            canvas.height = 300;
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 30;
            
            let currentAngle = -Math.PI / 2;
            
            data.forEach((value, index) => {
                const sliceAngle = (value / total) * 2 * Math.PI;
                
                // Dessiner la tranche
                ctx.beginPath();
                ctx.fillStyle = colors[index % colors.length];
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fill();
                
                // Bordure
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                currentAngle += sliceAngle;
            });

            // L√©gende
            let legendHTML = '';
            labels.forEach((label, index) => {
                const percentage = ((data[index] / total) * 100).toFixed(1);
                legendHTML += `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 16px; height: 16px; background: ${colors[index % colors.length]}; border-radius: 3px;"></div>
                        <span><strong>${label}</strong>: ${data[index].toFixed(0)}h (${percentage}%)</span>
                    </div>
                `;
            });
            document.getElementById('distributionLegend').innerHTML = legendHTML;
        }

        function genererGraphiqueEvolution() {
            const canvas = document.getElementById('chartEvolutionMensuelle');
            const ctx = canvas.getContext('2d');
            
            canvas.width = canvas.offsetWidth;
            canvas.height = 300;
            
            // Calculer les donn√©es des 6 derniers mois
            const moisData = [];
            const today = new Date();
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const mois = date.getMonth();
                const annee = date.getFullYear();
                const moisNom = date.toLocaleDateString('fr-FR', { month: 'short', year: '2-digit' });
                
                const heuresMois = pointages.filter(p => {
                    const pDate = new Date(p.date);
                    return pDate.getMonth() === mois && pDate.getFullYear() === annee;
                }).reduce((sum, p) => sum + (p.heures || 0), 0);
                
                moisData.push({ label: moisNom, heures: heuresMois });
            }

            // Dessiner le graphique en ligne
            const padding = 40;
            const chartWidth = canvas.width - (padding * 2);
            const chartHeight = canvas.height - (padding * 2);
            const maxHeures = Math.max(...moisData.map(m => m.heures), 100);
            
            // Axes
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();
            
            // Ligne et points
            ctx.strokeStyle = '#0066cc';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            const stepX = chartWidth / (moisData.length - 1);
            
            moisData.forEach((item, index) => {
                const x = padding + (index * stepX);
                const y = canvas.height - padding - ((item.heures / maxHeures) * chartHeight);
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                
                // Point
                ctx.fillStyle = '#0066cc';
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, 2 * Math.PI);
                ctx.fill();
                
                // Label
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(item.label, x, canvas.height - padding + 20);
                ctx.fillText(item.heures.toFixed(0) + 'h', x, y - 10);
            });
            
            ctx.stroke();
        }

        function genererGraphiqueTopAgents() {
            const canvas = document.getElementById('chartTopAgents');
            const ctx = canvas.getContext('2d');
            
            canvas.width = canvas.offsetWidth;
            canvas.height = 350;
            
            // Calculer les heures par agent
            const agentsHeures = {};
            pointages.forEach(p => {
                if (!agentsHeures[p.agentId]) {
                    agentsHeures[p.agentId] = 0;
                }
                agentsHeures[p.agentId] += p.heures || 0;
            });

            // Trier et prendre top 10
            const topAgents = Object.entries(agentsHeures)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([id, heures]) => {
                    const agent = agents.find(a => a.id == id);
                    return {
                        nom: agent ? agent.nom : 'Inconnu',
                        heures: heures
                    };
                });

            // Dessiner barres horizontales
            const padding = 40;
            const barHeight = 25;
            const spacing = 10;
            const maxHeures = Math.max(...topAgents.map(a => a.heures), 1);
            
            topAgents.forEach((agent, index) => {
                const y = padding + (index * (barHeight + spacing));
                const barWidth = ((agent.heures / maxHeures) * (canvas.width - padding * 2 - 150));
                
                // Barre
                const gradient = ctx.createLinearGradient(padding + 150, 0, padding + 150 + barWidth, 0);
                gradient.addColorStop(0, '#667eea');
                gradient.addColorStop(1, '#764ba2');
                ctx.fillStyle = gradient;
                ctx.fillRect(padding + 150, y, barWidth, barHeight);
                
                // Nom de l'agent
                ctx.fillStyle = '#333';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(agent.nom, padding + 140, y + 17);
                
                // Valeur
                ctx.fillStyle = '#fff';
                ctx.textAlign = 'left';
                ctx.fillText(agent.heures.toFixed(0) + 'h', padding + 155, y + 17);
            });
        }

        function genererGraphiqueBudgetRealise() {
            const canvas = document.getElementById('chartBudgetRealise');
            const ctx = canvas.getContext('2d');
            
            canvas.width = canvas.offsetWidth;
            canvas.height = 350;
            
            // Donn√©es par projet
            const projetsData = [];
            const projetsUniques = [...new Set(sousTaches.map(st => st.numAffaire))].slice(0, 10);
            
            projetsUniques.forEach(numAffaire => {
                const taches = sousTaches.filter(st => st.numAffaire === numAffaire);
                const budget = taches.reduce((sum, st) => sum + (st.budgetHeures || 0), 0);
                const realise = taches.reduce((sum, st) => sum + calculerRealise(st.id), 0);
                
                projetsData.push({
                    nom: numAffaire,
                    budget: budget,
                    realise: realise
                });
            });

            // Dessiner barres group√©es
            const padding = 50;
            const barWidth = 20;
            const groupSpacing = 40;
            const maxValue = Math.max(...projetsData.flatMap(p => [p.budget, p.realise]), 100);
            
            projetsData.forEach((projet, index) => {
                const x = padding + (index * groupSpacing);
                const budgetHeight = (projet.budget / maxValue) * (canvas.height - padding * 2);
                const realiseHeight = (projet.realise / maxValue) * (canvas.height - padding * 2);
                
                // Barre Budget
                ctx.fillStyle = '#ddd';
                ctx.fillRect(x, canvas.height - padding - budgetHeight, barWidth, budgetHeight);
                
                // Barre R√©alis√©
                const color = projet.realise > projet.budget ? '#dc3545' : '#28a745';
                ctx.fillStyle = color;
                ctx.fillRect(x + barWidth + 5, canvas.height - padding - realiseHeight, barWidth, realiseHeight);
                
                // Label
                ctx.fillStyle = '#333';
                ctx.font = '10px Arial';
                ctx.save();
                ctx.translate(x + 15, canvas.height - padding + 10);
                ctx.rotate(-Math.PI / 4);
                ctx.fillText(projet.nom, 0, 0);
                ctx.restore();
            });

            // L√©gende
            ctx.fillStyle = '#ddd';
            ctx.fillRect(canvas.width - 150, 20, 15, 15);
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.fillText('Budget', canvas.width - 130, 32);
            
            ctx.fillStyle = '#28a745';
            ctx.fillRect(canvas.width - 150, 40, 15, 15);
            ctx.fillText('R√©alis√©', canvas.width - 130, 52);
        }

        function genererTableauPerformance() {
            const container = document.getElementById('tableauPerformance');
            
            const projetsUniques = [...new Set(sousTaches.map(st => st.numAffaire))];
            
            let html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Projet</th>
                            <th>Budget (h)</th>
                            <th>R√©alis√© (h)</th>
                            <th>Taux (%)</th>
                            <th>√âcart (h)</th>
                            <th>Statut</th>
                            <th>Performance</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            projetsUniques.forEach(numAffaire => {
                const taches = sousTaches.filter(st => st.numAffaire === numAffaire);
                const budget = taches.reduce((sum, st) => sum + (st.budgetHeures || 0), 0);
                const realise = taches.reduce((sum, st) => sum + calculerRealise(st.id), 0);
                const taux = budget > 0 ? (realise / budget) * 100 : 0;
                const ecart = realise - budget;
                
                let statusColor = '#28a745';
                let statusText = 'Conforme';
                let perfBar = 'background: linear-gradient(90deg, #28a745 0%, #28a745 ' + Math.min(taux, 100) + '%, #f0f0f0 ' + Math.min(taux, 100) + '%)';
                
                if (taux >= 100) {
                    statusColor = '#dc3545';
                    statusText = 'D√©pass√©';
                    perfBar = 'background: linear-gradient(90deg, #dc3545 0%, #dc3545 100%)';
                } else if (taux >= 80) {
                    statusColor = '#ffc107';
                    statusText = 'Critique';
                }

                html += `
                    <tr>
                        <td><strong>${numAffaire}</strong></td>
                        <td>${budget.toFixed(0)}h</td>
                        <td>${realise.toFixed(0)}h</td>
                        <td><strong>${taux.toFixed(1)}%</strong></td>
                        <td style="color: ${ecart >= 0 ? '#dc3545' : '#28a745'}">
                            ${ecart >= 0 ? '+' : ''}${ecart.toFixed(0)}h
                        </td>
                        <td>
                            <span style="background: ${statusColor}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                ${statusText}
                            </span>
                        </td>
                        <td>
                            <div style="width: 100%; height: 20px; ${perfBar}; border-radius: 10px;"></div>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        function exportAnalytics() {
            // Export des donn√©es analytics en CSV avec en-t√™te CNIM
            const dateExport = new Date().toLocaleDateString('fr-FR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            let csv = 'CNIM BABCOCK MAROC - D√©partement M√©thode\n';
            csv += 'Rapport Analytics - Gestion de Pointage et Planning\n';
            csv += 'G√©n√©r√© le: ' + dateExport + '\n';
            csv += '\n';
            csv += 'Projet,Budget (h),R√©alis√© (h),Taux (%),√âcart (h),Statut\n';
            
            const projetsUniques = [...new Set(sousTaches.map(st => st.numAffaire))];
            
            projetsUniques.forEach(numAffaire => {
                const taches = sousTaches.filter(st => st.numAffaire === numAffaire);
                const budget = taches.reduce((sum, st) => sum + (st.budgetHeures || 0), 0);
                const realise = taches.reduce((sum, st) => sum + calculerRealise(st.id), 0);
                const taux = budget > 0 ? (realise / budget) * 100 : 0;
                const ecart = realise - budget;
                const statut = taux >= 100 ? 'D√©pass√©' : (taux >= 80 ? 'Critique' : 'Conforme');
                
                csv += `${numAffaire},${budget.toFixed(2)},${realise.toFixed(2)},${taux.toFixed(2)},${ecart.toFixed(2)},${statut}\n`;
            });
            
            csv += '\n';
            csv += '---\n';
            csv += 'Document g√©n√©r√© automatiquement par le syst√®me CNIM\n';
            csv += '¬© CNIM BABCOCK MAROC - Tous droits r√©serv√©s\n';

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'CNIM_Analytics_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            
            afficherNotification('‚úÖ Rapport Analytics CNIM export√© avec succ√®s', 'success');
        }

        // ============================================
        // IMPORT/EXPORT
        // ============================================
        function exporterDonnees() {
            const data = {
                entreprise: 'CNIM BABCOCK MAROC',
                departement: 'D√©partement M√©thode',
                systeme: 'Gestion de Pointage et Planning',
                dateExport: new Date().toISOString(),
                dateExportFormatee: new Date().toLocaleDateString('fr-FR', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }),
                version: '2.0',
                donnees: {
                    agents,
                    sousTaches,
                    pointages
                },
                statistiques: {
                    totalAgents: agents.length,
                    totalAffaires: sousTaches.length,
                    totalPointages: pointages.length,
                    heuresBudget: sousTaches.reduce((sum, st) => sum + (st.budgetHeures || 0), 0),
                    heuresRealisees: pointages.reduce((sum, p) => sum + (p.heures || 0), 0)
                }
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CNIM_Export_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            afficherNotification('‚úÖ Donn√©es CNIM export√©es en JSON !', 'success');
        }

        function exporterDonneesExcel() {
            // Cr√©er un classeur Excel avec toutes les donn√©es
            const wb = XLSX.utils.book_new();
            
            // Propri√©t√©s du document
            wb.Props = {
                Title: "Export Donn√©es - CNIM BABCOCK MAROC",
                Subject: "Gestion de Pointage et Planning",
                Author: "D√©partement M√©thode - CNIM",
                CreatedDate: new Date()
            };
            
            // Feuille 0 : Page de garde
            const dateExport = new Date().toLocaleDateString('fr-FR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const coverData = [
                ['CNIM BABCOCK MAROC'],
                [''],
                ['D√©partement M√©thode'],
                [''],
                ['EXPORT COMPLET DES DONN√âES'],
                ['Gestion de Pointage et Planning'],
                [''],
                [''],
                ['Date d\'export:', dateExport],
                ['Nombre d\'agents:', agents.length],
                ['Nombre d\'affaires:', sousTaches.length],
                ['Nombre de pointages:', pointages.length],
                [''],
                [''],
                ['Contenu du fichier:'],
                ['- Feuille 1: Liste des agents'],
                ['- Feuille 2: Affaires et sous-t√¢ches'],
                ['- Feuille 3: Pointages d√©taill√©s'],
                ['- Feuille 4: Synth√®se par affaire'],
                [''],
                [''],
                ['Document g√©n√©r√© automatiquement'],
                ['¬© CNIM BABCOCK MAROC - Tous droits r√©serv√©s']
            ];
            const wsCover = XLSX.utils.aoa_to_sheet(coverData);
            wsCover['!cols'] = [{ wch: 40 }, { wch: 30 }];
            XLSX.utils.book_append_sheet(wb, wsCover, 'Informations');
            
            // Feuille 1 : Agents
            const agentsData = [
                ['CNIM BABCOCK MAROC - D√©partement M√©thode'],
                ['Export des Agents - ' + dateExport],
                [''],
                ['ID', 'Nom', 'Fonction', 'Email', 'Nb Affaires', 'Heures R√©alis√©es']
            ];
            agents.forEach(agent => {
                const affairesAgent = sousTaches.filter(st => st.agentId === agent.id).length;
                const heuresAgent = pointages.filter(p => p.agentId === agent.id)
                    .reduce((sum, p) => sum + (p.heures || 0), 0);
                agentsData.push([
                    agent.id,
                    agent.nom,
                    agent.fonction,
                    agent.email || '',
                    affairesAgent,
                    heuresAgent
                ]);
            });
            const wsAgents = XLSX.utils.aoa_to_sheet(agentsData);
            wsAgents['!cols'] = [
                { wch: 10 }, // ID
                { wch: 25 }, // Nom
                { wch: 20 }, // Fonction
                { wch: 30 }, // Email
                { wch: 12 }, // Nb Affaires
                { wch: 15 }  // Heures
            ];
            XLSX.utils.book_append_sheet(wb, wsAgents, 'Agents');
            
            // Feuille 2 : Affaires / Sous-t√¢ches
            const affairesData = [
                ['CNIM BABCOCK MAROC - D√©partement M√©thode'],
                ['Export des Affaires - ' + dateExport],
                [''],
                ['ID', 'N¬∞ Affaire', 'Client', 'D√©signation', 'Nom', 'Type', 'Agent', 'Budget (h)', 
                 'Date D√©but', 'Date Fin', 'Priorit√©', 'Statut']
            ];
            sousTaches.forEach(st => {
                const agent = agents.find(a => a.id === st.agentId);
                affairesData.push([
                    st.id,
                    st.numAffaire,
                    st.client,
                    st.designation,
                    st.nom,
                    st.typeSousTache,
                    agent ? agent.nom : '',
                    st.budgetHeures || 0,
                    st.dateDebut,
                    st.dateFin,
                    st.priorite,
                    st.statut
                ]);
            });
            const wsAffaires = XLSX.utils.aoa_to_sheet(affairesData);
            wsAffaires['!cols'] = [
                { wch: 10 }, // ID
                { wch: 15 }, // N¬∞ Affaire
                { wch: 20 }, // Client
                { wch: 30 }, // D√©signation
                { wch: 25 }, // Nom
                { wch: 20 }, // Type
                { wch: 20 }, // Agent
                { wch: 12 }, // Budget
                { wch: 12 }, // Date D√©but
                { wch: 12 }, // Date Fin
                { wch: 10 }, // Priorit√©
                { wch: 12 }  // Statut
            ];
            XLSX.utils.book_append_sheet(wb, wsAffaires, 'Affaires');
            
            // Feuille 3 : Pointages
            const pointagesData = [
                ['CNIM BABCOCK MAROC - D√©partement M√©thode'],
                ['Export des Pointages - ' + dateExport],
                [''],
                ['ID', 'Date', 'Agent', 'N¬∞ Affaire', 'Nom Affaire', 'Heures', 'Type']
            ];
            pointages.forEach(p => {
                const agent = agents.find(a => a.id === p.agentId);
                const st = sousTaches.find(s => s.id === p.sousTacheId);
                pointagesData.push([
                    p.id,
                    p.date,
                    agent ? agent.nom : '',
                    st ? st.numAffaire : '',
                    st ? st.nom : '',
                    p.heures,
                    p.type || ''
                ]);
            });
            const wsPointages = XLSX.utils.aoa_to_sheet(pointagesData);
            wsPointages['!cols'] = [
                { wch: 10 }, // ID
                { wch: 12 }, // Date
                { wch: 20 }, // Agent
                { wch: 15 }, // N¬∞ Affaire
                { wch: 30 }, // Nom Affaire
                { wch: 10 }, // Heures
                { wch: 8 }   // Type
            ];
            XLSX.utils.book_append_sheet(wb, wsPointages, 'Pointages');
            
            // Feuille 4 : Synth√®se
            const syntheseData = [
                ['CNIM BABCOCK MAROC - D√©partement M√©thode'],
                ['Synth√®se Globale - ' + dateExport],
                [''],
                ['STATISTIQUES G√âN√âRALES'],
                [''],
                ['Total Agents', agents.length],
                ['Total Affaires', sousTaches.length],
                ['Affaires en cours', sousTaches.filter(st => st.statut === 'en-cours').length],
                ['Affaires termin√©es', sousTaches.filter(st => st.statut === 'termine').length],
                ['Affaires en retard', sousTaches.filter(st => st.statut === 'en-retard').length],
                [''],
                ['HEURES'],
                [''],
                ['Heures Budget Total', sousTaches.reduce((sum, st) => sum + (st.budgetHeures || 0), 0)],
                ['Heures R√©alis√©es Total', pointages.reduce((sum, p) => sum + (p.heures || 0), 0)],
                ['Nombre de Pointages', pointages.length],
                [''],
                ['INFORMATIONS EXPORT'],
                [''],
                ['Date Export', new Date().toLocaleString('fr-FR')],
                ['G√©n√©r√© par', 'Syst√®me de Gestion CNIM'],
                ['Version', '2.0']
            ];
            const wsSynthese = XLSX.utils.aoa_to_sheet(syntheseData);
            wsSynthese['!cols'] = [{ wch: 30 }, { wch: 20 }];
            XLSX.utils.book_append_sheet(wb, wsSynthese, 'Synth√®se');
            
            // T√©l√©charger
            XLSX.writeFile(wb, `CNIM_Donnees_Completes_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            afficherNotification('‚úÖ Donn√©es export√©es en Excel avec informations CNIM !', 'success');
        }

        function importerDonnees(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validation basique
                    if (!data.agents || !Array.isArray(data.agents)) {
                        throw new Error('Format de donn√©es invalide');
                    }
                    
                    if (confirm('‚ö†Ô∏è L\'importation remplacera toutes les donn√©es actuelles. Continuer ?')) {
                        agents = data.agents || [];
                        sousTaches = data.sousTaches || [];
                        pointages = data.pointages || [];
                        
                        sauvegarderDonnees();
                        
                        // Rafra√Æchir toutes les vues
                        peuplerSelecteurs();
                        afficherAffaires();
                        afficherVueParAffaire();
                        afficherSynthese();
                        afficherAgents();
                        afficherHistoriquePointages();
                        afficherStatistiques();
                        afficherGantt();
                        
                        afficherNotification('‚úÖ Donn√©es import√©es avec succ√®s !', 'success');
                    }
                } catch (err) {
                    afficherNotification('‚ùå Erreur lors de l\'importation : fichier invalide', 'error');
                    console.error(err);
                }
            };
            reader.readAsText(file);
            
            // R√©initialiser l'input
            event.target.value = '';
        }

        function reinitialiserDonnees() {
            if (confirm('‚ö†Ô∏è ATTENTION : Cette action supprimera toutes les donn√©es. √ätes-vous s√ªr ?')) {
                if (confirm('Confirmation finale : toutes les donn√©es seront perdues !')) {
                    localStorage.removeItem('appPointageData');
                    initialiserDonneesParDefaut();
                    
                    // Rafra√Æchir toutes les vues
                    peuplerSelecteurs();
                    afficherAffaires();
                    afficherVueParAffaire();
                    afficherSynthese();
                    afficherAgents();
                    afficherHistoriquePointages();
                    afficherStatistiques();
                    afficherGantt();
                    
                    afficherNotification('‚úÖ Donn√©es r√©initialis√©es !', 'success');
                }
            }
        }

        // ============================================
        // GESTION THEME ET DENSIT√â
        // ============================================
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('appTheme', newTheme);
            updateThemeButton();
        }

        function updateThemeButton() {
            const theme = document.documentElement.getAttribute('data-theme') || 'light';
            const btn = document.querySelector('.theme-toggle');
            if (btn) {
                btn.textContent = theme === 'light' ? 'üåô Mode Sombre' : '‚òÄÔ∏è Mode Clair';
            }
        }

        function toggleDensity() {
            const isCompact = document.body.classList.contains('compact');
            if (isCompact) {
                document.body.classList.remove('compact');
                localStorage.setItem('appDensity', 'normal');
            } else {
                document.body.classList.add('compact');
                localStorage.setItem('appDensity', 'compact');
            }
            updateDensityButton();
        }

        function updateDensityButton() {
            const isCompact = document.body.classList.contains('compact');
            const buttons = document.querySelectorAll('.theme-toggle');
            if (buttons[1]) {
                buttons[1].textContent = isCompact ? 'üìè Normal' : 'üìè Compact';
            }
        }

        // ============================================
        // INDICATEUR DE PROCESSUS CIN√âMATIQUE
        // ============================================
        let processTimerInterval = null;
        let processStartTime = null;

        function showProcessIndicator(processName, steps) {
            const indicator = document.getElementById('processIndicator');
            const titleEl = document.getElementById('processTitle');
            const stepsContainer = document.getElementById('processSteps');
            
            // D√©finir le titre
            titleEl.textContent = 'üé¨ ' + processName;
            
            // G√©n√©rer les √©tapes
            stepsContainer.innerHTML = '';
            steps.forEach((step, index) => {
                const stepEl = document.createElement('div');
                stepEl.className = 'process-step';
                stepEl.id = 'processStep' + index;
                
                stepEl.innerHTML = `
                    <div class="process-step-icon" id="stepIcon${index}">
                        ${step.icon || (index + 1)}
                    </div>
                    <div class="process-step-content">
                        <div class="process-step-label">${step.label}</div>
                        <div class="process-step-description">${step.description || ''}</div>
                    </div>
                    <div class="process-step-status" id="stepStatus${index}">En attente</div>
                `;
                
                stepsContainer.appendChild(stepEl);
            });
            
            // R√©initialiser la progression
            updateGlobalProgress(0);
            
            // D√©marrer le timer
            startProcessTimer();
            
            // Afficher l'indicateur avec animation
            indicator.classList.add('active');
        }

        function updateProcessStep(stepIndex, status, customLabel) {
            const stepEl = document.getElementById('processStep' + stepIndex);
            const statusEl = document.getElementById('stepStatus' + stepIndex);
            
            if (!stepEl || !statusEl) return;
            
            // Retirer toutes les classes de statut
            stepEl.classList.remove('completed', 'active');
            
            // Appliquer le nouveau statut
            if (status === 'active') {
                stepEl.classList.add('active');
                statusEl.textContent = customLabel || '‚è≥ En cours...';
                statusEl.style.background = 'linear-gradient(135deg, #ffc107, #ff9800)';
            } else if (status === 'completed') {
                stepEl.classList.add('completed');
                statusEl.textContent = customLabel || '‚úì Termin√©';
                statusEl.style.background = 'linear-gradient(135deg, #4caf50, #66bb6a)';
            } else {
                statusEl.textContent = customLabel || 'En attente';
                statusEl.style.background = 'linear-gradient(135deg, #9e9e9e, #bdbdbd)';
            }
            
            // Calculer et mettre √† jour la progression globale
            const allSteps = document.querySelectorAll('.process-step');
            const completedSteps = document.querySelectorAll('.process-step.completed');
            const progress = (completedSteps.length / allSteps.length) * 100;
            updateGlobalProgress(progress);
        }

        function updateGlobalProgress(percentage) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressPercentage');
            
            if (progressBar && progressText) {
                progressBar.style.width = percentage + '%';
                progressText.textContent = Math.round(percentage) + '%';
            }
            
            // Si 100%, arr√™ter le timer et fermer automatiquement apr√®s 2 secondes
            if (percentage >= 100) {
                stopProcessTimer();
                setTimeout(() => {
                    closeProcessIndicator();
                }, 2000);
            }
        }

        function startProcessTimer() {
            processStartTime = Date.now();
            const timerEl = document.getElementById('processTimer');
            
            if (processTimerInterval) {
                clearInterval(processTimerInterval);
            }
            
            processTimerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - processStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                timerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        function stopProcessTimer() {
            if (processTimerInterval) {
                clearInterval(processTimerInterval);
                processTimerInterval = null;
            }
        }

        function closeProcessIndicator() {
            const indicator = document.getElementById('processIndicator');
            indicator.classList.remove('active');
            stopProcessTimer();
            
            // R√©initialiser apr√®s l'animation
            setTimeout(() => {
                document.getElementById('processSteps').innerHTML = '';
                document.getElementById('processTimer').textContent = '00:00';
                updateGlobalProgress(0);
            }, 400);
        }

        // Fonction de d√©monstration du processus
        function demoProcessIndicator() {
            showProcessIndicator('D√©monstration Processus Cin√©matique', [
                { label: 'Initialisation', description: 'D√©marrage du syst√®me', icon: 'üöÄ' },
                { label: 'Chargement donn√©es', description: 'Lecture base de donn√©es', icon: 'üìä' },
                { label: 'Traitement', description: 'Analyse et calculs', icon: '‚öôÔ∏è' },
                { label: 'G√©n√©ration rapport', description: 'Cr√©ation document', icon: 'üìÑ' },
                { label: 'Exportation', description: 'Sauvegarde fichier', icon: 'üíæ' },
                { label: 'Finalisation', description: 'Processus termin√©', icon: '‚úÖ' }
            ]);
            
            // Simuler la progression des √©tapes
            let currentStep = 0;
            const stepInterval = setInterval(() => {
                if (currentStep > 0) {
                    updateProcessStep(currentStep - 1, 'completed');
                }
                
                if (currentStep < 6) {
                    updateProcessStep(currentStep, 'active');
                    currentStep++;
                } else {
                    clearInterval(stepInterval);
                }
            }, 1500);
        }

        // ============================================
        // RECHERCHE GLOBALE ET FILTRES
        // ============================================
        let currentFilters = {
            search: '',
            statut: '',
            priorite: '',
            dateDebut: '',
            dateFin: ''
        };

        let affairesViewMode = 'table'; // 'table' ou 'kanban'

        function applyGlobalFilters() {
            currentFilters.search = document.getElementById('globalSearchInput').value.toLowerCase();
            currentFilters.statut = document.getElementById('filterStatut').value;
            currentFilters.priorite = document.getElementById('filterPriorite').value;
            currentFilters.dateDebut = document.getElementById('filterDateDebut').value;
            currentFilters.dateFin = document.getElementById('filterDateFin').value;

            if (affairesViewMode === 'table') {
                afficherAffairesFiltered();
            } else {
                afficherKanbanFiltered();
            }
        }

        function afficherAffairesFiltered() {
            const tbody = document.getElementById('listeAffaires');
            
            let tachesFiltrees = sousTaches.filter(st => {
                const agent = agents.find(a => a.id === st.agentId);
                const agentNom = agent ? agent.nom.toLowerCase() : '';
                
                const matchSearch = !currentFilters.search || 
                    st.numAffaire.toLowerCase().includes(currentFilters.search) ||
                    st.client.toLowerCase().includes(currentFilters.search) ||
                    st.designation.toLowerCase().includes(currentFilters.search) ||
                    st.nom.toLowerCase().includes(currentFilters.search) ||
                    agentNom.includes(currentFilters.search);
                
                const matchStatut = !currentFilters.statut || st.statut === currentFilters.statut;
                const matchPriorite = !currentFilters.priorite || st.priorite === currentFilters.priorite;
                
                let matchDate = true;
                if (currentFilters.dateDebut) {
                    matchDate = matchDate && new Date(st.dateDebut) >= new Date(currentFilters.dateDebut);
                }
                if (currentFilters.dateFin) {
                    matchDate = matchDate && new Date(st.dateFin) <= new Date(currentFilters.dateFin);
                }
                
                return matchSearch && matchStatut && matchPriorite && matchDate;
            });
            
            if (tachesFiltrees.length === 0) {
                tbody.innerHTML = '<tr><td colspan="14" class="empty-state">Aucune affaire ne correspond aux filtres</td></tr>';
                return;
            }
            
            const prioriteOrder = { 'urgente': 1, 'haute': 2, 'normale': 3, 'basse': 4 };
            tachesFiltrees.sort((a, b) => {
                if (prioriteOrder[a.priorite] !== prioriteOrder[b.priorite]) {
                    return prioriteOrder[a.priorite] - prioriteOrder[b.priorite];
                }
                return new Date(a.dateFin) - new Date(b.dateFin);
            });
            
            let html = '';
            
            tachesFiltrees.forEach(st => {
                const agent = agents.find(a => a.id === st.agentId);
                const realise = calculerRealise(st.id);
                const avancement = calculerAvancement(realise, st.budgetHeures);
                
                let progressClass = '';
                if (avancement >= 80) progressClass = 'warning';
                if (avancement >= 100) progressClass = 'danger';
                
                const statutClass = `status-${st.statut}`;
                const statutLabels = {
                    'en-attente': 'En attente',
                    'en-cours': 'En cours',
                    'termine': 'Termin√©',
                    'suspendu': 'Suspendu'
                };
                
                const prioriteClass = `priority-${st.priorite}`;
                const prioriteLabels = {
                    'basse': 'üü¢ Basse',
                    'normale': 'üü° Normale',
                    'haute': 'üü† Haute',
                    'urgente': 'üî¥ Urgente'
                };

                // Calculer les √©tiquettes visuelles
                const labels = calculerEtiquettesVisuelles(st);
                const labelsHTML = labels.length > 0 ? 
                    '<div class="visual-labels">' + labels.map(l => 
                        `<span class="label-badge label-${l.type}">${l.text}</span>`
                    ).join('') + '</div>' : '';
                
                html += `<tr>
                    <td><strong>${st.numAffaire}</strong></td>
                    <td>${st.client}</td>
                    <td>${st.designation}</td>
                    <td>
                        ${st.nom}
                        ${labelsHTML}
                    </td>
                    <td><span class="type-badge">${getTypeLabel(st.typeSousTache)}</span></td>
                    <td>${agent ? agent.nom : 'Non assign√©'}</td>
                    <td>${new Date(st.dateDebut).toLocaleDateString('fr-FR')}</td>
                    <td>${new Date(st.dateFin).toLocaleDateString('fr-FR')}</td>
                    <td><span class="priority-badge ${prioriteClass}">${prioriteLabels[st.priorite]}</span></td>
                    <td><strong>${st.budgetHeures}h</strong></td>
                    <td><strong>${realise}h</strong></td>
                    <td>
                        <div class="progress-bar-container">
                            <div class="progress-bar ${progressClass}" style="width: ${avancement}%"></div>
                            <div class="progress-text">${avancement}%</div>
                        </div>
                    </td>
                    <td><span class="status-badge ${statutClass}">${statutLabels[st.statut]}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-small" onclick="editerAffaire(${st.id})" title="√âditer">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-small" onclick="supprimerSousTache(${st.id})" title="Supprimer">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>`;
            });
            
            tbody.innerHTML = html;
        }

        function calculerEtiquettesVisuelles(sousTache) {
            const labels = [];
            const now = new Date();
            const dateFin = new Date(sousTache.dateFin);
            const joursRestants = Math.ceil((dateFin - now) / (1000 * 60 * 60 * 24));

            // √Ä risque : ‚â§ 7 jours
            if (joursRestants > 0 && joursRestants <= 7 && sousTache.statut !== 'termine') {
                labels.push({ type: 'risque', text: `√Ä risque (${joursRestants}j)` });
            }

            // En retard : d√©passement de la date de fin
            if (joursRestants < 0 && sousTache.statut !== 'termine') {
                labels.push({ type: 'retard', text: `En retard (${Math.abs(joursRestants)}j)` });
            }

            // Bloqu√© : d√©pendance non termin√©e (simul√© - pourrait √™tre √©tendu avec une vraie logique de d√©pendances)
            if (sousTache.statut === 'suspendu') {
                labels.push({ type: 'bloque', text: 'Bloqu√©' });
            }

            return labels;
        }

        // ============================================
        // VUE KANBAN
        // ============================================
        function switchAffairesView(mode) {
            affairesViewMode = mode;
            
            if (mode === 'table') {
                document.getElementById('tableViewContainer').style.display = 'block';
                document.getElementById('kanbanViewContainer').style.display = 'none';
                document.getElementById('btnViewTable').classList.add('btn-primary');
                document.getElementById('btnViewTable').classList.remove('btn-secondary');
                document.getElementById('btnViewKanban').classList.add('btn-secondary');
                document.getElementById('btnViewKanban').classList.remove('btn-primary');
                afficherAffairesFiltered();
            } else {
                document.getElementById('tableViewContainer').style.display = 'none';
                document.getElementById('kanbanViewContainer').style.display = 'block';
                document.getElementById('btnViewTable').classList.add('btn-secondary');
                document.getElementById('btnViewTable').classList.remove('btn-primary');
                document.getElementById('btnViewKanban').classList.add('btn-primary');
                document.getElementById('btnViewKanban').classList.remove('btn-secondary');
                afficherKanbanFiltered();
            }
        }

        function afficherKanbanFiltered() {
            const statuts = ['en-attente', 'en-cours', 'termine', 'suspendu'];
            
            statuts.forEach(statut => {
                const container = document.getElementById(`kanban-${statut}`);
                const count = document.getElementById(`count-${statut}`);
                
                let tachesFiltrees = sousTaches.filter(st => {
                    const agent = agents.find(a => a.id === st.agentId);
                    const agentNom = agent ? agent.nom.toLowerCase() : '';
                    
                    const matchSearch = !currentFilters.search || 
                        st.numAffaire.toLowerCase().includes(currentFilters.search) ||
                        st.client.toLowerCase().includes(currentFilters.search) ||
                        st.designation.toLowerCase().includes(currentFilters.search) ||
                        st.nom.toLowerCase().includes(currentFilters.search) ||
                        agentNom.includes(currentFilters.search);
                    
                    const matchStatut = st.statut === statut;
                    const matchPriorite = !currentFilters.priorite || st.priorite === currentFilters.priorite;
                    
                    let matchDate = true;
                    if (currentFilters.dateDebut) {
                        matchDate = matchDate && new Date(st.dateDebut) >= new Date(currentFilters.dateDebut);
                    }
                    if (currentFilters.dateFin) {
                        matchDate = matchDate && new Date(st.dateFin) <= new Date(currentFilters.dateFin);
                    }
                    
                    return matchSearch && matchStatut && matchPriorite && matchDate;
                });

                count.textContent = tachesFiltrees.length;

                if (tachesFiltrees.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucune t√¢che</div>';
                    return;
                }

                let html = '';
                tachesFiltrees.forEach(st => {
                    const agent = agents.find(a => a.id === st.agentId);
                    const realise = calculerRealise(st.id);
                    const avancement = calculerAvancement(realise, st.budgetHeures);
                    const labels = calculerEtiquettesVisuelles(st);

                    const prioriteColors = {
                        'urgente': '#dc3545',
                        'haute': '#fd7e14',
                        'normale': '#ffc107',
                        'basse': '#28a745'
                    };

                    const labelsHTML = labels.length > 0 ? 
                        '<div class="visual-labels">' + labels.map(l => 
                            `<span class="label-badge label-${l.type}">${l.text}</span>`
                        ).join('') + '</div>' : '';

                    html += `
                    <div class="kanban-card" draggable="true" data-id="${st.id}" 
                         ondragstart="handleDragStart(event)" ondragend="handleDragEnd(event)">
                        <div class="kanban-card-header">
                            <span class="kanban-card-number">${st.numAffaire}</span>
                            <span class="kanban-card-priority" style="background: ${prioriteColors[st.priorite]}; color: white;">
                                ${st.priorite.toUpperCase()}
                            </span>
                        </div>
                        <div class="kanban-card-title">${st.nom}</div>
                        <div class="kanban-card-client">üë§ ${st.client}</div>
                        <div class="kanban-card-agent">üë∑ ${agent ? agent.nom : 'Non assign√©'}</div>
                        ${labelsHTML}
                        <div class="kanban-card-progress">
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: ${avancement}%"></div>
                                <div class="progress-text">${avancement}%</div>
                            </div>
                        </div>
                        <div class="kanban-card-footer">
                            <span>üìÖ ${new Date(st.dateFin).toLocaleDateString('fr-FR')}</span>
                            <div class="kanban-card-actions">
                                <button class="kanban-card-btn" onclick="editerAffaire(${st.id})">‚úèÔ∏è</button>
                                <button class="kanban-card-btn" onclick="supprimerSousTache(${st.id})">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>`;
                });

                container.innerHTML = html;
            });

            // Activer le drag & drop
            initKanbanDragDrop();
        }

        function initKanbanDragDrop() {
            const columns = document.querySelectorAll('.kanban-cards');
            
            columns.forEach(column => {
                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('drop', handleDrop);
                column.addEventListener('dragleave', handleDragLeave);
            });
        }

        let draggedElement = null;

        function handleDragStart(event) {
            draggedElement = event.target;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', event.target.innerHTML);
        }

        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
        }

        function handleDragOver(event) {
            if (event.preventDefault) {
                event.preventDefault();
            }
            event.dataTransfer.dropEffect = 'move';
            event.currentTarget.classList.add('drag-over');
            return false;
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(event) {
            if (event.stopPropagation) {
                event.stopPropagation();
            }
            event.currentTarget.classList.remove('drag-over');

            if (draggedElement) {
                const taskId = parseInt(draggedElement.getAttribute('data-id'));
                const newStatus = event.currentTarget.parentElement.getAttribute('data-status');
                
                // Mettre √† jour le statut de la t√¢che
                const task = sousTaches.find(st => st.id === taskId);
                if (task) {
                    task.statut = newStatus;
                    sauvegarderDonnees();
                    afficherKanbanFiltered();
                    afficherNotification(`T√¢che d√©plac√©e vers "${newStatus}"`, 'success');
                }
            }

            return false;
        }

        // ============================================
        // VUES SAUVEGARD√âES
        // ============================================
        function saveCurrentView() {
            const viewName = prompt('Nom de la vue :');
            if (!viewName) return;

            const savedViews = JSON.parse(localStorage.getItem('savedViews') || '[]');
            const view = {
                name: viewName,
                filters: { ...currentFilters },
                date: new Date().toISOString()
            };

            savedViews.push(view);
            localStorage.setItem('savedViews', JSON.stringify(savedViews));
            loadSavedViews();
            afficherNotification(`Vue "${viewName}" sauvegard√©e`, 'success');
        }

        function loadSavedViews() {
            const savedViews = JSON.parse(localStorage.getItem('savedViews') || '[]');
            const container = document.getElementById('savedViewsContainer');

            if (savedViews.length === 0) {
                container.innerHTML = '';
                return;
            }

            let html = savedViews.map((view, index) => `
                <div class="saved-view-chip" onclick="applySavedView(${index})">
                    ${view.name}
                    <span class="remove" onclick="event.stopPropagation(); deleteSavedView(${index})">‚úï</span>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function applySavedView(index) {
            const savedViews = JSON.parse(localStorage.getItem('savedViews') || '[]');
            const view = savedViews[index];

            if (view) {
                currentFilters = { ...view.filters };
                document.getElementById('globalSearchInput').value = currentFilters.search;
                document.getElementById('filterStatut').value = currentFilters.statut;
                document.getElementById('filterPriorite').value = currentFilters.priorite;
                document.getElementById('filterDateDebut').value = currentFilters.dateDebut;
                document.getElementById('filterDateFin').value = currentFilters.dateFin;

                applyGlobalFilters();
                afficherNotification(`Vue "${view.name}" appliqu√©e`, 'success');
            }
        }

        function deleteSavedView(index) {
            const savedViews = JSON.parse(localStorage.getItem('savedViews') || '[]');
            savedViews.splice(index, 1);
            localStorage.setItem('savedViews', JSON.stringify(savedViews));
            loadSavedViews();
            afficherNotification('Vue supprim√©e', 'info');
        }

        // ============================================
        // GESTION DES D√âPENDANCES
        // ============================================
        function ouvrirModalDependances() {
            document.getElementById('modalDependances').classList.add('active');
            
            // Peupler les selects
            const sourceSelect = document.getElementById('depSource');
            const cibleSelect = document.getElementById('depCible');
            
            sourceSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
            cibleSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
            
            sousTaches.forEach(st => {
                sourceSelect.innerHTML += `<option value="${st.id}">${st.numAffaire} - ${st.nom}</option>`;
                cibleSelect.innerHTML += `<option value="${st.id}">${st.numAffaire} - ${st.nom}</option>`;
            });
            
            afficherListeDependances();
        }

        function fermerModalDependances() {
            document.getElementById('modalDependances').classList.remove('active');
        }

        function ajouterDependance() {
            const sourceId = parseInt(document.getElementById('depSource').value);
            const cibleId = parseInt(document.getElementById('depCible').value);
            const type = document.getElementById('depType').value;

            if (!sourceId || !cibleId) {
                afficherNotification('‚ùå Veuillez s√©lectionner les deux t√¢ches', 'error');
                return;
            }

            if (sourceId === cibleId) {
                afficherNotification('‚ùå Une t√¢che ne peut pas d√©pendre d\'elle-m√™me', 'error');
                return;
            }

            // V√©rifier si la d√©pendance existe d√©j√†
            const existe = dependances.find(d => d.sourceId === sourceId && d.cibleId === cibleId);
            if (existe) {
                afficherNotification('‚ùå Cette d√©pendance existe d√©j√†', 'error');
                return;
            }

            // V√©rifier les d√©pendances circulaires
            if (verifierDependanceCirculaire(sourceId, cibleId)) {
                afficherNotification('‚ùå D√©pendance circulaire d√©tect√©e !', 'error');
                return;
            }

            dependances.push({ sourceId, cibleId, type });
            sauvegarderDonnees();
            afficherListeDependances();
            afficherNotification(`‚úÖ D√©pendance ${type} ajout√©e`, 'success');
        }

        function verifierDependanceCirculaire(sourceId, cibleId) {
            // Parcours en profondeur pour d√©tecter les cycles
            const visite = new Set();
            
            function dfs(nodeId) {
                if (visite.has(nodeId)) return true;
                if (nodeId === sourceId) return true;
                
                visite.add(nodeId);
                
                const deps = dependances.filter(d => d.sourceId === nodeId);
                for (const dep of deps) {
                    if (dfs(dep.cibleId)) return true;
                }
                
                visite.delete(nodeId);
                return false;
            }
            
            return dfs(cibleId);
        }

        function afficherListeDependances() {
            const container = document.getElementById('listeDependances');
            
            if (dependances.length === 0) {
                container.innerHTML = '<div class="empty-state">Aucune d√©pendance d√©finie</div>';
                return;
            }

            let html = '<table class="table"><thead><tr>';
            html += '<th>T√¢che source</th><th>Type</th><th>T√¢che cible</th><th>Action</th>';
            html += '</tr></thead><tbody>';

            dependances.forEach((dep, index) => {
                const source = sousTaches.find(st => st.id === dep.sourceId);
                const cible = sousTaches.find(st => st.id === dep.cibleId);
                
                const typeLabels = {
                    'FS': 'Fin ‚Üí D√©but',
                    'SS': 'D√©but ‚Üí D√©but',
                    'FF': 'Fin ‚Üí Fin',
                    'SF': 'D√©but ‚Üí Fin'
                };

                html += `<tr>
                    <td>${source ? source.numAffaire + ' - ' + source.nom : 'Inconnue'}</td>
                    <td><strong>${typeLabels[dep.type]}</strong></td>
                    <td>${cible ? cible.numAffaire + ' - ' + cible.nom : 'Inconnue'}</td>
                    <td>
                        <button class="btn btn-danger btn-small" onclick="supprimerDependance(${index})">üóëÔ∏è</button>
                    </td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function supprimerDependance(index) {
            if (confirm('Supprimer cette d√©pendance ?')) {
                dependances.splice(index, 1);
                sauvegarderDonnees();
                afficherListeDependances();
                afficherNotification('D√©pendance supprim√©e', 'info');
            }
        }

        function recalculerDates() {
            if (!confirm('Recalculer automatiquement les dates selon les d√©pendances ?\n\nCeci modifiera les dates de d√©but/fin des t√¢ches.')) {
                return;
            }

            // Tri topologique pour ordonner les t√¢ches
            const ordreExecution = triTopologique();
            
            if (!ordreExecution) {
                afficherNotification('‚ùå Impossible de calculer : d√©pendances circulaires', 'error');
                return;
            }

            // Recalcul des dates selon l'ordre
            ordreExecution.forEach(taskId => {
                const task = sousTaches.find(st => st.id === taskId);
                if (!task) return;

                // Trouver toutes les d√©pendances entrantes
                const depsEntrantes = dependances.filter(d => d.cibleId === taskId);
                
                if (depsEntrantes.length === 0) return; // T√¢che sans pr√©d√©cesseur

                let nouvelleDateDebut = new Date(task.dateDebut);

                depsEntrantes.forEach(dep => {
                    const source = sousTaches.find(st => st.id === dep.sourceId);
                    if (!source) return;

                    const sourceDebut = new Date(source.dateDebut);
                    const sourceFin = new Date(source.dateFin);

                    if (dep.type === 'FS') {
                        // Fin de source ‚Üí D√©but de cible
                        const candidat = new Date(sourceFin);
                        candidat.setDate(candidat.getDate() + 1);
                        if (candidat > nouvelleDateDebut) nouvelleDateDebut = candidat;
                    } else if (dep.type === 'SS') {
                        // D√©but de source ‚Üí D√©but de cible
                        if (sourceDebut > nouvelleDateDebut) nouvelleDateDebut = new Date(sourceDebut);
                    } else if (dep.type === 'FF') {
                        // Fin de source ‚Üí Fin de cible (recalcul invers√©)
                        const duree = (new Date(task.dateFin) - new Date(task.dateDebut)) / (1000 * 60 * 60 * 24);
                        const candidatFin = new Date(sourceFin);
                        const candidatDebut = new Date(candidatFin);
                        candidatDebut.setDate(candidatDebut.getDate() - duree);
                        if (candidatDebut > nouvelleDateDebut) nouvelleDateDebut = candidatDebut;
                    }
                });

                // Mettre √† jour les dates en conservant la dur√©e
                const duree = (new Date(task.dateFin) - new Date(task.dateDebut)) / (1000 * 60 * 60 * 24);
                task.dateDebut = nouvelleDateDebut.toISOString().split('T')[0];
                const nouvelleDateFin = new Date(nouvelleDateDebut);
                nouvelleDateFin.setDate(nouvelleDateFin.getDate() + duree);
                task.dateFin = nouvelleDateFin.toISOString().split('T')[0];
            });

            sauvegarderDonnees();
            afficherGantt();
            afficherAffaires();
            afficherNotification('‚úÖ Dates recalcul√©es selon les d√©pendances', 'success');
        }

        function triTopologique() {
            const visited = new Set();
            const tempMark = new Set();
            const result = [];

            function visit(nodeId) {
                if (tempMark.has(nodeId)) return false; // Cycle d√©tect√©
                if (visited.has(nodeId)) return true;

                tempMark.add(nodeId);

                const deps = dependances.filter(d => d.cibleId === nodeId);
                for (const dep of deps) {
                    if (!visit(dep.sourceId)) return false;
                }

                tempMark.delete(nodeId);
                visited.add(nodeId);
                result.push(nodeId);
                return true;
            }

            for (const task of sousTaches) {
                if (!visited.has(task.id)) {
                    if (!visit(task.id)) return null; // Cycle d√©tect√©
                }
            }

            return result;
        }

        function calculerCheminCritique() {
            // Simplification : chemin le plus long (critical path method)
            const taches = [...sousTaches];
            const cheminCritique = new Set();

            // Calculer le chemin le plus long en jours
            function calculerDuree(taskId) {
                const task = taches.find(t => t.id === taskId);
                if (!task) return 0;

                const debut = new Date(task.dateDebut);
                const fin = new Date(task.dateFin);
                return Math.ceil((fin - debut) / (1000 * 60 * 60 * 24));
            }

            function calculerCheminMax(taskId, visited = new Set()) {
                if (visited.has(taskId)) return 0;
                visited.add(taskId);

                const deps = dependances.filter(d => d.sourceId === taskId);
                if (deps.length === 0) {
                    return calculerDuree(taskId);
                }

                let maxChemin = 0;
                for (const dep of deps) {
                    const chemin = calculerCheminMax(dep.cibleId, new Set(visited));
                    if (chemin > maxChemin) maxChemin = chemin;
                }

                return calculerDuree(taskId) + maxChemin;
            }

            // Identifier les t√¢ches sur le chemin critique
            taches.forEach(task => {
                const dureeMax = calculerCheminMax(task.id);
                const dureeTotale = calculerDuree(task.id);
                
                // Heuristique simplifi√©e : t√¢ches avec marge nulle
                if (dureeMax === dureeTotale) {
                    cheminCritique.add(task.id);
                }
            });

            return cheminCritique;
        }

        // ============================================
        // GESTION BASELINE
        // ============================================
        function ouvrirModalBaseline() {
            document.getElementById('modalBaseline').classList.add('active');
            afficherInfoBaseline();
            afficherCourbeS();
        }

        function fermerModalBaseline() {
            document.getElementById('modalBaseline').classList.remove('active');
        }

        function creerBaseline() {
            if (baseline && !confirm('Une baseline existe d√©j√†. La remplacer ?')) {
                return;
            }

            baseline = {
                date: new Date().toISOString(),
                taches: sousTaches.map(st => ({
                    id: st.id,
                    dateDebut: st.dateDebut,
                    dateFin: st.dateFin,
                    budgetHeures: st.budgetHeures
                }))
            };

            sauvegarderDonnees();
            afficherInfoBaseline();
            afficherNotification('üì∏ Baseline cr√©√©e avec succ√®s', 'success');
        }

        function supprimerBaseline() {
            if (!baseline) {
                afficherNotification('Aucune baseline √† supprimer', 'info');
                return;
            }

            if (confirm('Supprimer la baseline actuelle ?')) {
                baseline = null;
                sauvegarderDonnees();
                afficherInfoBaseline();
                afficherCourbeS();
                afficherNotification('Baseline supprim√©e', 'info');
            }
        }

        function afficherInfoBaseline() {
            const container = document.getElementById('baselineInfo');
            
            if (!baseline) {
                container.innerHTML = '<div class="empty-state">Aucune baseline d√©finie</div>';
                return;
            }

            const dateCreation = new Date(baseline.date);
            const nbTaches = baseline.taches.length;

            container.innerHTML = `
                <div style="padding: 15px; background: #e7f3ff; border-radius: 6px; border-left: 4px solid #007bff;">
                    <p style="margin: 0;"><strong>üìÖ Date de cr√©ation :</strong> ${dateCreation.toLocaleString('fr-FR')}</p>
                    <p style="margin: 5px 0 0 0;"><strong>üìã Nombre de t√¢ches :</strong> ${nbTaches}</p>
                </div>
            `;
        }

        function afficherCourbeS() {
            const container = document.getElementById('courbeS');
            
            if (!baseline) {
                container.innerHTML = '<div class="empty-state">Cr√©ez une baseline pour voir la courbe S</div>';
                return;
            }

            // Calculer les donn√©es pour la courbe S
            const donnees = calculerDonneesCourbeS();
            
            let html = '<div style="position: relative; height: 300px; border: 1px solid #dee2e6; border-radius: 6px; padding: 20px; background: white;">';
            html += '<svg width="100%" height="100%" viewBox="0 0 800 250" style="overflow: visible;">';
            
            // Axes
            html += '<line x1="50" y1="10" x2="50" y2="230" stroke="#333" stroke-width="2"/>';
            html += '<line x1="50" y1="230" x2="750" y2="230" stroke="#333" stroke-width="2"/>';
            
            // L√©gendes axes
            html += '<text x="400" y="250" text-anchor="middle" font-size="12" fill="#666">Temps</text>';
            html += '<text x="20" y="120" text-anchor="middle" font-size="12" fill="#666" transform="rotate(-90, 20, 120)">Avancement %</text>';
            
            // Tracer les courbes
            if (donnees.planifie.length > 0) {
                const pointsPlanifies = donnees.planifie.map((d, i) => {
                    const x = 50 + (i / (donnees.planifie.length - 1)) * 700;
                    const y = 230 - (d.cumul / 100) * 220;
                    return `${x},${y}`;
                }).join(' ');
                
                html += `<polyline points="${pointsPlanifies}" fill="none" stroke="#667eea" stroke-width="3" stroke-dasharray="5,5"/>`;
            }
            
            if (donnees.realise.length > 0) {
                const pointsRealises = donnees.realise.map((d, i) => {
                    const x = 50 + (i / (donnees.realise.length - 1)) * 700;
                    const y = 230 - (d.cumul / 100) * 220;
                    return `${x},${y}`;
                }).join(' ');
                
                html += `<polyline points="${pointsRealises}" fill="none" stroke="#28a745" stroke-width="3"/>`;
            }
            
            html += '</svg>';
            
            // L√©gende
            html += '<div style="margin-top: 15px; display: flex; gap: 20px; justify-content: center;">';
            html += '<div style="display: flex; align-items: center; gap: 5px;"><div style="width: 30px; height: 3px; background: #667eea; border-top: 3px dashed #667eea;"></div><span style="font-size: 13px;">Planifi√© (Baseline)</span></div>';
            html += '<div style="display: flex; align-items: center; gap: 5px;"><div style="width: 30px; height: 3px; background: #28a745;"></div><span style="font-size: 13px;">R√©alis√©</span></div>';
            html += '</div>';
            
            html += '</div>';
            container.innerHTML = html;
        }

        function calculerDonneesCourbeS() {
            const planifie = [];
            const realise = [];

            if (!baseline) return { planifie, realise };

            // Trouver la plage de dates
            const toutesDatesPlanifiees = baseline.taches.flatMap(t => [new Date(t.dateDebut), new Date(t.dateFin)]);
            const toutesDatesCourantes = sousTaches.flatMap(t => [new Date(t.dateDebut), new Date(t.dateFin)]);
            
            const dateMin = new Date(Math.min(...toutesDatesPlanifiees));
            const dateMax = new Date(Math.max(...toutesDatesCourantes));
            
            const nbJours = Math.ceil((dateMax - dateMin) / (1000 * 60 * 60 * 24));
            const intervalle = Math.max(1, Math.floor(nbJours / 20)); // 20 points max

            // Calculer le cumul planifi√© (baseline)
            for (let i = 0; i <= nbJours; i += intervalle) {
                const date = new Date(dateMin);
                date.setDate(date.getDate() + i);
                
                let heuresPrevues = 0;
                baseline.taches.forEach(t => {
                    const debut = new Date(t.dateDebut);
                    const fin = new Date(t.dateFin);
                    if (date >= debut && date <= fin) {
                        const duree = (fin - debut) / (1000 * 60 * 60 * 24) || 1;
                        const joursPasses = Math.min((date - debut) / (1000 * 60 * 60 * 24), duree);
                        heuresPrevues += (joursPasses / duree) * t.budgetHeures;
                    } else if (date > fin) {
                        heuresPrevues += t.budgetHeures;
                    }
                });
                
                const totalBudget = baseline.taches.reduce((sum, t) => sum + t.budgetHeures, 0);
                planifie.push({ date, cumul: (heuresPrevues / totalBudget) * 100 });
            }

            // Calculer le cumul r√©alis√© (actuel)
            for (let i = 0; i <= nbJours; i += intervalle) {
                const date = new Date(dateMin);
                date.setDate(date.getDate() + i);
                
                let heuresRealisees = 0;
                sousTaches.forEach(st => {
                    const pointagesTache = pointages.filter(p => p.sousTacheId === st.id && new Date(p.date) <= date);
                    heuresRealisees += pointagesTache.reduce((sum, p) => sum + p.heures, 0);
                });
                
                const totalBudget = baseline.taches.reduce((sum, t) => sum + t.budgetHeures, 0);
                realise.push({ date, cumul: (heuresRealisees / totalBudget) * 100 });
            }

            return { planifie, realise };
        }

        // ============================================
        // CONFIGURATION M√âTIER
        // ============================================
        function chargerConfiguration() {
            const config = localStorage.getItem('appConfig');
            if (config) {
                try {
                    CONFIG = { ...CONFIG, ...JSON.parse(config) };
                } catch (e) {
                    console.error('Erreur chargement configuration:', e);
                }
            }

            // Mettre √† jour l'interface
            document.getElementById('configHeuresJour').value = CONFIG.HEURES_JOUR;
            document.getElementById('configHeuresDemi').value = CONFIG.HEURES_DEMI;
            document.getElementById('configAnnee').value = CONFIG.ANNEE_COURANTE;
            document.getElementById('configJoursFeries').value = CONFIG.JOURS_FERIES.join(',');
            document.getElementById('configModeRamadan').checked = CONFIG.MODE_RAMADAN;
            document.getElementById('configHeuresRamadan').value = CONFIG.HEURES_RAMADAN || 6;
            document.getElementById('configRamadanDebut').value = CONFIG.RAMADAN_DEBUT || '';
            document.getElementById('configRamadanFin').value = CONFIG.RAMADAN_FIN || '';

            toggleRamadanConfig();
        }

        function sauvegarderConfiguration() {
            CONFIG.HEURES_JOUR = parseFloat(document.getElementById('configHeuresJour').value) || 8;
            CONFIG.HEURES_DEMI = parseFloat(document.getElementById('configHeuresDemi').value) || 4;
            CONFIG.ANNEE_COURANTE = parseInt(document.getElementById('configAnnee').value) || 2025;
            
            const feriesText = document.getElementById('configJoursFeries').value;
            CONFIG.JOURS_FERIES = feriesText ? feriesText.split(',').map(d => d.trim()).filter(d => d) : [];
            
            CONFIG.MODE_RAMADAN = document.getElementById('configModeRamadan').checked;
            CONFIG.HEURES_RAMADAN = parseFloat(document.getElementById('configHeuresRamadan').value) || 6;
            CONFIG.RAMADAN_DEBUT = document.getElementById('configRamadanDebut').value || null;
            CONFIG.RAMADAN_FIN = document.getElementById('configRamadanFin').value || null;

            localStorage.setItem('appConfig', JSON.stringify(CONFIG));
            afficherNotification('‚úÖ Configuration sauvegard√©e', 'success');
        }

        function toggleRamadanConfig() {
            const isRamadan = document.getElementById('configModeRamadan').checked;
            document.getElementById('ramadanConfig').style.display = isRamadan ? 'block' : 'none';
        }

        // √âcouter le changement de la checkbox Ramadan
        document.addEventListener('DOMContentLoaded', function() {
            const checkbox = document.getElementById('configModeRamadan');
            if (checkbox) {
                checkbox.addEventListener('change', toggleRamadanConfig);
            }
            
            // Initialiser l'ann√©e dans le formulaire
            const anneeAffaire = document.getElementById('anneeAffaire');
            if (anneeAffaire) {
                anneeAffaire.value = new Date().getFullYear();
            }
            
            // Peupler le s√©lecteur d'agents pour le formulaire d'affaire
            const selectAgentAssigne = document.getElementById('agentAssigne');
            if (selectAgentAssigne && agents) {
                selectAgentAssigne.innerHTML = '<option value="">Choisir un agent...</option>';
                agents.forEach(agent => {
                    const option = document.createElement('option');
                    option.value = agent.id;
                    option.textContent = agent.nom;
                    selectAgentAssigne.appendChild(option);
                });
            }
            
            // Peupler les s√©lecteurs d'agents pour les sous-t√¢ches
            const selectResponsable = document.getElementById('responsableSousTache');
            if (selectResponsable && agents) {
                selectResponsable.innerHTML = '<option value="">Choisir un agent...</option>';
                agents.forEach(agent => {
                    const option = document.createElement('option');
                    option.value = agent.id;
                    option.textContent = agent.nom;
                    selectResponsable.appendChild(option);
                });
            }
            
            // Peupler le s√©lecteur d'affaires
            peuplerSelecteurAffaires();
        });

        function estJourFerie(date) {
            return CONFIG.JOURS_FERIES.includes(date);
        }

        function estPeriodeRamadan(date) {
            if (!CONFIG.MODE_RAMADAN || !CONFIG.RAMADAN_DEBUT || !CONFIG.RAMADAN_FIN) {
                return false;
            }
            const d = new Date(date);
            const debut = new Date(CONFIG.RAMADAN_DEBUT);
            const fin = new Date(CONFIG.RAMADAN_FIN);
            return d >= debut && d <= fin;
        }

        function getHeuresTravail(date, type) {
            // Si p√©riode Ramadan, utiliser les heures sp√©ciales
            const isRamadan = estPeriodeRamadan(date);

            if (type === 'absent') {
                return CONFIG.HEURES_ABSENT;
            } else if (type === 'demi') {
                return isRamadan ? CONFIG.HEURES_RAMADAN / 2 : CONFIG.HEURES_DEMI;
            } else if (type === 'jour') {
                return isRamadan ? CONFIG.HEURES_RAMADAN : CONFIG.HEURES_JOUR;
            }
            
            return 0;
        }

        // ============================================
        // FERMETURE DES MODALS
        // ============================================
        // Fermer le modal en cliquant √† l'ext√©rieur
        window.onclick = function(event) {
            const modalAgenda = document.getElementById('modalAgenda');
            const modalAgent = document.getElementById('modalAgent');
            
            if (event.target === modalAgenda) {
                closeAgenda();
            }
            if (event.target === modalAgent) {
                fermerModalAgent();
            }
        }
    </script>

    <!-- Navigation Mobile (Bottom Bar) -->
    <nav class="mobile-bottom-nav" role="navigation" aria-label="Navigation principale mobile">
        <div class="mobile-nav-items">
            <button class="mobile-nav-item active" onclick="switchTab('affaires')" aria-label="Affaires">
                <span class="icon">üè¢</span>
                <span>Affaires</span>
            </button>
            <button class="mobile-nav-item" onclick="switchTab('journalier')" aria-label="Pointage journalier">
                <span class="icon">üìÖ</span>
                <span>Pointage</span>
            </button>
            <button class="mobile-nav-item" onclick="switchTab('planning')" aria-label="Planning">
                <span class="icon">üìÜ</span>
                <span>Planning</span>
            </button>
            <button class="mobile-nav-item" onclick="switchTab('suivi')" aria-label="Suivi budget">
                <span class="icon">üìà</span>
                <span>Suivi</span>
            </button>
            <button class="mobile-nav-item" onclick="switchTab('parametres')" aria-label="Param√®tres">
                <span class="icon">‚öôÔ∏è</span>
                <span>Plus</span>
            </button>
        </div>
    </nav>
    </div> <!-- Fin de appContent -->

</body>
</html>
